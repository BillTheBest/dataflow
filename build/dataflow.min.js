/*! dataflow.js - v0.0.1 - 2012-10-24
* https://github.com/meemoo/dataflow
* Copyright (c) 2012 Forrest Oliphant; Licensed MIT, GPL */
(function(){var a=Backbone.Model.extend({modules:{},module:function(a){return this.modules[a]?this.modules[a]:this.modules[a]={Views:{}}},nodes:{},node:function(a){return this.nodes[a]?this.nodes[a]:this.nodes[a]={}},loadGraph:function(a){this.graph&&this.graph.remove();var b=this.module("graph"),c=new b.Model(a);return c.view=new b.Views.Main({model:c}),$("#app").html(c.view.render().el),this.graph=c,c},debug:!1,log:function(a){this.trigger("log",a,arguments),this.debug&&console.log("Dataflow: ",arguments)}});window.Dataflow=new a})(),jQuery(function(a){var b=Backbone.Router.extend({routes:{"":"index"},index:function(){}});Dataflow.router=new b,Backbone.history.start()}),function(a){var b=Dataflow.module("node"),c=Dataflow.module("edge");a.Model=Backbone.Model.extend({initialize:function(){var a,d=this.nodes=new b.Collection;d.parentGraph=this,d.on("all",function(){this.trigger("change")},this),d.on("add",function(a){Dataflow.trigger("node:add",this,a)},this),d.on("remove",function(a){a.remove(),Dataflow.trigger("node:remove",this,a)},this);var e=this.get("nodes");for(a=0;a<e.length;a++){var f=e[a];f.parentGraph=this,f.type&&Dataflow.nodes[f.type]?(f=new Dataflow.nodes[f.type].Model(f),d.add(f)):Dataflow.log("node "+f.id+" not added: node type ("+f.type+") not found",f)}var g=this.edges=new c.Collection;g.parentGraph=this,g.on("all",function(){this.trigger("change")},this),g.on("add",function(a){Dataflow.trigger("edge:add",this,a)},this),g.on("remove",function(a){Dataflow.trigger("edge:remove",this,a)},this);var h=this.get("edges");for(a=0;a<h.length;a++){var i=h[a];i.parentGraph=this,i.id=i.source.node+":"+i.source.port+"→"+i.target.node+":"+i.target.port;var j=d.get(i.source.node),k=d.get(i.target.node);j&&k&&j.outputs.get(i.source.port)&&k.inputs.get(i.target.port)?(i=new c.Model(i),g.add(i)):Dataflow.log("edge "+i.id+" not added: node or port not found",i)}this.set({nodes:d,edges:g}),this.on("change",function(){Dataflow.trigger("change",this)},this)},remove:function(){while(this.nodes.length>0)this.nodes.remove(this.nodes.at(this.nodes.length-1))}})}(Dataflow.module("graph")),function(a){var b=Dataflow.module("input"),c=Dataflow.module("output");a.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type");var a=this.inputs;this.inputs=new b.Collection,this.inputs.parentNode=this;for(var c=0;c<a.length;c++){var d=a[c];d.parentNode=this,d=new b.Model(d),this.inputs.add(d)}var e=this.outputs;this.outputs=new b.Collection,this.outputs.parentNode=this;for(c=0;c<e.length;c++){var f=e[c];f.parentNode=this,f=new b.Model(f),this.outputs.add(f)}},remove:function(){var a=this.parentGraph.edges.filter(function(a){return a.isConnectedToNode(this)},this);for(var b=0;b<a.length;b++){var c=a[b];c.collection.remove(c)}this.unload()},unload:function(){},toString:function(){return this.id},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y")}},inputs:[],outputs:[]}),a.Collection=Backbone.Collection.extend({model:a.Model,comparator:function(a){return a.get("x")}})}(Dataflow.module("node")),function(a){a.Model=Backbone.Model.extend({defaults:{id:"output",type:"all"},initialize:function(){this.parentNode=this.get("parentNode")}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("input")),function(a){a.Model=Backbone.Model.extend({defaults:{id:"output",type:"all"},initialize:function(){this.parentNode=this.get("parentNode")}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("output")),function(a){a.Model=Backbone.Model.extend({initialize:function(){var a,b=this.get("preview");if(b){a=this.get("parentGraph").nodes;var c=this.get("source"),d=this.get("target");c?this.source=a.get(this.get("source").node).outputs.get(this.get("source").port):d&&(this.target=a.get(this.get("target").node).inputs.get(this.get("target").port))}else{this.parentGraph=this.get("parentGraph"),a=this.parentGraph.nodes;try{this.source=a.get(this.get("source").node).outputs.get(this.get("source").port),this.target=a.get(this.get("target").node).inputs.get(this.get("target").port)}catch(e){Dataflow.log("node or port not found for edge",this)}}},isConnectedToNode:function(a){return this.source.parentNode===a||this.target.parentNode===a},toString:function(){return this.get("source").node+":"+this.get("source").port+"→"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target")}}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("edge")),function(a){var b='<div class="edges"><svg class="svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="nodes" />',c=Dataflow.module("node"),d=Dataflow.module("edge");a.Views.Main=Backbone.View.extend({template:_.template(b),className:"graph",initialize:function(){this.$el.html(this.template(this.model.toJSON()));var a=this.model.get("nodes"),b=this.model.get("edges");this.nodes=a.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=b.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this)},render:function(){var a=this;return _.defer(function(){a.rerenderEdges()},this),this},addNode:function(a){var b=Dataflow.nodes[a.type];if(b&&b.View)a.view=new b.View({model:a});else{var c=Dataflow.node("base");a.view=new c.View({model:a})}this.nodes[a.id]=a.view,a.view.render(),this.$(".nodes").append(a.view.el)},removeNode:function(a){a.view.remove(),this.nodes[a.id]=null,delete this.nodes[a.id]},addEdge:function(a){a.view=new d.Views.Main({model:a}),this.edges[a.id]=a.view,a.view.render(),this.$(".svg-edges")[0].appendChild(a.view.el)},removeEdge:function(a){a.view.remove(),this.edges[a.id]=null,delete this.edges[a.id]},rerenderEdges:function(){_.each(this.edges,function(a){a.render()},this)},sizeSVG:function(){try{var a=this.$(".svg-edges")[0],b=a.getBBox();a.setAttribute("width",Math.round(b.x+b.width+50)),a.setAttribute("height",Math.round(b.y+b.height+50))}catch(c){}}})}(Dataflow.module("graph")),function(a){var b='<h1><%= id %>: <%= label %></h1><div class="controls"><button class="delete">delete</button><button class="done">done</button></div><button class="edit">edit</button><div class="ports ins" /><div class="ports outs" /><div class="inner" />',c=Dataflow.module("input"),d=Dataflow.module("output");a.Views.Main=Backbone.View.extend({template:_.template(b),className:"node",events:{"click .delete":"deleteMe",dragstop:"dragStop","click .edit":"showControls","click .done":"hideControls"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.model.inputs.view=new c.Views.Collection({collection:this.model.inputs}),this.model.inputs.view.render(),this.model.inputs.view.renderAllItems(),this.inputs=this.model.inputs.view,this.model.outputs.view=new d.Views.Collection({collection:this.model.outputs}),this.model.outputs.view.render(),this.model.outputs.view.renderAllItems(),this.outputs=this.model.outputs.view;var a=this;this.$el.draggable({handle:"h1",helper:function(){var b=a.$el,c=b.width(),d=b.height();return $('<div class="node helper" style="width:'+c+"px; height:"+d+'px">')}})},render:function(){return this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$(".ins").html(this.inputs.el),this.$(".outs").html(this.outputs.el),this.$(".controls").hide(),this},dragStop:function(a,b){var c=parseInt(b.position.left,10),d=parseInt(b.position.top,10);this.$el.css({left:c,top:d}),this.model.set({x:c,y:d}),this.model.collection.sort({silent:!0}),this.model.trigger("move",this.model)},showControls:function(){this.$(".edit").hide(),this.$(".controls").show()},hideControls:function(){this.$(".controls").hide(),this.$(".edit").show()},deleteMe:function(){this.model.collection.remove(this.model)}})}(Dataflow.module("node")),function(a){var b=Dataflow.module("edge"),c='<span class="plug in" title="drag to edit wire"></span><span class="hole in" title="drag to make new wire"></span><span class="label in"><%= id %></span>';a.Views.Main=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port in",events:{"dragstart .hole":"newEdgeStart","drag      .hole":"newEdgeDrag","dragstop  .hole":"newEdgeStop","click     .plug":"highlightEdge","dragstart .plug":"changeEdgeStart","drag      .plug":"changeEdgeDrag","dragstop  .plug":"changeEdgeStop",drop:"connectEdge"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug in helper" />')},disabled:!0}),this.$(".hole").draggable({helper:function(){return $('<span class="plug out helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.in, .hole.out",activeClassType:"droppable-hover"})},render:function(){},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdgeNew=new b.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeNewView=new b.Views.Main({model:this.previewEdgeNew});var d=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeNewView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeNewView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},highlightEdge:function(){!this.isConnected},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.model.parentNode.parentGraph.edges.find(function(a){return a.target===this.model},this);if(d){this.changeEdge=d,c.helper.data({port:d.source}),this.previewEdgeChange=new b.Model({source:d.get("source"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new b.Views.Main({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),this.changeEdge&&(b.helper.data("removeChangeEdge")&&this.changeEdge.collection.remove(this.changeEdge),this.changeEdge=null),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;this.model.parentNode.parentGraph.edges.add({id:c.parentNode.id+":"+c.id+"→"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:c.parentNode.id,port:c.id},target:{node:this.model.parentNode.id,port:this.model.id}}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)},holePosition:function(){return this.$(".hole").offset()},isConnected:!1,plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.target===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.Views.Collection=Backbone.CollectionView.extend({tagName:"ul",itemView:a.Views.Main})}(Dataflow.module("input")),function(a){var b=Dataflow.module("edge"),c='<span class="label out"><%= id %></span><span class="hole out" title="drag to make new wire"></span><span class="plug out" title="drag to edit wire"></span>';a.Views.Main=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port out",events:{"dragstart .hole":"newEdgeStart","drag .hole":"newEdgeDrag","dragstop .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag .plug":"changeEdgeDrag","dragstop .plug":"changeEdgeStop",drop:"connectEdge"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug out helper" />')},disabled:!0}),this.$(".hole").draggable({helper:function(){return $('<span class="plug in helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.out, .hole.in",activeClassType:"droppable-hover"})},render:function(){},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdge=new b.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeView=new b.Views.Main({model:this.previewEdge});var d=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.model.parentNode.parentGraph.edges.find(function(a){return a.source===this.model},this);if(d){this.changeEdge=d,c.helper.data({port:d.target}),this.previewEdgeChange=new b.Model({target:d.get("target"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new b.Views.Main({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),this.changeEdge&&(b.helper.data("removeChangeEdge")&&this.changeEdge.collection.remove(this.changeEdge),this.changeEdge=null),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"→"+c.parentNode.id+":"+c.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:c.parentNode.id,port:c.id}}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)},holePosition:function(){return this.$(".hole").offset()},plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.source===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.Views.Collection=Backbone.CollectionView.extend({tagName:"ul",itemView:a.Views.Main})}(Dataflow.module("output")),function(a){var b=function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)d==="xlink:href"?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c};a.Views.Main=Backbone.View.extend({tagName:"div",className:"edge",positions:null,initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("move",this.render,this),this.model.target&&this.model.target.parentNode.on("move",this.render,this),this.model.source&&this.model.source.view.plugSetActive(),this.model.target&&this.model.target.view.plugSetActive(),this.el=b("path",{"class":"path"}),this.$el=$(this.el);var a=this;this.el.addEventListener("click",function(b){a.showEdit(b)})},render:function(a){var b=this.model.source,c=this.model.target;b?this.positions.from=b.view.holePosition():this.positions.from=a,c?this.positions.to=c.view.holePosition():this.positions.to=a,this.el.setAttribute("d",this.edgePath(this.positions)),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},edgePath:function(a){return"M "+a.from.left+" "+a.from.top+" L "+(a.from.left+50)+" "+a.from.top+" L "+(a.to.left-50)+" "+a.to.top+" L "+a.to.left+" "+a.to.top},remove:function(){var a=this.model.source,b=this.model.target;a&&a.parentNode.off("move",this.render,this),b&&b.parentNode.off("move",this.render,this),a&&a.view.plugCheckActive(),b&&b.view.plugCheckActive(),this.$el.remove()},showEdit:function(a){$(".modal-bg").remove();var b=$('<div class="modal-bg" style="width:'+$(document).width()+"px; height:"+$(document).height()+'px;" />').click(function(){$(".modal-bg").remove()}),c=$('<div class="edge-edit-box" style="left:'+a.pageX+"px; top:"+a.pageY+'px;" />');c.append(this.model.id+"<br />");var d=this,e=$("<button>delete</button>").click(function(){d.model.collection.remove(d.model),$(".modal-bg").remove()});c.append(e),b.append(c),this.model.parentGraph.view.$el.append(b)}})}(Dataflow.module("edge")),function(a){var b=a.node("base"),c=a.module("node");b.Model=c.Model.extend({defaults:{label:"",type:"base",x:200,y:100},initialize:function(){c.Model.prototype.initialize.call(this)},unload:function(){},inputs:[],outputs:[]}),b.View=c.Views.Main.extend({})}(Dataflow),function(a){var b=a.node("base-resizable"),c=a.node("base");b.Model=c.Model.extend({defaults:{label:"",type:"base-resizable",x:200,y:100,w:200,h:200},initialize:function(){c.Model.prototype.initialize.call(this)},unload:function(){},toJSON:function(){var a=c.Model.prototype.toJSON.call(this);return a.w=this.get("w"),a.h=this.get("h"),a},inputs:[],outputs:[]}),b.View=c.View.extend({initialize:function(){c.View.prototype.initialize.call(this),this.$el.css({left:this.model.get("w"),top:this.model.get("h")});var a=this;this.$el.resizable({helper:function(){var b=a.$el,c=b.width(),d=b.height();return $('<div class="node helper" style="width:'+c+"px; height:"+d+'px">')},stop:a.resizeStop})},resizeStop:function(a,b){console.log()}})}(Dataflow),function(a){var b=a.node("base-resizable"),c=a.node("test");c.Model=b.Model.extend({inputs:[{id:"input",type:"all"},{id:"input2",type:"all"}],outputs:[{id:"output",type:"all"}]}),c.View=b.View.extend({initialize:function(){b.View.prototype.initialize.call(this),this.$(".inner").text("the node view .inner div can be used for info, ui, etc...")}})}(Dataflow);