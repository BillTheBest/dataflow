/*! dataflow.js - v0.0.7 - 2013-07-26 (3:16:00 AM GMT+0200)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, GPL */
!function(a){var b=function(a,b,c){a[b]||(a[b]=new c),a[b]instanceof c||(a[b]=new c(a[b]))},c=a.Model.extend({defaults:{action:null,label:"",disabled:!1,icon:""}}),d=a.Collection.extend({model:c}),e=a.Model.extend({view:null,context:null,defaults:{control:null,actions:null,overflow:null,className:"actionbar"},initialize:function(a,e){b(this.attributes,"control",c),b(this.attributes,"actions",d),b(this.attributes,"overflow",d),this.context=e},render:function(){return this.view=new g({model:this,context:this.context}),this.view.render().el},show:function(){var b=this.render();a.$("body").prepend(b)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),f=a.Model.extend({view:null,context:null,defaults:{control:null,actions:null,className:"contextbar"},initialize:function(a,e){b(this.attributes,"control",c),b(this.attributes,"actions",d),this.context=e},render:function(){return this.view=new h({model:this,context:this.context}),this.view.render().el},show:function(){var b=this.render();a.$("body").prepend(b)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),g=a.View.extend({tagName:"div",className:"navbar navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-up":"handleUp","click .control-icon":"handleIcon","click .control-label":"handleLabel"},initialize:function(a){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=a.context},handleUp:function(a){a.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("up")&&this.model.get("control").get("up").call(this.context)},handleIcon:function(a){return this.model.get("control").get("up")?(this.handleUp(a),void 0):(this.handleLabel(a),void 0)},handleLabel:function(a){a.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=a.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this.renderOverflow(),this},renderControl:function(){if(this.model.get("control")){this.$control||(this.$control=a.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var b=this.model.get("control").get("icon"),c=this.model.get("control").get("up"),d=this.model.get("control").get("label");this.$control.empty(),c&&this.$control.append(a.$('<i class="control-up icon-chevron-left"></i><span class="control-up">&nbsp;</span>')),b&&this.$control.append(a.$('<i class="control-icon icon-'+b+'"></i>')),d&&this.$control.append('<span class="control-label">&nbsp;'+d+"</span>")}},renderActions:function(){if(!this.$actions){var a=new i({collection:this.model.get("actions"),context:this.context});this.$inner.append(a.render().$el),this.$actions=a.$el}},renderOverflow:function(){}}),h=a.View.extend({tagName:"div",className:"navbar navbar-inverse navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-icon":"handleControl","click .control-label":"handleControl"},handleControl:function(a){a.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},initialize:function(a){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=a.context},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=a.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this},renderControl:function(){this.$control||(this.$control=a.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var b=this.model.get("control").get("icon"),c=this.model.get("control").get("label");this.$control.empty(),b&&this.$control.append(a.$('<i class="control-icon icon-'+b+'"></i>')),c&&this.$control.append('<span class="control-label"> '+c+"</span>")},renderActions:function(){if(!this.$actions){var a=new i({collection:this.model.get("actions"),context:this.context});this.$inner.append(a.render().$el),this.$actions=a.$el}}}),i=a.View.extend({tagName:"ul",className:"nav pull-right",views:{},context:null,initialize:function(a){this.collection=a.collection,this.context=a.context,this.listenTo(this.collection,"add",this.addItem),this.listenTo(this.collection,"remove",this.removeItem),this.listenTo(this.collection,"reset",this.render)},render:function(){return this.$el.empty(),this.collection.each(this.addItem,this),this},addItem:function(a){var b=new j({model:a,context:this.context});this.$el.append(b.render().el),this.views[a.cid]=b},removeItem:function(a){this.views[a.cid]&&(this.views[a.cid].$el.remove(),delete this.views[a.cid])}}),j=a.View.extend({tagName:"li",template:"<a></a>",context:null,events:{click:"handleClick"},initialize:function(a){this.context=a.context,this.listenTo(this.model,"change",this.render)},handleClick:function(a){a.preventDefault(),this.model.get("disabled")||this.model.get("action")&&this.model.get("action").call(this.context)},render:function(){this.$el.html(this.template);var b=a.$("a",this.$el);return b.append(a.$('<i class="icon-'+this.model.get("icon")+'"></i>')),b.append(this.model.get("label")),this.model.get("disabled")?this.$el.addClass("disabled"):this.$el.removeClass("disabled"),this}});window.ActionBar=e,window.ContextBar=f}(Backbone),function(){var a=Backbone.Model.extend({$:function(a){return this.$el.find(a)},initialize:function(){this.el=document.createElement("div"),this.el.className="dataflow",this.$el=$(this.el);var a=$('<div class="dataflow-menu">'),b=this;if($('<button class="dataflow-menu-close icon-remove"></button>').click(function(){b.hideMenu()}).appendTo(a),this.$el.append(a),this.debug=this.get("debug"),this.controls=this.get("controls"),this.controls!==!1&&(this.controls=!0),this.controls){this.prepareActionBar(),this.renderActionBar();for(var c in this.plugins)this.plugins[c].initialize&&this.plugins[c].initialize(this)}this.inputs=this.get("inputs"),this.inputs!==!1&&(this.inputs=!0),this.editable=this.get("editable"),this.editable!==!1&&(this.editable=!0);var d=this.get("appendTo");d=d?d:"body","body"===d&&$("html, body").css({margin:"0px",padding:"0px",width:"100%",height:"100%"}),$(d).append(this.el),this.id||(this.id=$(d).attr("id")),this.loadState()},prepareActionBar:function(){this.actionBar=new ActionBar({},this),this.actionBar.get("control").set({label:"Dataflow",icon:"retweet"}),this.contextBar=new ContextBar({},this),this.contextBar.get("control").set({label:"1 selected",icon:"ok",action:function(){this.currentGraph&&this.currentGraph.view&&this.currentGraph.view.deselect()}})},renderActionBar:function(){this.$el.append(this.actionBar.render()),this.$(".brand").attr({href:"https://github.com/meemoo/dataflow",target:"_blank"}),this.$el.append(this.contextBar.render()),this.contextBar.view.$el.hide()},modules:{},module:function(a){return this.modules[a]?this.modules[a]:(this.modules[a]={},this.modules[a])},nodes:{},node:function(a){return this.nodes[a]?this.nodes[a]:(this.nodes[a]={},this.nodes[a])},plugins:{},plugin:function(a){return this.plugins[a]?this.plugins[a]:(this.plugins[a]={},this.plugins[a])},hideMenu:function(){this.$el.removeClass("menu-shown")},showMenu:function(a){this.$el.addClass("menu-shown"),this.$(".dataflow-menuitem").removeClass("shown"),this.$(".dataflow-menuitem-"+a).addClass("shown")},addPlugin:function(a){if(a.menu){var b=$("<div>").addClass("dataflow-menuitem dataflow-menuitem-"+a.id).append(a.menu);this.$(".dataflow-menu").append(b),this.actionBar.get("actions").add({id:a.id,icon:a.icon,label:a.name,action:function(){this.showMenu(a.id)}})}},showContextBar:function(){this.actionBar.view.$el.hide(),this.contextBar.view.$el.show()},hideContextBar:function(){this.contextBar.view.$el.hide(),this.actionBar.view.$el.show()},contexts:{},addContext:function(a){for(var b=0;b<a.contexts.length;b++){var c=a.contexts[b];this.contexts[c]||(this.contexts[c]=[]),this.contexts[c].push(a)}},changeContext:function(a){return this.contextBar?(a.length>1?(this.contextBar.get("control").set({label:a.length+" selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.twoplus),this.showContextBar()):1===a.length?(this.contextBar.get("control").set({label:"1 selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.one),this.showContextBar()):this.hideContextBar(),void 0):!1},loadGraph:function(a){this.graph&&(this.currentGraph.view&&this.currentGraph.view.remove(),this.graph.view&&this.graph.view.remove(),this.graph.remove());var b=this.module("graph");a.dataflow=this;var c=new b.Model(a);return c.view=new b.View({model:c}),this.$el.append(c.view.render().el),this.graph=this.currentGraph=c,c},showGraph:function(a){this.currentGraph.view.$el.detach(),this.$el.append(a.view.el),a.view.render(),this.currentGraph=a},debug:!1,log:function(a){this.trigger("log",a,arguments),this.debug&&console.log("Dataflow: ",arguments)},types:["all","canvas:2d","canvas:webgl","string","number","int","object","array"]});window.Dataflow=a,"object"==typeof exports&&(exports.Dataflow=a),Backbone.View.prototype.addEvents=function(a){this.delegateEvents(_.extend(_.clone(this.events),a))},Backbone.CollectionView=Backbone.Model.extend({initialize:function(a){this.el=document.createElement(this.tagName),this.$el=$(this.el),this.parent=a.parent;var b=this.get("collection");b.each(this.addItem,this),b.on("add",this.addItem,this),b.on("remove",this.removeItem,this)},addItem:function(a){a.view=new this.itemView({model:a,parent:this.parent}),this.$el.append(a.view.render().el)},removeItem:function(a){a.view.remove()}})}(),function(a){var b=Backbone.Model.extend({});a.prototype.loadState=function(){var a="dataflow-"+(this.id?this.id:this.cid),c=JSON.parse(window.localStorage.getItem(a));c||(c={});var d=new b(c);this.set("state",d),d.on("change",function(b){window.localStorage.setItem(a,JSON.stringify(b.toJSON()))})}}(Dataflow),function(a){var b=a.prototype.module("graph"),c=a.prototype.module("node"),d=a.prototype.module("edge");b.Model=Backbone.Model.extend({defaults:{nodes:[],edges:[]},initialize:function(){this.dataflow=this.get("dataflow");var a,b=this.nodes=new c.Collection;b.parentGraph=this,b.on("all",function(){this.trigger("change")},this),b.on("add",function(a){this.dataflow.trigger("node:add",this,a)},this),b.on("remove",function(a){a.remove(),this.dataflow.trigger("node:remove",this,a)},this);var e=this.get("nodes");for(a=0;a<e.length;a++){var f=e[a];f.parentGraph=this,f.type&&this.dataflow.nodes[f.type]?(f=new this.dataflow.nodes[f.type].Model(f),b.add(f)):this.dataflow.log("node "+f.id+" not added: node type ("+f.type+") not found",f)}var g=this.edges=new d.Collection;g.parentGraph=this,g.on("all",function(){this.trigger("change")},this),g.on("add",function(a){this.dataflow.trigger("edge:add",this,a)},this),g.on("remove",function(a){this.dataflow.trigger("edge:remove",this,a)},this);var h=this.get("edges");for(a=0;a<h.length;a++){var i=h[a];i.parentGraph=this,i.id=i.source.node+":"+i.source.port+"::"+i.target.node+":"+i.target.port;var j=b.get(i.source.node),k=b.get(i.target.node);j&&k&&j.outputs.get(i.source.port)&&k.inputs.get(i.target.port)?(i=new d.Model(i),g.add(i)):this.dataflow.log("edge "+i.id+" not added: node or port not found",i)}this.set({nodes:b,edges:g}),this.on("selectionChanged",this.selectionChanged,this),this.on("select:node",this.selectNode,this),this.on("select:edge",this.selectEdge,this),this.on("change",function(){this.dataflow.trigger("change",this)},this)},selectNode:function(a){this.dataflow.trigger("select:node",this,a)},selectEdge:function(a){this.dataflow.trigger("select:edge",this,a)},selectionChanged:function(){this.selected=[],this.view&&(this.nodes.each(function(a){a.view&&a.view.$el.hasClass("ui-selected")&&this.selected.push(a)},this),this.dataflow.changeContext(this.selected))},remove:function(){for(;this.nodes.length>0;)this.nodes.remove(this.nodes.at(this.nodes.length-1))},toJSON:function(){return{nodes:this.nodes,edges:this.edges}}})}(Dataflow),function(a){var b=a.prototype.module("node"),c=a.prototype.module("input"),d=a.prototype.module("output");b.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100,state:{}},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type"),""===this.get("label")&&this.set({label:this.get("type")});var a=this.inputs;this.inputs=new c.Collection,this.inputs.parentNode=this;for(var b=0;b<a.length;b++){var e=a[b],f=this.get("state");void 0!==e.value&&void 0===f[e.id]&&(f[e.id]=e.value),e.parentNode=this,e=new c.Model(e),this.inputs.add(e)}var g=this.outputs;for(this.outputs=new d.Collection,this.outputs.parentNode=this,b=0;b<g.length;b++){var h=g[b];h.parentNode=this,h=new d.Model(h),this.outputs.add(h)}this.on("select",this.select,this)},select:function(){this.parentGraph.trigger("select:node",this)},setState:function(a,b){var c=this.get("state");c[a]!==b&&(c[a]=b,this["input"+a]&&this["input"+a](b),this.trigger("change:state",a,b))},setBang:function(a){this["input"+a]&&this["input"+a]()},send:function(a,b){var c=this;_.defer(function(){c.trigger("send:"+a,b)})},recieve:function(a,b){"function"==typeof this["input"+a]?this["input"+a](b):this["_"+a]=b},remove:function(){this.inputs.each(function(a){a.remove()}),this.outputs.each(function(a){a.remove()}),this.unload(),this.collection.remove(this)},unload:function(){},toString:function(){return this.id+" ("+this.type+")"},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y"),state:this.get("state")}},inputs:[],outputs:[]}),b.Collection=Backbone.Collection.extend({model:b.Model,comparator:function(a){return a.get("x")}})}(Dataflow),function(a){var b=a.prototype.module("input");b.Model=Backbone.Model.extend({defaults:{id:"input",label:"",type:"all",description:""},initialize:function(){this.parentNode=this.get("parentNode"),""===this.get("label")&&this.set({label:this.id}),this.connected=[]},connect:function(a){this.connected.push(a),this.connected=_.uniq(this.connected)},disconnect:function(a){this.connected=_.without(this.connected,a)},remove:function(){for(;this.connected.length>0;)this.connected[0].remove()}}),b.Collection=Backbone.Collection.extend({model:b.Model})}(Dataflow),function(a){var b=a.prototype.module("input"),c=a.prototype.module("output");c.Model=b.Model.extend({defaults:{id:"output",label:"",type:"all",description:""}}),c.Collection=Backbone.Collection.extend({model:c.Model})}(Dataflow),function(a){var b=a.prototype.module("edge");b.Model=Backbone.Model.extend({defaults:{z:0,route:0},initialize:function(){var a,b,c,d=this.get("preview");if(this.parentGraph=this.get("parentGraph"),d){a=this.get("parentGraph").nodes;var e=this.get("source"),f=this.get("target");e?(b=a.get(this.get("source").node),this.source=b.outputs.get(this.get("source").port)):f&&(c=a.get(this.get("target").node),this.target=c.inputs.get(this.get("target").port))}else{a=this.parentGraph.nodes;try{b=a.get(this.get("source").node),this.source=b.outputs.get(this.get("source").port),c=a.get(this.get("target").node),this.target=c.inputs.get(this.get("target").port)}catch(g){}this.source.connect(this),this.target.connect(this),b.on("send:"+this.source.id,this.send,this),this.bringToTop(),this.on("select",this.select,this)}},select:function(){this.parentGraph.trigger("select:edge",this)},send:function(a){this.target.parentNode.recieve(this.target.id,a)},isConnectedToPort:function(a){return this.source===a||this.target===a},isConnectedToNode:function(a){return this.source.parentNode===a||this.target.parentNode===a},toString:function(){return this.get("source").node+":"+this.get("source").port+"::"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target"),route:this.get("route")}},bringToTop:function(){var a=0;this.parentGraph.edges.each(function(b){if(b!==this){var c=b.get("z");c>a&&(a=c),b.view&&b.view.unhighlight()}},this),this.set("z",a+1),this.collection&&this.collection.sort()},remove:function(){this.source.disconnect(this),this.target.disconnect(this),this.collection&&this.collection.remove(this),this.source.parentNode.off("send:"+this.source.id,this.send,this)}}),b.Collection=Backbone.Collection.extend({model:b.Model,comparator:function(a){return a.get("z")}})}(Dataflow),function(a){var b=a.prototype.module("graph");a.prototype.module("node");var c=a.prototype.module("edge"),d='<div class="dataflow-edges"><svg class="dataflow-svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="dataflow-nodes" /><div class="dataflow-graph-controls"><button class="dataflow-graph-gotoparent"><i class="icon-chevron-left"></i> back to parent</button></div>';b.View=Backbone.View.extend({template:_.template(d),className:"dataflow-graph",events:{click:"deselect","click .dataflow-graph-gotoparent":"gotoParent"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var a=this.model.get("nodes"),b=this.model.get("edges");this.nodes=a.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=b.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this);var c=this.model.get("parentNode");c||this.$(".dataflow-graph-controls").hide(),this.bindInteraction()},gotoParent:function(){var a=this.model.get("parentNode");a&&this.model.dataflow.showGraph(a.parentGraph)},bindInteraction:function(){var a=this.model.dataflow.get("state");this.bindZoom(a),this.bindScroll(a)},bindZoom:function(a){if(window.Hammer){a.has("zoom")||a.set("zoom",1);var b,c=this;Hammer(this.el).on("touch",function(c){b=a.get("zoom"),a.set("centerX",c.gesture.center.pageX),a.set("centerY",c.gesture.center.pageY)}),Hammer(this.el).on("pinch",function(c){var d=Math.max(.5,Math.min(b*c.gesture.scale,3)),e=a.get("centerX"),f=a.get("centerY"),g=e-e/d,h=f-f/d;a.set("zoom",d),a.set("scrollY",h),a.set("scrollX",g)});var d=function(){c.el.style.zoom=a.get("zoom"),c.el.scrollTop=a.get("scrollY"),c.el.scrollLeft=a.get("scrollX")};a.on("change:zoom",d),1!==a.get("zoom")&&d()}},bindScroll:function(a){this.el.addEventListener("scroll",function(){a.set("scrollY",this.scrollTop),a.set("scrollX",this.scrollLeft)})},render:function(){var a=this;return _.defer(function(){a.rerenderEdges()},this),this},addNode:function(a){var b=this.model.dataflow.nodes[a.type];if(b&&b.View)a.view=new b.View({model:a,graph:this});else{var c=this.model.dataflow.node("base");a.view=new c.View({model:a,graph:this})}this.nodes[a.id]=a.view,a.view.render(),this.$(".dataflow-nodes").append(a.view.el)},removeNode:function(a){a.view.remove(),this.nodes[a.id]=null,delete this.nodes[a.id]},addEdge:function(a){a.view=new c.View({model:a}),this.edges[a.id]=a.view,a.view.render(),this.$(".dataflow-svg-edges")[0].appendChild(a.view.el)},removeEdge:function(a){a.view.remove(),this.edges[a.id]=null,delete this.edges[a.id]},rerenderEdges:function(){_.each(this.edges,function(a){a.render()},this)},sizeSVG:function(){try{var a=this.$(".dataflow-svg-edges")[0],b=a.getBBox();a.setAttribute("width",Math.round(b.x+b.width+50)),a.setAttribute("height",Math.round(b.y+b.height+50))}catch(c){}},deselect:function(){this.$(".dataflow-node").removeClass("ui-selected"),this.model.trigger("selectionChanged"),this.unfade()},fade:function(){this.model.nodes.each(function(a){a.view.fade()}),this.model.edges.each(function(a){a.view.fade()})},unfade:function(){this.model.nodes.each(function(a){a.view.unfade()}),this.model.edges.each(function(a){a.view.unfade()})}})}(Dataflow),function(a){var b=a.prototype.module("node"),c=a.prototype.module("input"),d=a.prototype.module("output"),e='<div class="outer" /><div class="dataflow-node-header"><h1 class="dataflow-node-title"><span class="label"><%- label %></span> <input class="label-edit" value="<%- label %>" type="text" /></h1><button title="properties" class="dataflow-node-inspect icon-cog"></button></div><div class="dataflow-node-ports dataflow-node-ins" /><div class="dataflow-node-ports dataflow-node-outs" /><div class="dataflow-node-inner" />',f='<h1 class="dataflow-node-inspector-title"><%- label %></h1><div class="dataflow-node-inspector-inputs"></div>',g="";b.View=Backbone.View.extend({template:_.template(e),innerTemplate:_.template(g),inspectTemplate:_.template(f),className:"dataflow-node",events:function(){return{"click .dataflow-node-inspect":"showInspector",click:"select",dragstart:"dragStart",drag:"drag",dragstop:"dragStop"}},initialize:function(a){this.$el.html(this.template(this.model.toJSON())),this.graph=a.graph,this.$el.addClass(this.model.type),this.model.parentGraph.dataflow.editable||this.$(".dataflow-node-edit").hide(),this.inputs=this.model.inputs.view=new c.CollectionView({collection:this.model.inputs,parent:this}),this.outputs=this.model.outputs.view=new d.CollectionView({collection:this.model.outputs,parent:this});var b=this;this.$el.draggable({handle:"h1",helper:function(){var a=b.$el,c=a.width(),d=a.height();return $('<div class="dataflow-node helper" style="width:'+c+"px; height:"+d+'px">')}}),this.$el.data("dataflow-node-view",this),this.$(".dataflow-node-inner").append(this.innerTemplate),this.$inner=this.$(".dataflow-node-inner")},render:function(){return this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$(".dataflow-node-ins").html(this.inputs.el),this.$(".dataflow-node-outs").html(this.outputs.el),this.$(".dataflow-node-controls").hide(),this.$(".label-edit").hide(),this},_alsoDrag:[],_dragDelta:{},dragStart:function(a){this.$el.hasClass("ui-selected")||this.select(a);var b=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(b.el!==this){var a=$(this),c={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10)};a.data("ui-draggable-alsodrag-initial",c);var d=$('<div class="node helper">').css({width:a.width(),height:a.height(),left:c.left,top:c.top});a.parent().append(d),a.data("ui-draggable-alsodrag-helper",d),b._alsoDrag.push(a)}})},drag:function(a){if(this._alsoDrag.length){var b=$(a.target).data("ui-draggable"),c=b.originalPosition,d={top:b.position.top-c.top||0,left:b.position.left-c.left||0};_.each(this._alsoDrag,function(a){var b=a.data("ui-draggable-alsodrag-initial"),c=a.data("ui-draggable-alsodrag-helper");c.css({left:b.left+d.left,top:b.top+d.top})})}},dragStop:function(a,b){var c=parseInt(b.position.left,10),d=parseInt(b.position.top,10);this.moveToPosition(c,d),this._alsoDrag.length&&(_.each(this._alsoDrag,function(a){a.data("ui-draggable-alsodrag-initial");var b=a.data("ui-draggable-alsodrag-helper"),c=a.data("dataflow-node-view");c.moveToPosition(parseInt(b.css("left"),10),parseInt(b.css("top"),10)),b.remove(),a.data("ui-draggable-alsodrag-initial",null),a.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[])},moveToPosition:function(a,b){a=Math.max(a,0),b=Math.max(b,0),this.$el.css({left:a,top:b}),this.model.set({x:a,y:b})},showInspector:function(){this.model.parentGraph.dataflow.showMenu("inspector");var a=this.model.parentGraph.dataflow.$(".dataflow-plugin-inspector");a.children().detach(),a.append(this.getInputList()),this.highlightEdges()},highlightEdges:function(){},hideControls:function(){},saveLabel:function(){var a=this.$(".title .label-edit").val();this.model.get("label")!==a&&(this.model.set("label",a),this.$(".title .label").text(a)),this.hideControls()},removeModel:function(){this.model.remove()},bringToTop:function(){var a=0;this.model.collection.each(function(b){var c=parseInt(b.view.el.style.zIndex,10);c>a&&(a=c)},this),this.el.style.zIndex=a+1},select:function(a){a?(a.stopPropagation(),a.ctrlKey||a.metaKey?this.$el.toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$el.addClass("ui-selected")),this.bringToTop()):(this.$el.addClass("ui-selected"),this.bringToTop()),this.$el.hasClass("ui-selected")&&(this.model.trigger("select"),this.model.parentGraph.view.fade(),this.unfade()),this.model.parentGraph.trigger("selectionChanged")},fade:function(){this.$el.addClass("fade")},unfade:function(){this.$el.removeClass("fade");var a=this;this.model.parentGraph.edges.each(function(b){(b.source.parentNode.id===a.model.id||b.target.parentNode.id===a.model.id)&&b.view.unfade()})},$inputList:null,getInputList:function(){if(!this.$inputList){this.$inputList=$("<div>");var a=this.model.toJSON();this.$inputList.html(this.inspectTemplate(a)),a.id!==a.label&&this.$inputList.children(".dataflow-node-inspector-title").prepend(a.id+": ");var b=this.$inputList.children(".dataflow-node-inspector-inputs");this.model.inputs.each(function(a){a.view&&a.view.$input&&b.append(a.view.$input)},this)}return this.$inputList}})}(Dataflow),function(a){var b=a.prototype.module("input"),c=a.prototype.module("edge"),d='<span class="dataflow-port-plug in" title="drag to edit wire"></span><span class="dataflow-port-hole in" title="drag to make new wire"></span><label class="dataflow-port-label in" title="<%= description %>"><%= label %></label>';b.View=Backbone.View.extend({template:_.template(d),tagName:"li",className:"dataflow-port dataflow-in",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},$input:null,initialize:function(a){if(this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.model.parentNode.parentGraph.dataflow.editable){var b=this;if(this.parent=a.parent,this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var a=$('<span class="dataflow-port-plug in helper" />');return $(".dataflow-graph").append(a),a},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var a=$('<span class="dataflow-port-plug out helper" />').data({port:b.model});return $(".dataflow-graph").append(a),a}}),this.$el.droppable({accept:".dataflow-port-plug.in, .dataflow-port-hole.out",activeClassType:"droppable-hover",refreshPositions:!0}),this.model.parentNode.parentGraph.dataflow.inputs){var c=this.model.get("type"),d=this.model.parentNode.get("state");if(a=this.model.get("options"),void 0!==a&&(_.isString(a)&&(a=a.split(" "),this.model.set("options",a)),_.isArray(a))){for(var e={},f=0;f<a.length;f++)e[a[f]]=a[f];a=e,this.model.set("options",a)}var g,h=this.renderInput(c,a);d&&void 0!==d[this.model.id]?g=d[this.model.id]:void 0!==this.model.get("value")&&(g=this.model.get("value")),this.setInputValue(h,c,g),this.model.parentNode.on("change:state",function(){var a=this.model.parentNode.get("state");a&&void 0!==a[this.model.id]&&this.setInputValue(h,c,a[this.model.id])}.bind(this));var i=$("<label>").append(h).prepend("<span>"+this.model.get("label")+"</span> ");this.$input=i}}},renderInput:function(a,b){var c;if(b){c=$('<select class="input input-select">');for(var d in b){var e=$('<option value="'+b[d]+'">'+d+"</option>").data("val",b[d]);c.append(e)}return c.change(this.inputSelect.bind(this)),c}switch(a){case"int":case"float":case"number":var f={};return void 0!==this.model.get("min")&&(f.min=this.model.get("min")),void 0!==this.model.get("max")&&(f.max=this.model.get("max")),"int"===a&&(f.step=1),c=$('<input type="number" class="input input-number">').attr(f).addClass("int"===a?"input-int":"input-float"),"int"==a?c.change(this.inputInt.bind(this)):c.change(this.inputFloat.bind(this)),c;case"boolean":return c=$('<input type="checkbox" class="input input-boolean">'),c.change(this.inputBoolean.bind(this)),c;case"bang":return c=$('<button class="input input-bang">!</button>'),c.click(this.inputBang.bind(this)),c;default:return c=$('<input class="input input-string">'),c.change(this.inputString.bind(this)),c}},setInputValue:function(a,b,c){return a?"SELECT"===a[0].tagName?($("option",a).each(function(){var a=$(this).data("val");$(this).prop("selected",a==c)}),void 0):"boolean"===b?(a.prop("checked",c),void 0):(a.val(c),void 0):void 0},inputSelect:function(a){var b=$(a.target).find(":selected").data("val");this.model.parentNode.setState(this.model.id,b)},inputInt:function(a){this.model.parentNode.setState(this.model.id,parseInt($(a.target).val(),10))},inputFloat:function(a){this.model.parentNode.setState(this.model.id,parseFloat($(a.target).val()))},inputString:function(a){this.model.parentNode.setState(this.model.id,$(a.target).val())},inputBoolean:function(a){this.model.parentNode.setState(this.model.id,$(a.target).prop("checked"))},inputBang:function(){this.model.parentNode.setBang(this.model.id)},render:function(){return this},newEdgeStart:function(a,b){a.stopPropagation(),b.helper.data({route:this.topRoute}),this.previewEdgeNew=new c.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeNewView=new c.View({model:this.previewEdgeNew});var d=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];d.appendChild(this.previewEdgeNewView.el)},newEdgeDrag:function(a,b){if(a.stopPropagation(),this.previewEdgeNewView&&b){var c=this.model.parentNode.parentGraph.dataflow.get("state");b.position.top=a.clientY/c.get("zoom"),b.position.left=a.clientX/c.get("zoom");var d=this.model.parentNode.parentGraph.view.el;b.position.left+=d.scrollLeft,b.position.top+=d.scrollTop,this.previewEdgeNewView.render({left:b.position.left-d.scrollLeft,top:b.position.top-d.scrollTop}),this.model.parentNode.parentGraph.view.sizeSVG()}},newEdgeStop:function(a){a.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},getTopEdge:function(){var a;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(b){b.target===this.model&&(a=b),b.view&&b.view.unhighlight()},this),a&&a.view&&a.view.click()),a},changeEdgeStart:function(a,b){if(a.stopPropagation(),this.isConnected){var d=this.getTopEdge();if(d){d.remove(),b&&b.helper.data({port:d.source,route:d.get("route")}),this.previewEdgeChange=new c.Model({source:d.get("source"),route:d.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new c.View({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;if(c.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var e=0;void 0!==b.helper.data("route")&&(e=b.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:c.parentNode.id+":"+c.id+"::"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:c.parentNode.id,port:c.id},target:{node:this.model.parentNode.id,port:this.model.id},route:e}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)
},holePosition:function(){var a=this.$(".dataflow-port-hole").offset();this.parent||(this.parent=this.options.parent);var b=this.parent.graph.$el,c=b.offset();return{left:b.scrollLeft()+a.left-c.left+5,top:b.scrollTop()+a.top-c.top+8}},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(a){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.target===this.model},this);if(!a){try{this.$(".dataflow-port-plug").draggable("disable")}catch(b){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(a){var b=a.get("route");void 0!==b&&(this.$(".dataflow-port-hole").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole").addClass("route"+b),this.topRoute=b)}}),b.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:b.View})}(Dataflow),function(a){var b=a.prototype.module("output"),c=a.prototype.module("edge"),d='<span class="dataflow-port-label out" title="<%= description %>"><%= label %></span><span class="dataflow-port-hole out" title="drag to make new wire"></span><span class="dataflow-port-plug out" title="drag to edit wire"></span>';b.View=Backbone.View.extend({template:_.template(d),tagName:"li",className:"dataflow-port dataflow-out",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},initialize:function(a){if(this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.model.parentNode.parentGraph.dataflow.editable){var b=this;this.parent=a.parent,this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var a=$('<span class="dataflow-port-plug out helper" />');return $(".dataflow-graph").append(a),a},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var a=$('<span class="dataflow-port-plug in helper" />').data({port:b.model});return $(".dataflow-graph").append(a),a}}),this.$el.droppable({accept:".dataflow-port-plug.out, .dataflow-port-hole.in",activeClassType:"droppable-hover"})}},render:function(){return this},newEdgeStart:function(a,b){a.stopPropagation(),b.helper.data({route:this.topRoute}),this.previewEdge=new c.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeView=new c.View({model:this.previewEdge});var d=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];d.appendChild(this.previewEdgeView.el)},newEdgeDrag:function(a,b){if(a.stopPropagation(),this.previewEdgeView&&b){var c=this.model.parentNode.parentGraph.dataflow.get("state");b.position.top=a.clientY/c.get("zoom"),b.position.left=a.clientX/c.get("zoom");var d=this.model.parentNode.parentGraph.view.el;b.position.left+=d.scrollLeft,b.position.top+=d.scrollTop,this.previewEdgeView.render({left:b.position.left-d.scrollLeft,top:b.position.top-d.scrollTop})}},newEdgeStop:function(a){a.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},getTopEdge:function(){var a;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(b){b.source===this.model&&(a=b),b.view&&b.view.unhighlight()},this),a&&a.view&&a.view.click()),a},changeEdgeStart:function(a,b){if(a.stopPropagation(),this.isConnected){var d=this.getTopEdge();if(d){d.remove(),b&&b.helper.data({port:d.target,route:d.get("route")}),this.previewEdgeChange=new c.Model({target:d.get("target"),route:d.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new c.View({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a){a.stopPropagation(),this.previewEdgeChange&&this.previewEdgeChangeView.remove()},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;if(c.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var e=0;void 0!==b.helper.data("route")&&(e=b.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"::"+c.parentNode.id+":"+c.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:c.parentNode.id,port:c.id},route:e}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)},holePosition:function(){var a=this.$(".dataflow-port-hole").offset();this.parent||(this.parent=this.options.parent);var b=this.parent.graph.$el,c=b.offset();return{left:b.scrollLeft()+a.left-c.left+5,top:b.scrollTop()+a.top-c.top+8}},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(a){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.source===this.model},this);if(!a){try{this.$(".dataflow-port-plug").draggable("disable")}catch(b){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(a){var b=a.get("route");void 0!==b&&(this.$(".dataflow-port-hole").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole").addClass("route"+b),this.topRoute=b)}}),b.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:b.View})}(Dataflow),function(a){var b=a.prototype.module("edge"),c=function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)"xlink:href"===d?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c},d='<h1 class="dataflow-edge-inspector-title">Edge</h1><div class="dataflow-edge-inspector-route-choose"></div>';b.View=Backbone.View.extend({tagName:"div",className:"dataflow-edge",positions:null,inspectTemplate:_.template(d),initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("change:x change:y change:w",this.render,this),this.model.target&&this.model.target.parentNode.on("change:x change:y",this.render,this),this.model.source&&this.model.source.view&&(this.model.source.view.plugSetActive(),this.model.source.view.bringToTop(this.model)),this.model.target&&this.model.target.view&&(this.model.target.view.plugSetActive(),this.model.target.view.bringToTop(this.model)),this.el=c("g",{"class":"dataflow-edge"}),this.elEdge=c("path",{"class":"dataflow-edge-wire"}),this.elShadow=c("path",{"class":"dataflow-edge-shadow"}),void 0!==this.model.get("route")&&this.elEdge.setAttribute("class","dataflow-edge-wire route"+this.model.get("route"));var a=this;this.model.on("change:route",function(){a.elEdge.setAttribute("class","dataflow-edge-wire route"+a.model.get("route")),a.bringToTop()}),this.el.appendChild(this.elShadow),this.el.appendChild(this.elEdge),this.el.addEventListener("click",function(b){a.click(b)})},render:function(a){var b,c=this.model.source,d=this.model.target;c?this.positions.from=c.view.holePosition():(b=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.from={left:graph.scrollLeft()+a.left-5-b.left,top:graph.scrollTop()+a.top+5-b.top}),d?this.positions.to=d.view.holePosition():(b=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.to={left:graph.scrollLeft()+a.left+15-b.left,top:graph.scrollTop()+a.top+5-b.top}),this.positions.from.left=Math.floor(this.positions.from.left),this.positions.from.top=Math.floor(this.positions.from.top),this.positions.to.left=Math.floor(this.positions.to.left),this.positions.to.top=Math.floor(this.positions.to.top);var e=this.edgePath(this.positions);this.elEdge.setAttribute("d",e),this.elShadow.setAttribute("d",e),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},fade:function(){this.el.setAttribute("class","dataflow-edge fade")},unfade:function(){this.el.setAttribute("class","dataflow-edge")},highlight:function(){this.el.setAttribute("class","dataflow-edge highlight")},unhighlight:function(){this.el.setAttribute("class","dataflow-edge")},edgePath:function(a){var b=20,c=a.to.left-b-(a.from.left+b),d=Math.floor(c/2),e=c-d,f=a.to.top-a.from.top,g=Math.floor(f/2),h=f-g,i="",j="";return Math.abs(f)>Math.abs(c)?f>0?c>0?(i=" L "+(a.from.left+b+d)+" "+(a.from.top+d),j=" L "+(a.to.left-b-e)+" "+(a.to.top-e)):0>c&&(i=" L "+(a.from.left+b+d)+" "+(a.from.top-d),j=" L "+(a.to.left-b-e)+" "+(a.to.top+e)):0>f&&(c>0?(i=" L "+(a.from.left+b+d)+" "+(a.from.top-d),j=" L "+(a.to.left-b-e)+" "+(a.to.top+e)):0>c&&(i=" L "+(a.from.left+b+d)+" "+(a.from.top+d),j=" L "+(a.to.left-b-e)+" "+(a.to.top-e))):Math.abs(f)<Math.abs(c)&&(c>0?f>0?(i=" L "+(a.from.left+b+g)+" "+(a.from.top+g),j=" L "+(a.to.left-b-h)+" "+(a.to.top-h)):0>f&&(i=" L "+(a.from.left+b-g)+" "+(a.from.top+g),j=" L "+(a.to.left-b+h)+" "+(a.to.top-h)):0>c&&(f>0?(i=" L "+(a.from.left+b-g)+" "+(a.from.top+g),j=" L "+(a.to.left-b+h)+" "+(a.to.top-h)):0>f&&(i=" L "+(a.from.left+b+g)+" "+(a.from.top+g),j=" L "+(a.to.left-b-h)+" "+(a.to.top-h)))),"M "+a.from.left+" "+a.from.top+" L "+(a.from.left+b)+" "+a.from.top+i+j+" L "+(a.to.left-b)+" "+a.to.top+" L "+a.to.left+" "+a.to.top},remove:function(){var a=this.model.source,b=this.model.target;a&&a.parentNode.off(null,null,this),b&&b.parentNode.off(null,null,this),a&&a.view.plugCheckActive(),b&&b.view.plugCheckActive(),this.el.parentNode.removeChild(this.el)},click:function(){this.highlight(),this.bringToTop(),this.model.trigger("select")},bringToTop:function(){this.model.bringToTop();var a=this.el.parentNode;a&&a.appendChild(this.el),this.model.source.view.bringToTop(this.model),this.model.target.view.bringToTop(this.model)},$inspect:null,getInspect:function(){if(!this.$inspect){this.$inspect=$("<div>");var a=this.model.toJSON();this.$inspect.html(this.inspectTemplate(a));for(var b=this.$inspect.children(".dataflow-edge-inspector-route-choose"),c=this,d=function(a){c.model.set("route",$(a.target).data("route"))},e=0;12>e;e++){var f=$("<button>").data("route",e).addClass("route"+e).click(d);b.append(f)}}return this.$inspect}})}(Dataflow),function(a){var b=a.prototype.plugin("edit");b.initialize=function(a){function b(){a.currentGraph.view.$(".node").addClass("ui-selected")}function c(){d(),_.each(g.nodes,function(a){a.x-=50,a.y-=50});var b=a.currentGraph.nodes.filter(function(a){return a.view.$el.hasClass("ui-selected")});_.each(b,function(a){a.remove()})}function d(){g={},g.nodes=[],a.currentGraph.nodes.each(function(a){a.view.$el.hasClass("ui-selected")&&g.nodes.push(JSON.parse(JSON.stringify(a)))}),g.edges=[],a.currentGraph.edges.each(function(a){var b=_.any(g.nodes,function(b){return a.source.parentNode.id===b.id}),c=_.any(g.nodes,function(b){return a.target.parentNode.id===b.id});b&&c&&g.edges.push(JSON.parse(JSON.stringify(a)))})}function e(){g&&g.nodes.length>0&&(a.currentGraph.view.$(".node").removeClass("ui-selected"),_.each(g.nodes,function(b){b.x+=50,b.y+=50,b.parentGraph=a.currentGraph;for(var c=b.id;a.currentGraph.nodes.get(b.id);)b.id++;c!==b.id&&_.each(g.edges,function(a){a.source.node===c&&(a.source.node=b.id),a.target.node===c&&(a.target.node=b.id)});var d=new a.nodes[b.type].Model(b);a.currentGraph.nodes.add(d),d.view.select()}),_.each(g.edges,function(b){b=JSON.parse(JSON.stringify(b)),b.parentGraph=a.currentGraph,b.id=b.source.node+":"+b.source.port+"::"+b.target.node+":"+b.target.port;var c=new a.modules.edge.Model(b);a.currentGraph.edges.add(c)})),_.defer(function(){a.currentGraph.view.rerenderEdges()})}var f=$('<div class="dataflow-plugin-edit"><button class="selectall">Select All (A)</button><br /><button class="cut">Cut (X)</button><br /><button class="copy">Copy (C)</button><br /><button class="paste">Paste (V)</button><br /></div>');f.children(".selectall").click(b),f.children(".cut").click(c);var g={};f.children(".copy").click(d),f.children(".paste").click(e),a.addContext({id:"cut",icon:"cut",label:"cut",action:c,contexts:["one","twoplus"]}),a.addContext({id:"copy",icon:"copy",label:"copy",action:d,contexts:["one","twoplus"]}),a.addContext({id:"paste",icon:"paste",label:"paste",action:e,contexts:["one","twoplus"]})}}(Dataflow),function(a){var b=a.prototype.plugin("elements");b.list=[{type:"div",attributes:["id","class","style"],events:["pointermove","pointerover","pointerout"]},{type:"button",attributes:["id","class","style"],events:["pointerdown","pointerup"]}]}(Dataflow),function(a){var b=a.prototype.plugin("library");b.initialize=function(a){var c=$('<ul class="dataflow-plugin-library" style="list-style:none; padding-left:0" />'),d=function(b,c,d){return function(){a.currentGraph.view.$(".node").removeClass("ui-selected");for(var e=1;a.currentGraph.nodes.get(e);)e++;c=void 0===c?200:c,d=void 0===d?200:d,c+=a.currentGraph.view.$el.scrollLeft(),d+=a.currentGraph.view.$el.scrollTop(),c=Math.max(c,0),d=Math.max(d,0);var f=new b.Model({id:e,x:c,y:d,parentGraph:a.currentGraph});a.currentGraph.nodes.add(f),f.view.select()}},e=function(b,e){var f=$('<a class="button">+</a>').attr("title","click or drag").draggable({helper:function(){var b=$('<div class="node helper" style="width:100px; height:100px">'+e+"</div>");return a.$el.append(b),b},stop:function(a,c){d(b,c.position.left,c.position.top).call()}}).click(d(b)),g=$("<li />").append(f).append(e);c.append(g)},f=function(b){b=b?b:{},b.exclude=b.exclude?b.exclude:["base","base-resizable"],c.empty(),_.each(a.nodes,function(a,c){-1===b.exclude.indexOf(c)&&e(a,c)})};f(),a.addPlugin({id:"library",name:"",menu:c,icon:"plus"}),b.update=f}}(Dataflow),function(a){var b=a.prototype.plugin("source");b.initialize=function(a){var c=$('<form class="dataflow-plugin-view-source"><div style="position: absolute; top:5px; left:5px; bottom:35px; right:5px;"><textarea class="code" style="width:100%; height:100%; margin:0; padding: 0;"></textarea><br/></div><input class="apply" type="submit" value="apply changes" style="position: absolute; right:5px; bottom:5px;" /></form>'),d=c.find(".code");a.addPlugin({id:"source",name:"",menu:c,icon:"globe"});var e=function(a){var b=d.prop("scrollTop");d.val(a),d.scrollTop(b)};b.show=e;var f=function(){a.graph&&e(JSON.stringify(a.graph.toJSON(),null,"  "))};b.listeners=function(b){b?a.on("change",f):a.off("change",f)},b.listeners(!0),c.submit(function(){var b;try{b=JSON.parse(d.val())}catch(c){return a.log("Invalid JSON"),!1}if(b){var e=a.loadGraph(b);e.trigger("change")}return!1})}}(Dataflow),function(a){var b=a.prototype.plugin("log");b.initialize=function(a){function c(a){a=_.escape(a),d.children(".loglist").append("<li>"+a+"</li>"),d.scrollTop(d.prop("scrollHeight"))}var d=$('<div class="dataflow-plugin-log" style="position: absolute; top:5px; left:5px; bottom:5px; right:5px; overflow:auto;"><ol class="loglist"></ol></div>');a.addPlugin({id:"log",name:"",menu:d,icon:"cog"}),b.add=c,b.listeners=function(b){b?(a.on("log",function(a){c("log: "+a)}),a.on("node:add",function(a,b){c("node added: "+b.toString())}),a.on("node:remove",function(a,b){c("node removed: "+b.toString())}),a.on("edge:add",function(a,b){c("edge added: "+b.toString())}),a.on("edge:remove",function(a,b){c("edge removed: "+b.toString())})):(a.off("log"),a.off("node:add"),a.off("node:remove"),a.off("edge:add"),a.off("edge:remove"))},b.listeners(!0)}}(Dataflow),function(a){var b=a.prototype.plugin("inspector");b.initialize=function(a){function c(){j&&j.view&&(h.children().detach(),h.append(j.view.getInputList()),j.view.highlightEdges())}function d(){a.showMenu("inspector"),c()}function e(a,b){j!==b&&(j=b,i.is(":visible")&&c())}function f(a){h.children().detach(),h.append(a.view.getInspect())}function g(a,b){j!==b&&(j=b,i.is(":visible")&&f(b))}var h=$('<div class="dataflow-plugin-inspector"></div>'),i=$("<div>").addClass("dataflow-menuitem dataflow-menuitem-inspector").append(h);a.$(".dataflow-menu").append(i);var j=null;a.addContext({id:"inspector",icon:"info-sign",label:"inspect",action:d,contexts:["one","twoplus"]}),b.listeners=function(b){b?(a.on("select:node",e),a.on("select:edge",g)):(a.off("select:node",e),a.off("select:edge",g))},b.listeners(!0)}}(Dataflow),function(a){var b=a.prototype.module("node"),c=a.prototype.node("base");c.Model=b.Model.extend({defaults:function(){return{label:"",type:"base",x:200,y:100,state:{}}},initialize:function(){b.Model.prototype.initialize.call(this)},unload:function(){},inputs:[],outputs:[]}),c.View=b.View.extend({})}(Dataflow);