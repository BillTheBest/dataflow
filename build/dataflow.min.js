/*! dataflow.js - v0.0.1 - 2013-06-19 (12:43:30 AM GMT+0300)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, GPL */
(function(e){var t=function(e,t,i){e[t]||(e[t]=new i),e[t]instanceof i||(e[t]=new i(e[t]))},i=e.Model.extend({defaults:{action:null,label:"",disabled:!1,icon:""}}),n=e.Collection.extend({model:i}),o=e.Model.extend({view:null,context:null,defaults:{control:null,actions:null,overflow:null,className:"actionbar"},initialize:function(e,o){t(this.attributes,"control",i),t(this.attributes,"actions",n),t(this.attributes,"overflow",n),this.context=o},render:function(){return this.view=new a({model:this,context:this.context}),this.view.render().el},show:function(){var t=this.render();e.$("body").prepend(t)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),s=e.Model.extend({view:null,context:null,defaults:{control:null,actions:null,className:"contextbar"},initialize:function(e,o){t(this.attributes,"control",i),t(this.attributes,"actions",n),this.context=o},render:function(){return this.view=new l({model:this,context:this.context}),this.view.render().el},show:function(){var t=this.render();e.$("body").prepend(t)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),a=e.View.extend({tagName:"div",className:"navbar navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-up":"handleUp","click .control-icon":"handleIcon","click .control-label":"handleLabel"},initialize:function(e){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=e.context},handleUp:function(e){e.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("up")&&this.model.get("control").get("up").call(this.context)},handleIcon:function(e){return this.model.get("control").get("up")?(this.handleUp(e),void 0):(this.handleLabel(e),void 0)},handleLabel:function(e){e.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=e.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this.renderOverflow(),this},renderControl:function(){if(this.model.get("control")){this.$control||(this.$control=e.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var t=this.model.get("control").get("icon"),i=this.model.get("control").get("up"),n=this.model.get("control").get("label");this.$control.empty(),i&&this.$control.append(e.$('<i class="control-up icon-chevron-left"></i><span class="control-up">&nbsp;</span>')),t&&this.$control.append(e.$('<i class="control-icon icon-'+t+'"></i>')),n&&this.$control.append('<span class="control-label">&nbsp;'+n+"</span>")}},renderActions:function(){if(!this.$actions){var e=new r({collection:this.model.get("actions"),context:this.context});this.$inner.append(e.render().$el),this.$actions=e.$el}},renderOverflow:function(){}}),l=e.View.extend({tagName:"div",className:"navbar navbar-inverse navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-icon":"handleControl","click .control-label":"handleControl"},handleControl:function(e){e.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},initialize:function(e){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=e.context},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=e.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this},renderControl:function(){this.$control||(this.$control=e.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var t=this.model.get("control").get("icon"),i=this.model.get("control").get("label");this.$control.empty(),t&&this.$control.append(e.$('<i class="control-icon icon-'+t+'"></i>')),i&&this.$control.append('<span class="control-label"> '+i+"</span>")},renderActions:function(){if(!this.$actions){var e=new r({collection:this.model.get("actions"),context:this.context});this.$inner.append(e.render().$el),this.$actions=e.$el}}}),r=e.View.extend({tagName:"ul",className:"nav pull-right",views:{},context:null,initialize:function(e){this.collection=e.collection,this.context=e.context,this.listenTo(this.collection,"add",this.addItem),this.listenTo(this.collection,"remove",this.removeItem),this.listenTo(this.collection,"reset",this.render)},render:function(){return this.$el.empty(),this.collection.each(this.addItem,this),this},addItem:function(e){var t=new d({model:e,context:this.context});this.$el.append(t.render().el),this.views[e.cid]=t},removeItem:function(e){this.views[e.cid]&&(this.views[e.cid].$el.remove(),delete this.views[e.cid])}}),d=e.View.extend({tagName:"li",template:"<a></a>",context:null,events:{click:"handleClick"},initialize:function(e){this.context=e.context,this.listenTo(this.model,"change",this.render)},handleClick:function(e){e.preventDefault(),this.model.get("disabled")||this.model.get("action")&&this.model.get("action").call(this.context)},render:function(){this.$el.html(this.template);var t=e.$("a",this.$el);return t.append(e.$('<i class="icon-'+this.model.get("icon")+'"></i>')),t.append(this.model.get("label")),this.model.get("disabled")?this.$el.addClass("disabled"):this.$el.removeClass("disabled"),this}});window.ActionBar=o,window.ContextBar=s})(Backbone),function(){var e=Backbone.Model.extend({$:function(e){return this.$el.find(e)},initialize:function(){this.el=document.createElement("div"),this.el.className="dataflow",this.$el=$(this.el);var e=$('<div class="menu">'),t=this;$('<button class="btn menu-close"><i class="icon-remove"></i></button>').click(function(){t.hideMenu()}).appendTo(e),this.$el.append(e),this.debug=this.get("debug"),this.prepareActionBar(),this.renderActionBar();for(var i in this.plugins)this.plugins[i].initialize&&this.plugins[i].initialize(this);var n=this.get("appendTo");n=n?n:"body",$(n).append(this.el)},prepareActionBar:function(){this.actionBar=new ActionBar({},this),this.actionBar.get("control").set({label:"Dataflow",icon:"retweet"}),this.contextBar=new ContextBar({},this),this.contextBar.get("control").set({label:"1 selected",icon:"ok",action:function(){this.currentGraph&&this.currentGraph.view&&this.currentGraph.view.deselect()}})},renderActionBar:function(){this.$el.append(this.actionBar.render()),this.$(".brand").attr({href:"https://github.com/meemoo/dataflow",target:"_blank"}),this.$el.append(this.contextBar.render()),this.contextBar.view.$el.hide()},modules:{},module:function(e){return this.modules[e]?this.modules[e]:(this.modules[e]={},this.modules[e])},nodes:{},node:function(e){return this.nodes[e]?this.nodes[e]:(this.nodes[e]={},this.nodes[e])},plugins:{},plugin:function(e){return this.plugins[e]?this.plugins[e]:(this.plugins[e]={},this.plugins[e])},hideMenu:function(){this.$el.removeClass("menu-shown")},showMenu:function(e){this.$el.addClass("menu-shown"),this.$(".menuitem").removeClass("shown"),this.$(".menuitem-"+e).addClass("shown")},addPlugin:function(e){if(e.menu){var t=$("<div>").addClass("menuitem menuitem-"+e.id).append(e.menu);this.$(".menu").append(t),this.actionBar.get("actions").add({id:e.id,icon:e.icon,label:e.name,action:function(){this.showMenu(e.id)}})}},showContextBar:function(){this.actionBar.view.$el.hide(),this.contextBar.view.$el.show()},hideContextBar:function(){this.contextBar.view.$el.hide(),this.actionBar.view.$el.show()},contexts:{},addContext:function(e){for(var t=0;e.contexts.length>t;t++){var i=e.contexts[t];this.contexts[i]||(this.contexts[i]=[]),this.contexts[i].push(e)}},changeContext:function(e){e.length>1?(this.contextBar.get("control").set({label:e.length+" selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.twoplus),this.showContextBar()):1===e.length?(this.contextBar.get("control").set({label:"1 selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.one),this.showContextBar()):this.hideContextBar()},loadGraph:function(e){this.graph&&(this.currentGraph.view&&this.currentGraph.view.remove(),this.graph.view&&this.graph.view.remove(),this.graph.remove());var t=this.module("graph");e.dataflow=this;var i=new t.Model(e);return i.view=new t.View({model:i}),this.$el.append(i.view.render().el),this.graph=this.currentGraph=i,i},showGraph:function(e){this.currentGraph.view.$el.detach(),this.$el.append(e.view.el),e.view.render(),this.currentGraph=e},debug:!1,log:function(e){this.trigger("log",e,arguments),this.debug&&console.log("Dataflow: ",arguments)},types:["all","canvas:2d","canvas:webgl","string","number","int","object","array"]});window.Dataflow=e,"object"==typeof exports&&(exports.Dataflow=e),Backbone.View.prototype.addEvents=function(e){this.delegateEvents(_.extend(_.clone(this.events),e))},Backbone.CollectionView=Backbone.Model.extend({initialize:function(){this.el=document.createElement(this.tagName),this.$el=$(this.el);var e=this.get("collection");e.each(this.addItem,this),e.on("add",this.addItem,this),e.on("remove",this.removeItem,this)},addItem:function(e){e.view=new this.itemView({model:e}),this.$el.append(e.view.render().el)},removeItem:function(e){e.view.remove()}})}(),function(e){var t=e.prototype.module("graph"),i=e.prototype.module("node"),n=e.prototype.module("edge");t.Model=Backbone.Model.extend({defaults:{nodes:[],edges:[]},initialize:function(){this.dataflow=this.get("dataflow");var e,t=this.nodes=new i.Collection;t.parentGraph=this,t.on("all",function(){this.trigger("change")},this),t.on("add",function(e){this.dataflow.trigger("node:add",this,e)},this),t.on("remove",function(e){e.remove(),this.dataflow.trigger("node:remove",this,e)},this);var o=this.get("nodes");for(e=0;o.length>e;e++){var s=o[e];s.parentGraph=this,s.type&&this.dataflow.nodes[s.type]?(s=new this.dataflow.nodes[s.type].Model(s),t.add(s)):this.dataflow.log("node "+s.id+" not added: node type ("+s.type+") not found",s)}var a=this.edges=new n.Collection;a.parentGraph=this,a.on("all",function(){this.trigger("change")},this),a.on("add",function(e){this.dataflow.trigger("edge:add",this,e)},this),a.on("remove",function(e){this.dataflow.trigger("edge:remove",this,e)},this);var l=this.get("edges");for(e=0;l.length>e;e++){var r=l[e];r.parentGraph=this,r.id=r.source.node+":"+r.source.port+"::"+r.target.node+":"+r.target.port;var d=t.get(r.source.node),h=t.get(r.target.node);d&&h&&d.outputs.get(r.source.port)&&h.inputs.get(r.target.port)?(r=new n.Model(r),a.add(r)):this.dataflow.log("edge "+r.id+" not added: node or port not found",r)}this.set({nodes:t,edges:a}),this.on("selectionChanged",this.selectionChanged),this.on("change",function(){this.dataflow.trigger("change",this)},this)},selectionChanged:function(){this.selected=[],this.view&&(this.nodes.each(function(e){e.view&&e.view.$el.hasClass("ui-selected")&&this.selected.push(e)},this),this.dataflow.changeContext(this.selected))},remove:function(){for(;this.nodes.length>0;)this.nodes.remove(this.nodes.at(this.nodes.length-1))},toJSON:function(){return{nodes:this.nodes,edges:this.edges}}})}(Dataflow),function(e){var t=e.prototype.module("node"),i=e.prototype.module("input"),n=e.prototype.module("output");t.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100,state:{}},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type"),""===this.get("label")&&this.set({label:this.get("type")});var e=this.inputs;this.inputs=new i.Collection,this.inputs.parentNode=this;for(var t=0;e.length>t;t++){var o=e[t],s=this.get("state");void 0!==o.value&&void 0===s[o.id]&&(s[o.id]=o.value),o.parentNode=this,o=new i.Model(o),this.inputs.add(o)}var a=this.outputs;for(this.outputs=new n.Collection,this.outputs.parentNode=this,t=0;a.length>t;t++){var l=a[t];l.parentNode=this,l=new n.Model(l),this.outputs.add(l)}},setState:function(e,t){var i=this.get("state");i[e]=t,this["input"+e]&&this["input"+e](t),this.trigger("change:state:"+e)},setBang:function(e){this["input"+e]&&this["input"+e]()},send:function(e,t){var i=this;_.defer(function(){i.trigger("send:"+e,t)})},recieve:function(e,t){"function"==typeof this["input"+e]?this["input"+e](t):this["_"+e]=t},remove:function(){this.inputs.each(function(e){e.remove()}),this.outputs.each(function(e){e.remove()}),this.unload(),this.collection.remove(this)},unload:function(){},toString:function(){return this.id+" ("+this.type+")"},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y"),state:this.get("state")}},inputs:[],outputs:[]}),t.Collection=Backbone.Collection.extend({model:t.Model,comparator:function(e){return e.get("x")}})}(Dataflow),function(e){var t=e.prototype.module("input");t.Model=Backbone.Model.extend({defaults:{id:"input",label:"",type:"all",description:""},initialize:function(){this.parentNode=this.get("parentNode"),""===this.get("label")&&this.set({label:this.id}),this.connected=[]},connect:function(e){for(var t=!0,i=0;this.connected.length>i;i++)this.connected[i].id===e.id&&(t=!1);t&&this.connected.push(e)},disconnect:function(e){this.connected=_.without(this.connected,e)},remove:function(){for(;this.connected.length>0;)this.connected[0].remove()}}),t.Collection=Backbone.Collection.extend({model:t.Model})}(Dataflow),function(e){var t=e.prototype.module("input"),i=e.prototype.module("output");i.Model=t.Model.extend({defaults:{id:"output",label:"",type:"all",description:""}}),i.Collection=Backbone.Collection.extend({model:i.Model})}(Dataflow),function(e){var t=e.prototype.module("edge");t.Model=Backbone.Model.extend({defaults:{z:0},initialize:function(){var e,t,i,n=this.get("preview");if(this.parentGraph=this.get("parentGraph"),n){e=this.get("parentGraph").nodes;var o=this.get("source"),s=this.get("target");o?(t=e.get(this.get("source").node),this.source=t.outputs.get(this.get("source").port)):s&&(i=e.get(this.get("target").node),this.target=i.inputs.get(this.get("target").port))}else{e=this.parentGraph.nodes;try{t=e.get(this.get("source").node),this.source=t.outputs.get(this.get("source").port),i=e.get(this.get("target").node),this.target=i.inputs.get(this.get("target").port)}catch(a){}this.source.connect(this),this.target.connect(this),t.on("send:"+this.source.id,this.send,this),this.bringToTop()}},send:function(e){this.target.parentNode.recieve(this.target.id,e)},isConnectedToPort:function(e){return this.source===e||this.target===e},isConnectedToNode:function(e){return this.source.parentNode===e||this.target.parentNode===e},toString:function(){return this.get("source").node+":"+this.get("source").port+"::"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target")}},bringToTop:function(){var e=0;this.parentGraph.edges.each(function(t){if(t!==this){var i=t.get("z");i>e&&(e=i),t.view&&t.view.unhighlight()}},this),this.set("z",e+1),this.collection&&this.collection.sort()},remove:function(){this.source.disconnect(this),this.target.disconnect(this),this.collection&&this.collection.remove(this),this.source.parentNode.off("send:"+this.source.id,this.send,this)}}),t.Collection=Backbone.Collection.extend({model:t.Model,comparator:function(e){return e.get("z")}})}(Dataflow),function(e){var t=e.prototype.module("graph");e.prototype.module("node");var i=e.prototype.module("edge"),n='<div class="edges"><svg class="svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="nodes" /><div class="graph-controls" />';t.View=Backbone.View.extend({template:_.template(n),className:"graph",events:{click:"deselect"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("nodes"),t=this.model.get("edges");this.nodes=e.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=t.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this);var i=this.model.get("parentNode");if(i){this.$(".graph-controls").text(i.get("label"));for(var n,o,s,a=this,l=function(e){return function(){return a.model.dataflow.showGraph(e),!1}};i;)n=i.get("parentGraph"),i=n.get("parentNode"),s=i?i.get("label"):"main",o=$('<a href="#">').text(s).click(l(n)),this.$(".graph-controls").prepend(" / ").prepend(o)}},render:function(){var e=this;return _.defer(function(){e.rerenderEdges()},this),this},addNode:function(e){var t=this.model.dataflow.nodes[e.type];if(t&&t.View)e.view=new t.View({model:e});else{var i=this.model.dataflow.node("base");e.view=new i.View({model:e})}this.nodes[e.id]=e.view,e.view.render(),this.$(".nodes").append(e.view.el)},removeNode:function(e){e.view.remove(),this.nodes[e.id]=null,delete this.nodes[e.id]},addEdge:function(e){e.view=new i.View({model:e}),this.edges[e.id]=e.view,e.view.render(),this.$(".svg-edges")[0].appendChild(e.view.el)},removeEdge:function(e){e.view.remove(),this.edges[e.id]=null,delete this.edges[e.id]},rerenderEdges:function(){_.each(this.edges,function(e){e.render()},this)},sizeSVG:function(){try{var e=this.$(".svg-edges")[0],t=e.getBBox();e.setAttribute("width",Math.round(t.x+t.width+50)),e.setAttribute("height",Math.round(t.y+t.height+50))}catch(i){}},deselect:function(){this.$(".node").removeClass("ui-selected"),this.model.trigger("selectionChanged")}})}(Dataflow),function(e){var t=e.prototype.module("node"),i=e.prototype.module("input"),n=e.prototype.module("output"),o='<div class="outer" /><h1 class="title"><span class="label"><%- label %></span> <input class="label-edit" value="<%- label %>" type="text" /></h1><div class="controls"><button class="delete">delete</button><button class="save">save</button><button class="cancel">cancel</button></div><button class="edit">edit</button><div class="ports ins" /><div class="ports outs" /><div class="inner" />',s="";t.View=Backbone.View.extend({template:_.template(o),innerTemplate:_.template(s),className:"node",events:function(){return{"click .title":"select","click .delete":"removeModel",dragstart:"dragStart",drag:"drag",dragstop:"dragStop","click .edit":"showControls","click .cancel":"hideControls","click .save":"saveLabel"}},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.type),this.inputs=this.model.inputs.view=new i.CollectionView({collection:this.model.inputs}),this.outputs=this.model.outputs.view=new n.CollectionView({collection:this.model.outputs});var e=this;this.$el.draggable({handle:"h1",helper:function(){var t=e.$el,i=t.width(),n=t.height();return $('<div class="node helper" style="width:'+i+"px; height:"+n+'px">')}}),this.$el.data("dataflow-node-view",this),this.$(".inner").append(this.innerTemplate)},render:function(){return this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$(".ins").html(this.inputs.el),this.$(".outs").html(this.outputs.el),this.$(".controls").hide(),this.$(".title .label-edit").hide(),this},_alsoDrag:[],_dragDelta:{},dragStart:function(e){this.$el.hasClass("ui-selected")||this.select(e);var t=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(t.el!==this){var e=$(this),i={left:parseInt(e.css("left"),10),top:parseInt(e.css("top"),10)};e.data("ui-draggable-alsodrag-initial",i);var n=$('<div class="node helper">').css({width:e.width(),height:e.height(),left:i.left,top:i.top});e.parent().append(n),e.data("ui-draggable-alsodrag-helper",n),t._alsoDrag.push(e)}})},drag:function(e){if(this._alsoDrag.length){var t=$(e.target).data("ui-draggable"),i=t.originalPosition,n={top:t.position.top-i.top||0,left:t.position.left-i.left||0};_.each(this._alsoDrag,function(e){var t=e.data("ui-draggable-alsodrag-initial"),i=e.data("ui-draggable-alsodrag-helper");i.css({left:t.left+n.left,top:t.top+n.top})})}},dragStop:function(e,t){var i=parseInt(t.position.left,10),n=parseInt(t.position.top,10);this.moveToPosition(i,n),this._alsoDrag.length&&(_.each(this._alsoDrag,function(e){e.data("ui-draggable-alsodrag-initial");var t=e.data("ui-draggable-alsodrag-helper"),i=e.data("dataflow-node-view");i.moveToPosition(parseInt(t.css("left"),10),parseInt(t.css("top"),10)),t.remove(),e.data("ui-draggable-alsodrag-initial",null),e.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[])},moveToPosition:function(e,t){e=Math.max(e,0),t=Math.max(t,0),this.$el.css({left:e,top:t}),this.model.set({x:e,y:t})},showControls:function(){this.$(".title .label").hide(),this.$(".title .label-edit").show(),this.$(".edit").hide(),this.$(".controls").show()},hideControls:function(){this.$(".title .label-edit").hide(),this.$(".title .label").show(),this.$(".controls").hide(),this.$(".edit").show()},saveLabel:function(){var e=this.$(".title .label-edit").val();this.model.get("label")!==e&&(this.model.set("label",e),this.$(".title .label").text(e)),this.hideControls()},removeModel:function(){this.model.remove()},bringToTop:function(){var e=0;this.model.collection.each(function(t){var i=parseInt(t.view.el.style.zIndex,10);i>e&&(e=i)},this),this.el.style.zIndex=e+1},select:function(e){e?(e.stopPropagation(),e.ctrlKey||e.metaKey?this.$el.toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$el.addClass("ui-selected")),this.bringToTop()):(this.$el.addClass("ui-selected"),this.bringToTop()),this.model.parentGraph.trigger("selectionChanged")}})}(Dataflow),function(e){var t=e.prototype.module("input"),i=e.prototype.module("edge"),n='<span class="plug in" title="drag to edit wire"></span><span class="hole in" title="drag to make new wire"></span><label class="label in" title="<%= description %>"><span class="input-container in"></span><%= label %></label>';t.View=Backbone.View.extend({template:_.template(n),tagName:"li",className:"port in",events:{click:"getTopEdge",drop:"connectEdge","dragstart .hole":"newEdgeStart","drag      .hole":"newEdgeDrag","dragstop  .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag      .plug":"changeEdgeDrag","dragstop  .plug":"changeEdgeStop","change .input-select":"inputSelect","change .input-int":"inputInt","change .input-number":"inputFloat","change .input-float":"inputFloat","change .input-string":"inputString","change .input-boolean":"inputBoolean","click  .input-bang":"inputBang"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var e=this;this.$(".plug").draggable({cursor:"pointer",helper:function(){var e=$('<span class="plug in helper" />');return $(document.body).append(e),e},disabled:!0,distance:10,delay:100}),this.$(".hole").draggable({cursor:"pointer",helper:function(){var t=$('<span class="plug out helper" />').data({port:e.model});return $(document.body).append(t),t}}),this.$el.droppable({accept:".plug.in, .hole.out",activeClassType:"droppable-hover"});var t,i=this.model.get("type"),n=this.model.parentNode.get("state"),o=this.model.get("options");if(void 0!==o){var s;if(n&&void 0!==n[this.model.id]?s=n[this.model.id]:void 0!==this.model.get("value")&&(s=this.model.get("value")),"string"==typeof o&&(o=o.split(" ")),$.isArray(o)){for(var a={},l=0;o.length>l;l++)a[o[l]]=o[l];o=a}t=$('<select class="input input-select">');for(var r in o){var d=$('<option value="'+o[r]+'">'+r+"</option>").data("val",o[r]);s&&o[r]===s&&d.prop("selected",!0),t.append(d)}}else if("int"===i||"float"===i||"number"===i){var h={};void 0!==this.model.get("min")&&(h.min=this.model.get("min")),void 0!==this.model.get("max")&&(h.max=this.model.get("max")),"int"===i&&(h.step=1),t=$('<input type="number" class="input input-number">').attr(h).addClass("int"===i?"input-int":"input-float"),n&&void 0!==n[this.model.id]?t.val(n[this.model.id]):void 0!==this.model.get("value")&&t.val(this.model.get("value"))}else"string"===i||"all"===i?(t=$('<input class="input input-string">'),n&&void 0!==n[this.model.id]?t.val(n[this.model.id]):void 0!==this.model.get("value")&&t.val(this.model.get("value"))):"boolean"===i?(t=$('<input type="checkbox" class="input input-boolean">'),n&&void 0!==n[this.model.id]?t.prop("checked",n[this.model.id]):void 0!==this.model.get("value")&&t.prop("checked",this.model.get("value"))):"bang"===i&&(t=$('<button class="input input-bang">!</button>'));t&&this.$(".input-container").append(t)},inputSelect:function(e){var t=$(e.target).find(":selected").data("val");this.model.parentNode.setState(this.model.id,t)},inputInt:function(e){this.model.parentNode.setState(this.model.id,parseInt($(e.target).val(),10))},inputFloat:function(e){this.model.parentNode.setState(this.model.id,parseFloat($(e.target).val()))},inputString:function(e){this.model.parentNode.setState(this.model.id,$(e.target).val())},inputBoolean:function(e){this.model.parentNode.setState(this.model.id,$(e.target).prop("checked"))},inputBang:function(){this.model.parentNode.setBang(this.model.id)},render:function(){return this},newEdgeStart:function(e){e.stopPropagation(),this.previewEdgeNew=new i.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeNewView=new i.View({model:this.previewEdgeNew});var t=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];t.appendChild(this.previewEdgeNewView.el)},newEdgeDrag:function(e,t){e.stopPropagation(),this.previewEdgeNewView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(e){e.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},getTopEdge:function(){var e;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(t){t.target===this.model&&(e=t),t.view&&t.view.unhighlight()},this),e&&e.view&&e.view.click()),e},changeEdgeStart:function(e,t){if(e.stopPropagation(),this.isConnected){var n=this.getTopEdge();if(n){n.remove(),t.helper.data({port:n.source}),this.previewEdgeChange=new i.Model({source:n.get("source"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new i.View({model:this.previewEdgeChange});var o=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];o.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(e,t){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(e){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(e,t){var i=t.helper.data("port"),n=this.model.parentNode.parentGraph.edges.length;return i.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow?!1:(this.model.parentNode.parentGraph.edges.add({id:i.parentNode.id+":"+i.id+"::"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:i.parentNode.id,port:i.id},target:{node:this.model.parentNode.id,port:this.model.id}}),t.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>n),void 0)},holePosition:function(){var e=this.model.parentNode.view.$el.position(),t=this.$(".hole").position();return{left:e.left+t.left+10,top:e.top+t.top+10}},isConnected:!1,plugSetActive:function(){try{this.$(".plug").draggable("enable")}catch(e){}this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var e=this.model.parentNode.parentGraph.edges.some(function(e){return e.target===this.model},this);if(!e){try{this.$(".plug").draggable("disable")}catch(t){}this.$(".plug").removeClass("active"),this.isConnected=!1}}}),t.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:t.View})}(Dataflow),function(e){var t=e.prototype.module("output"),i=e.prototype.module("edge"),n='<span class="label out" title="<%= description %>"><%= label %></span><span class="hole out" title="drag to make new wire"></span><span class="plug out" title="drag to edit wire"></span>';t.View=Backbone.View.extend({template:_.template(n),tagName:"li",className:"port out",events:{click:"getTopEdge",drop:"connectEdge","dragstart .hole":"newEdgeStart","drag .hole":"newEdgeDrag","dragstop .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag .plug":"changeEdgeDrag","dragstop .plug":"changeEdgeStop"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var e=this;this.$(".plug").draggable({cursor:"pointer",helper:function(){var e=$('<span class="plug out helper" />');return $(document.body).append(e),e},disabled:!0,distance:10,delay:100}),this.$(".hole").draggable({cursor:"pointer",helper:function(){var t=$('<span class="plug in helper" />').data({port:e.model});return $(document.body).append(t),t}}),this.$el.droppable({accept:".plug.out, .hole.in",activeClassType:"droppable-hover"})},render:function(){return this},newEdgeStart:function(e){e.stopPropagation(),this.previewEdge=new i.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeView=new i.View({model:this.previewEdge});var t=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];t.appendChild(this.previewEdgeView.el)},newEdgeDrag:function(e,t){e.stopPropagation(),this.previewEdgeView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(e){e.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},getTopEdge:function(){var e;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(t){t.source===this.model&&(e=t),t.view&&t.view.unhighlight()},this),e&&e.view&&e.view.click()),e},changeEdgeStart:function(e,t){if(e.stopPropagation(),this.isConnected){var n=this.getTopEdge();if(n){n.remove(),t.helper.data({port:n.target}),this.previewEdgeChange=new i.Model({target:n.get("target"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new i.View({model:this.previewEdgeChange});var o=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];o.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(e,t){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(e){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(e,t){var i=t.helper.data("port"),n=this.model.parentNode.parentGraph.edges.length;return i.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow?!1:(this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"::"+i.parentNode.id+":"+i.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:i.parentNode.id,port:i.id}}),t.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>n),void 0)},holePosition:function(){var e=this.model.parentNode.view.$el.position(),t=this.$(".hole").position();return{left:e.left+t.left+10,top:e.top+t.top+10}},plugSetActive:function(){try{this.$(".plug").draggable("enable")}catch(e){}this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var e=this.model.parentNode.parentGraph.edges.some(function(e){return e.source===this.model},this);if(!e){try{this.$(".plug").draggable("disable")}catch(t){}this.$(".plug").removeClass("active"),this.isConnected=!1}}}),t.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:t.View})
}(Dataflow),function(e){var t=e.prototype.module("edge"),i=function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);for(var n in t)"xlink:href"===n?i.setAttributeNS("http://www.w3.org/1999/xlink","href",t[n]):i.setAttribute(n,t[n]);return i};t.View=Backbone.View.extend({tagName:"div",className:"edge",positions:null,initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("change:x change:y change:w",this.render,this),this.model.target&&this.model.target.parentNode.on("change:x change:y",this.render,this),this.model.source&&this.model.source.view&&this.model.source.view.plugSetActive(),this.model.target&&this.model.target.view&&this.model.target.view.plugSetActive(),this.el=i("g",{"class":"edge"}),this.elEdge=i("path",{"class":"edge-wire"}),this.elShadow=i("path",{"class":"edge-shadow"}),this.el.appendChild(this.elShadow),this.el.appendChild(this.elEdge);var e=this;this.el.addEventListener("click",function(t){e.click(t)})},render:function(e){var t,i=this.model.source,n=this.model.target;i?this.positions.from=i.view.holePosition():(t=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.from={left:graph.scrollLeft()+e.left-10-t.left,top:graph.scrollTop()+e.top-30-t.top}),n?this.positions.to=n.view.holePosition():(t=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.to={left:graph.scrollLeft()+e.left+25-t.left,top:graph.scrollTop()+e.top-30-t.top});var o=this.edgePath(this.positions);this.elEdge.setAttribute("d",o),this.elShadow.setAttribute("d",o),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},fade:function(){this.el.setAttribute("class","edge fade")},unfade:function(){this.el.setAttribute("class","edge")},highlight:function(){this.el.setAttribute("class","edge highlight")},unhighlight:function(){this.el.setAttribute("class","edge")},edgePath:function(e){return"M "+e.from.left+" "+e.from.top+" L "+(e.from.left+50)+" "+e.from.top+" L "+(e.to.left-50)+" "+e.to.top+" L "+e.to.left+" "+e.to.top},remove:function(){var e=this.model.source,t=this.model.target;e&&e.parentNode.off(null,null,this),t&&t.parentNode.off(null,null,this),e&&e.view.plugCheckActive(),t&&t.view.plugCheckActive(),this.el.parentNode.removeChild(this.el)},click:function(){this.highlight(),this.bringToTop()},bringToTop:function(){this.model.bringToTop();var e=this.el.parentNode;e&&(e.removeChild(this.el),e.appendChild(this.el))}})}(Dataflow),function(e){var t=e.prototype.plugin("edit");t.initialize=function(e){function t(){e.currentGraph.view.$(".node").addClass("ui-selected")}function i(){n(),_.each(a.nodes,function(e){e.x-=50,e.y-=50});var t=e.currentGraph.nodes.filter(function(e){return e.view.$el.hasClass("ui-selected")});_.each(t,function(e){e.remove()})}function n(){a={},a.nodes=[],e.currentGraph.nodes.each(function(e){e.view.$el.hasClass("ui-selected")&&a.nodes.push(JSON.parse(JSON.stringify(e)))}),a.edges=[],e.currentGraph.edges.each(function(e){var t=_.any(a.nodes,function(t){return e.source.parentNode.id===t.id}),i=_.any(a.nodes,function(t){return e.target.parentNode.id===t.id});t&&i&&a.edges.push(JSON.parse(JSON.stringify(e)))})}function o(){a&&a.nodes.length>0&&(e.currentGraph.view.$(".node").removeClass("ui-selected"),_.each(a.nodes,function(t){t.x+=50,t.y+=50,t.parentGraph=e.currentGraph;for(var i=t.id;e.currentGraph.nodes.get(t.id);)t.id++;i!==t.id&&_.each(a.edges,function(e){e.source.node===i&&(e.source.node=t.id),e.target.node===i&&(e.target.node=t.id)});var n=new e.nodes[t.type].Model(t);e.currentGraph.nodes.add(n),n.view.select()}),_.each(a.edges,function(t){t=JSON.parse(JSON.stringify(t)),t.parentGraph=e.currentGraph,t.id=t.source.node+":"+t.source.port+"::"+t.target.node+":"+t.target.port;var i=new e.modules.edge.Model(t);e.currentGraph.edges.add(i)})),_.defer(function(){e.currentGraph.view.rerenderEdges()})}var s=$('<div class="dataflow-plugin-edit"><button class="selectall">Select All (A)</button><br /><button class="cut">Cut (X)</button><br /><button class="copy">Copy (C)</button><br /><button class="paste">Paste (V)</button><br /></div>');s.children(".selectall").click(t),s.children(".cut").click(i);var a={};s.children(".copy").click(n),s.children(".paste").click(o),e.addContext({id:"cut",icon:"cut",label:"cut",action:i,contexts:["one","twoplus"]}),e.addContext({id:"copy",icon:"copy",label:"copy",action:n,contexts:["one","twoplus"]}),e.addContext({id:"paste",icon:"paste",label:"paste",action:o,contexts:["one","twoplus"]})}}(Dataflow),function(e){var t=e.prototype.plugin("elements");t.list=[{type:"div",attributes:["id","class","style"],events:["pointermove","pointerover","pointerout"]},{type:"button",attributes:["id","class","style"],events:["pointerdown","pointerup"]}]}(Dataflow),function(e){var t=e.prototype.plugin("library");t.initialize=function(e){var i=$('<ul class="dataflow-plugin-library" style="list-style:none; padding-left:0" />'),n=function(t,i,n){return function(){e.currentGraph.view.$(".node").removeClass("ui-selected");for(var o=1;e.currentGraph.nodes.get(o);)o++;i=void 0===i?200:i,n=void 0===n?200:n,i+=e.currentGraph.view.$el.scrollLeft(),n+=e.currentGraph.view.$el.scrollTop(),i=Math.max(i,0),n=Math.max(n,0);var s=new t.Model({id:o,x:i,y:n,parentGraph:e.currentGraph});e.currentGraph.nodes.add(s),s.view.select()}},o=function(t,o){var s=$('<a class="button">+</a>').attr("title","click or drag").draggable({helper:function(){var t=$('<div class="node helper" style="width:100px; height:100px">'+o+"</div>");return e.$el.append(t),t},stop:function(e,i){n(t,i.position.left,i.position.top).call()}}).click(n(t)),a=$("<li />").append(s).append(o);i.append(a)},s=function(t){t=t?t:{},t.exclude=t.exclude?t.exclude:["base","base-resizable"],i.empty(),_.each(e.nodes,function(e,i){-1===t.exclude.indexOf(i)&&o(e,i)})};s(),e.addPlugin({id:"library",name:"library",menu:i,icon:"book"}),t.update=s}}(Dataflow),function(e){var t=e.prototype.plugin("source");t.initialize=function(e){var i=$('<form class="dataflow-plugin-view-source"><div style="position: absolute; top:5px; left:5px; bottom:35px; right:5px;"><textarea class="code" style="width:100%; height:100%; margin:0; padding: 0;"></textarea><br/></div><input class="apply" type="submit" value="apply changes" style="position: absolute; right:5px; bottom:5px;" /></form>'),n=i.find(".code");e.addPlugin({id:"source",name:"view source",menu:i,icon:"cog"});var o=function(e){var t=n.prop("scrollTop");n.val(e),n.scrollTop(t)};t.show=o;var s=function(){e.graph&&o(JSON.stringify(e.graph.toJSON(),null,"  "))};t.listeners=function(t){t?e.on("change",s):e.off("change",s)},t.listeners(!0),i.submit(function(){var t;try{t=JSON.parse(n.val())}catch(i){return e.log("Invalid JSON"),!1}if(t){var o=e.loadGraph(t);o.trigger("change")}return!1})}}(Dataflow),function(e){var t=e.prototype.plugin("log");t.initialize=function(e){function i(e){e=_.escape(e),n.children(".loglist").append("<li>"+e+"</li>"),n.scrollTop(n.prop("scrollHeight"))}var n=$('<div class="dataflow-plugin-log" style="position: absolute; top:5px; left:5px; bottom:5px; right:5px; overflow:auto;"><ol class="loglist"></ol></div>');e.addPlugin({id:"log",name:"log",menu:n,icon:"cog"}),t.add=i,t.listeners=function(t){t?(e.on("log",function(e){i("log: "+e)}),e.on("node:add",function(e,t){i("node added: "+(""+t))}),e.on("node:remove",function(e,t){i("node removed: "+(""+t))}),e.on("edge:add",function(e,t){i("edge added: "+(""+t))}),e.on("edge:remove",function(e,t){i("edge removed: "+(""+t))})):(e.off("log"),e.off("node:add"),e.off("node:remove"),e.off("edge:add"),e.off("edge:remove"))},t.listeners(!0)}}(Dataflow);