/*! dataflow.js - v0.0.1 - 2013-02-13 (11:51:40 AM GMT+0200)
* https://github.com/meemoo/dataflow
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, GPL */
(function(){var a=Backbone.Model.extend({$:function(a){return this.$el.children(a)},initialize:function(a){this.el=document.createElement("div"),this.el.className="dataflow",this.$el=$(this.el),this.$el.append('<div class="plugins"/>'),this.$el.append('<div class="navigation"/>')},modules:{},module:function(a){return this.modules[a]?this.modules[a]:this.modules[a]={}},nodes:{},node:function(a){return this.nodes[a]?this.nodes[a]:this.nodes[a]={}},plugins:{},addPlugin:function(a,b){this.plugins[a]={};if(b){var c=$("<h1 />").text(a).click(function(){$(this).next().toggle()}),d=$("<div />").html(b).hide();this.$(".plugins").append(c).append(d)}},loadGraph:function(a){this.graph&&(this.currentGraph.view&&this.currentGraph.view.remove(),this.graph.view&&this.graph.view.remove(),this.graph.remove());var b=this.module("graph"),c=new b.Model(a);return c.view=new b.View({model:c}),this.$el.append(c.view.render().el),this.graph=this.currentGraph=c,c},showGraph:function(a){this.currentGraph.view.$el.detach(),this.$el.append(a.view.el),a.view.render(),this.currentGraph=a},debug:!1,log:function(a){this.trigger("log",a,arguments),this.debug&&console.log("Dataflow: ",arguments)},types:["all","canvas:2d","canvas:webgl","string","number","int","object","array"]});window.Dataflow=new a,jQuery(function(a){a("body").append(Dataflow.el)}),Backbone.View.prototype.addEvents=function(a){this.delegateEvents(_.extend(_.clone(this.events),a))},Backbone.CollectionView=Backbone.Model.extend({initialize:function(){this.el=document.createElement(this.tagName),this.$el=$(this.el);var a=this.get("collection");a.each(this.addItem,this),a.on("add",this.addItem,this),a.on("remove",this.removeItem,this)},addItem:function(a){a.view=new this.itemView({model:a}),this.$el.append(a.view.render().el)},removeItem:function(a){a.view.remove()}})})(),jQuery(function(a){var b=Backbone.Router.extend({routes:{"":"index"},index:function(){}});Dataflow.router=new b,Backbone.history.start()}),function(a){var b=Dataflow.module("node"),c=Dataflow.module("edge");a.Model=Backbone.Model.extend({defaults:{nodes:[],edges:[]},initialize:function(){var a,d=this.nodes=new b.Collection;d.parentGraph=this,d.on("all",function(){this.trigger("change")},this),d.on("add",function(a){Dataflow.trigger("node:add",this,a)},this),d.on("remove",function(a){a.remove(),Dataflow.trigger("node:remove",this,a)},this);var e=this.get("nodes");for(a=0;a<e.length;a++){var f=e[a];f.parentGraph=this,f.type&&Dataflow.nodes[f.type]?(f=new Dataflow.nodes[f.type].Model(f),d.add(f)):Dataflow.log("node "+f.id+" not added: node type ("+f.type+") not found",f)}var g=this.edges=new c.Collection;g.parentGraph=this,g.on("all",function(){this.trigger("change")},this),g.on("add",function(a){Dataflow.trigger("edge:add",this,a)},this),g.on("remove",function(a){Dataflow.trigger("edge:remove",this,a)},this);var h=this.get("edges");for(a=0;a<h.length;a++){var i=h[a];i.parentGraph=this,i.id=i.source.node+":"+i.source.port+"→"+i.target.node+":"+i.target.port;var j=d.get(i.source.node),k=d.get(i.target.node);j&&k&&j.outputs.get(i.source.port)&&k.inputs.get(i.target.port)?(i=new c.Model(i),g.add(i)):Dataflow.log("edge "+i.id+" not added: node or port not found",i)}this.set({nodes:d,edges:g}),this.on("change",function(){Dataflow.trigger("change",this)},this)},remove:function(){while(this.nodes.length>0)this.nodes.remove(this.nodes.at(this.nodes.length-1))},toJSON:function(){return{nodes:this.nodes,edges:this.edges}}})}(Dataflow.module("graph")),function(a){var b=Dataflow.module("input"),c=Dataflow.module("output");a.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100,state:{}},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type"),this.get("label")===""&&this.set({label:this.get("type")});var a=this.inputs;this.inputs=new b.Collection,this.inputs.parentNode=this;for(var d=0;d<a.length;d++){var e=a[d],f=this.get("state");e.value!==undefined&&f[e.id]===undefined&&(f[e.id]=e.value),e.parentNode=this,e=new b.Model(e),this.inputs.add(e)}var g=this.outputs;this.outputs=new c.Collection,this.outputs.parentNode=this;for(d=0;d<g.length;d++){var h=g[d];h.parentNode=this,h=new c.Model(h),this.outputs.add(h)}},setState:function(a,b){var c=this.get("state");c[a]=b,this["input"+a]&&this["input"+a](b),this.trigger("change:state:"+a)},setBang:function(a){this["input"+a]&&this["input"+a]()},send:function(a,b){var c=this.outputs.get(a);c&&c.send(b)},remove:function(){this.inputs.each(function(a){a.remove()}),this.outputs.each(function(a){a.remove()}),this.unload(),this.collection.remove(this)},unload:function(){},toString:function(){return this.id+" ("+this.type+")"},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y"),state:this.get("state")}},inputs:[],outputs:[]}),a.Collection=Backbone.Collection.extend({model:a.Model,comparator:function(a){return a.get("x")}})}(Dataflow.module("node")),function(a){a.Model=Backbone.Model.extend({defaults:{id:"input",label:"",type:"all",description:""},initialize:function(){this.parentNode=this.get("parentNode"),this.get("label")===""&&this.set({label:this.id}),this.connected=[]},connect:function(a){var b=!0;for(var c=0;c<this.connected.length;c++)this.connected[c].id===a.id&&(b=!1);b&&this.connected.push(a)},disconnect:function(a){this.connected=_.without(this.connected,a)},remove:function(){while(this.connected.length>0)this.connected[0].remove()}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("input")),function(a){var b=a.module("input"),c=a.module("output");c.Model=b.Model.extend({defaults:{id:"output",label:"",type:"all",description:""},send:function(a){for(var b=0;b<this.connected.length;b++){var c=this.connected[b],d=c.target.parentNode,e=c.target.id;d["input"+e]?d["input"+e](a):d["_"+e]=a}}}),c.Collection=Backbone.Collection.extend({model:c.Model})}(Dataflow),function(a){a.Model=Backbone.Model.extend({defaults:{z:0},initialize:function(){var a,b=this.get("preview");if(b){a=this.get("parentGraph").nodes;var c=this.get("source"),d=this.get("target");c?this.source=a.get(this.get("source").node).outputs.get(this.get("source").port):d&&(this.target=a.get(this.get("target").node).inputs.get(this.get("target").port))}else{this.parentGraph=this.get("parentGraph"),a=this.parentGraph.nodes;try{this.source=a.get(this.get("source").node).outputs.get(this.get("source").port),this.target=a.get(this.get("target").node).inputs.get(this.get("target").port)}catch(e){Dataflow.log("node or port not found for edge",this)}this.source.connect(this),this.target.connect(this)}},isConnectedToPort:function(a){return this.source===a||this.target===a},isConnectedToNode:function(a){return this.source.parentNode===a||this.target.parentNode===a},toString:function(){return this.get("source").node+":"+this.get("source").port+"→"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target")}},bringToTop:function(){var a=0;this.parentGraph.edges.each(function(b){if(b!==this){var c=b.get("z");c>a&&(a=c),b.view&&b.view.unhighlight()}},this),this.set("z",a+1),this.collection.sort()},remove:function(){this.source.disconnect(this),this.target.disconnect(this),this.collection&&this.collection.remove(this)}}),a.Collection=Backbone.Collection.extend({model:a.Model,comparator:function(a){return a.get("z")}})}(Dataflow.module("edge")),function(a){var b='<div class="edges"><svg class="svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="nodes" /><div class="graph-controls" />',c=Dataflow.module("node"),d=Dataflow.module("edge");a.View=Backbone.View.extend({template:_.template(b),className:"graph",initialize:function(){this.$el.html(this.template(this.model.toJSON()));var a=this.model.get("nodes"),b=this.model.get("edges");this.nodes=a.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=b.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this);var c=this.model.get("parentNode");if(c){this.$(".graph-controls").text(c.get("label"));var d,e,f,g=function(a){return function(){return Dataflow.showGraph(a),!1}};while(c)d=c.get("parentGraph"),c=d.get("parentNode"),c?f=c.get("label"):f="main",e=$('<a href="#">').text(f).click(g(d)),this.$(".graph-controls").prepend(" / ").prepend(e)}},render:function(){var a=this;return _.defer(function(){a.rerenderEdges()},this),this},addNode:function(a){var b=Dataflow.nodes[a.type];if(b&&b.View)a.view=new b.View({model:a});else{var c=Dataflow.node("base");a.view=new c.View({model:a})}this.nodes[a.id]=a.view,a.view.render(),this.$(".nodes").append(a.view.el)},removeNode:function(a){a.view.remove(),this.nodes[a.id]=null,delete this.nodes[a.id]},addEdge:function(a){a.view=new d.View({model:a}),this.edges[a.id]=a.view,a.view.render(),this.$(".svg-edges")[0].appendChild(a.view.el)},removeEdge:function(a){a.view.remove(),this.edges[a.id]=null,delete this.edges[a.id]},rerenderEdges:function(){_.each(this.edges,function(a){a.render()},this)},sizeSVG:function(){try{var a=this.$(".svg-edges")[0],b=a.getBBox();a.setAttribute("width",Math.round(b.x+b.width+50)),a.setAttribute("height",Math.round(b.y+b.height+50))}catch(c){}}})}(Dataflow.module("graph")),function(a){var b='<div class="outer" /><h1 class="title"><%- id %>: <span class="label"><%- label %></span> <input class="label-edit" value="<%- label %>" type="text" /></h1><div class="controls"><button class="delete">delete</button><button class="save">save</button><button class="cancel">cancel</button></div><button class="edit">edit</button><div class="ports ins" /><div class="ports outs" /><div class="inner" />',c="",d=Dataflow.module("input"),e=Dataflow.module("output");a.View=Backbone.View.extend({template:_.template(b),innerTemplate:_.template(c),className:"node",events:function(){return{"click .title":"select","click .delete":"removeModel",dragstart:"dragStart",drag:"drag",dragstop:"dragStop","click .edit":"showControls","click .cancel":"hideControls","click .save":"saveLabel"}},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.type),this.inputs=this.model.inputs.view=new d.CollectionView({collection:this.model.inputs}),this.outputs=this.model.outputs.view=new e.CollectionView({collection:this.model.outputs});var a=this;this.$el.draggable({handle:"h1",helper:function(){var b=a.$el,c=b.width(),d=b.height();return $('<div class="node helper" style="width:'+c+"px; height:"+d+'px">')}}),this.$el.data("dataflow-node-view",this),this.$(".inner").append(this.innerTemplate)},render:function(){return this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$(".ins").html(this.inputs.el),this.$(".outs").html(this.outputs.el),this.$(".controls").hide(),this.$(".title .label-edit").hide(),this},_alsoDrag:[],_dragDelta:{},dragStart:function(a,b){this.$el.hasClass("ui-selected")||this.select(a);var c=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(c.el!==this){var a=$(this),b={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10)};a.data("ui-draggable-alsodrag-initial",b);var d=$('<div class="node helper">').css({width:a.width(),height:a.height(),left:b.left,top:b.top});a.parent().append(d),a.data("ui-draggable-alsodrag-helper",d),c._alsoDrag.push(a)}})},drag:function(a,b){if(this._alsoDrag.length){var c=$(a.target).data("draggable"),d=c.originalPosition,e={top:c.position.top-d.top||0,left:c.position.left-d.left||0};_.each(this._alsoDrag,function(a){var b=a.data("ui-draggable-alsodrag-initial"),c=a.data("ui-draggable-alsodrag-helper");c.css({left:b.left+e.left,top:b.top+e.top})})}},dragStop:function(a,b){var c=parseInt(b.position.left,10),d=parseInt(b.position.top,10);this.moveToPosition(c,d),this._alsoDrag.length&&(_.each(this._alsoDrag,function(a){var b=a.data("ui-draggable-alsodrag-initial"),c=a.data("ui-draggable-alsodrag-helper"),d=a.data("dataflow-node-view");d.moveToPosition(parseInt(c.css("left"),10),parseInt(c.css("top"),10)),c.remove(),a.data("ui-draggable-alsodrag-initial",null),a.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[])},moveToPosition:function(a,b){this.$el.css({left:a,top:b}),this.model.set({x:a,y:b})},showControls:function(){this.$(".title .label").hide(),this.$(".title .label-edit").show(),this.$(".edit").hide(),this.$(".controls").show()},hideControls:function(){this.$(".title .label-edit").hide(),this.$(".title .label").show(),this.$(".controls").hide(),this.$(".edit").show()},saveLabel:function(){var a=this.$(".title .label-edit").val();this.model.get("label")!==a&&(this.model.set("label",a),this.$(".title .label").text(a)),this.hideControls()},removeModel:function(){this.model.remove()},select:function(a){if(a){a.ctrlKey||a.metaKey?this.$el.toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$el.addClass("ui-selected"));var b=0;this.model.collection.each(function(a){var c=parseInt(a.view.el.style.zIndex,10);c>b&&(b=c)},this),this.el.style.zIndex=b+1}else this.$el.addClass("ui-selected")}})}(Dataflow.module("node")),function(a){var b=Dataflow.module("edge"),c='<span class="plug in" title="drag to edit wire"></span><span class="hole in" title="drag to make new wire"></span><span class="input-container in"></span><span class="label in" title="<%= description %>"><%= label %></span>';a.View=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port in",events:{click:"getTopEdge",drop:"connectEdge","dragstart .hole":"newEdgeStart","drag      .hole":"newEdgeDrag","dragstop  .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag      .plug":"changeEdgeDrag","dragstop  .plug":"changeEdgeStop","change .input-select":"inputSelect","change .input-int":"inputInt","change .input-float":"inputFloat","change .input-string":"inputString","change .input-boolean":"inputBoolean","click  .input-bang":"inputBang"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug in helper" />')},disabled:!0,distance:10,delay:100}),this.$(".hole").draggable({helper:function(){return $('<span class="plug out helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.in, .hole.out",activeClassType:"droppable-hover"});var b,c=this.model.get("type"),d=this.model.parentNode.get("state"),e=this.model.get("options");if(e!==undefined){var f;d&&d[this.model.id]!==undefined?f=d[this.model.id]:this.model.get("value")!==undefined&&(f=this.model.get("value")),typeof e=="string"&&(e=e.split(" "));if($.isArray(e)){var g={};for(var h=0;h<e.length;h++)g[e[h]]=e[h];e=g}b=$('<select class="input input-select">');for(var i in e){var j=$('<option value="'+e[i]+'">'+i+"</option>").data("val",e[i]);f&&e[i]===f&&j.prop("selected",!0),b.append(j)}}else if(c==="int"||c==="float"){var k={};this.model.get("min")!==undefined&&(k.min=this.model.get("min")),this.model.get("max")!==undefined&&(k.max=this.model.get("max")),c==="int"&&(k.step=1),b=$('<input type="number" class="input input-number">').attr(k).addClass(c==="int"?"input-int":"input-float"),d&&d[this.model.id]!==undefined?b.val(d[this.model.id]):this.model.get("value")!==undefined&&b.val(this.model.get("value"))}else c==="string"?(b=$('<input class="input input-string">'),d&&d[this.model.id]!==undefined?b.val(d[this.model.id]):this.model.get("value")!==undefined&&b.val(this.model.get("value"))):c==="boolean"?(b=$('<input type="checkbox" class="input input-boolean">'),d&&d[this.model.id]!==undefined?b.prop("checked",d[this.model.id]):this.model.get("value")!==undefined&&b.prop("checked",this.model.get("value"))):c==="bang"&&(b=$('<button class="input input-bang">!</button>'));b&&this.$(".input-container").append(b)},inputSelect:function(a){var b=$(a.target).find(":selected").data("val");this.model.parentNode.setState(this.model.id,b)},inputInt:function(a){this.model.parentNode.setState(this.model.id,parseInt($(a.target).val(),10))},inputFloat:function(a){this.model.parentNode.setState(this.model.id,parseFloat($(a.target).val()))},inputString:function(a){this.model.parentNode.setState(this.model.id,$(a.target).val())},inputBoolean:function(a){this.model.parentNode.setState(this.model.id,$(a.target).prop("checked"))},inputBang:function(){this.model.parentNode.setBang(this.model.id)},render:function(){return this},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdgeNew=new b.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeNewView=new b.View({model:this.previewEdgeNew});var d=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeNewView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeNewView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},getTopEdge:function(){var a;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(b){b.target===this.model&&(a=b),b.view&&b.view.unhighlight()},this),a&&a.view&&a.view.click()),a},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.getTopEdge();if(d){d.remove(),c.helper.data({port:d.source}),this.previewEdgeChange=new b.Model({source:d.get("source"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new b.View({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;this.model.parentNode.parentGraph.edges.add({id:c.parentNode.id+":"+c.id+"→"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:c.parentNode.id,port:c.id},target:{node:this.model.parentNode.id,port:this.model.id}}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)},holePosition:function(){return this.$(".hole").offset()},isConnected:!1,plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.target===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:a.View})}(Dataflow.module("input")),function(a){var b=Dataflow.module("edge"),c='<span class="label out" title="<%= description %>"><%= label %></span><span class="hole out" title="drag to make new wire"></span><span class="plug out" title="drag to edit wire"></span>';a.View=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port out",events:{click:"getTopEdge",drop:"connectEdge","dragstart .hole":"newEdgeStart","drag .hole":"newEdgeDrag","dragstop .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag .plug":"changeEdgeDrag","dragstop .plug":"changeEdgeStop"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug out helper" />')},disabled:!0,distance:10,delay:100}),this.$(".hole").draggable({helper:function(){return $('<span class="plug in helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.out, .hole.in",activeClassType:"droppable-hover"})},render:function(){return this},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdge=new b.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeView=new b.View({model:this.previewEdge});var d=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},getTopEdge:function(){var a;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(b){b.source===this.model&&(a=b),b.view&&b.view.unhighlight()},this),a&&a.view&&a.view.click()),a},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.getTopEdge();if(d){d.remove(),c.helper.data({port:d.target}),this.previewEdgeChange=new b.Model({target:d.get("target"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new b.View({model:this.previewEdgeChange});var e=this.model.parentNode.parentGraph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.parentNode.parentGraph.edges.length;this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"→"+c.parentNode.id+":"+c.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:c.parentNode.id,port:c.id}}),b.helper.data("removeChangeEdge",d<this.model.parentNode.parentGraph.edges.length)},holePosition:function(){return this.$(".hole").offset()},plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.parentNode.parentGraph.edges.some(function(a){return a.source===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:a.View})}(Dataflow.module("output")),function(a){var b=function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)d==="xlink:href"?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c};a.View=Backbone.View.extend({tagName:"div",className:"edge",positions:null,initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("change:x change:y change:w",this.render,this),this.model.target&&this.model.target.parentNode.on("change:x change:y",this.render,this),this.model.source&&this.model.source.view.plugSetActive(),this.model.target&&this.model.target.view.plugSetActive(),this.el=b("g",{"class":"edge"}),this.elEdge=b("path",{"class":"edge-wire"}),this.elShadow=b("path",{"class":"edge-shadow"}),this.el.appendChild(this.elShadow),this.el.appendChild(this.elEdge);var a=this;this.el.addEventListener("click",function(b){a.click(b)})},render:function(a){var b=this.model.source,c=this.model.target;b?this.positions.from=b.view.holePosition():this.positions.from=a,c?this.positions.to=c.view.holePosition():this.positions.to=a;var d=this.edgePath(this.positions);this.elEdge.setAttribute("d",d),this.elShadow.setAttribute("d",d),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},fade:function(){this.el.setAttribute("class","edge fade")},unfade:function(){this.el.setAttribute("class","edge")},highlight:function(){this.el.setAttribute("class","edge highlight")},unhighlight:function(){this.el.setAttribute("class","edge")},edgePath:function(a){return"M "+a.from.left+" "+a.from.top+" L "+(a.from.left+50)+" "+a.from.top+" L "+(a.to.left-50)+" "+a.to.top+" L "+a.to.left+" "+a.to.top},remove:function(){var a=this.model.source,b=this.model.target;a&&a.parentNode.off(null,null,this),b&&b.parentNode.off(null,null,this),a&&a.view.plugCheckActive(),b&&b.view.plugCheckActive(),this.el.parentNode.removeChild(this.el)},click:function(a){this.highlight(),this.bringToTop()},bringToTop:function(){this.model.bringToTop();var a=this.el.parentNode;a&&(a.removeChild(this.el),a.appendChild(this.el))}})}(Dataflow.module("edge")),function(a){var b=a.module("node"),c=a.node("base");c.Model=b.Model.extend({defaults:function(){return{label:"",type:"base",x:200,y:100,state:{}}},initialize:function(){b.Model.prototype.initialize.call(this)},unload:function(){},inputs:[],outputs:[]}),c.View=b.View.extend({})}(Dataflow),function(a){var b=a.node("base"),c=a.node("base-resizable");c.Model=b.Model.extend({defaults:function(){var a=b.Model.prototype.defaults.call(this);return a.type="base-resizable",a.w=200,a.h=200,a},initialize:function(){b.Model.prototype.initialize.call(this)},unload:function(){},toJSON:function(){var a=b.Model.prototype.toJSON.call(this);return a.w=this.get("w"),a.h=this.get("h"),a},inputs:[],outputs:[]}),c.View=b.View.extend({initialize:function(){b.View.prototype.initialize.call(this),this.$el.css({width:this.model.get("w"),height:this.model.get("h")});var a=this;this.$el.resizable({helper:"node helper",stop:function(b,c){a.resizeStop(b,c)}})},resizeStop:function(a,b){this.model.set({w:b.size.width,h:b.size.height})}})}(Dataflow),function(a){var b=a.node("base-resizable"),c=a.node("test");c.Model=b.Model.extend({defaults:function(){var a=b.Model.prototype.defaults.call(this);return a.type="test",a.w=200,a.h=400,a},inputinput:function(a){this.view.$(".inner").text(a)},inputstring:function(a){this.send("output",a)},inputint:function(a){this.send("output",a)},inputfloat:function(a){this.send("output",a)},inputs:[{id:"input",type:"all"},{id:"string",type:"string"},{id:"int",type:"int"},{id:"float",type:"float"},{id:"boolean",type:"boolean"},{id:"bang",type:"bang"},{id:"select",type:"string",options:"January February March April",value:"April"},{id:"select2",type:"int",min:0,max:3,options:{sine:0,square:1,saw:2,triangle:3}}],outputs:[{id:"output",type:"all"}]}),c.View=b.View.extend({initialize:function(){b.View.prototype.initialize.call(this),this.$(".inner").text("the node view .inner div can be used for info, ui, etc...")}})}(Dataflow),function(a){var b=a.node("base"),c=a.node("dataflow-input");c.Model=b.Model.extend({defaults:{label:"",type:"dataflow-input",x:200,y:100,"input-type":"all"},initialize:function(){this.get("label")===""&&this.set({label:"input"+this.id}),b.Model.prototype.initialize.call(this)},toJSON:function(){var a=b.Model.prototype.toJSON.call(this);return a["input-type"]=this.get("input-type"),a},inputs:[],outputs:[{id:"data",type:"all"}]})}(Dataflow),function(a){var b=a.node("base"),c=a.node("dataflow-output");c.Model=b.Model.extend({defaults:{label:"",type:"dataflow-output",x:200,y:100,"output-type":"all"},initialize:function(){this.get("label")===""&&this.set({label:"output"+this.id}),b.Model.prototype.initialize.call(this)},toJSON:function(){var a=b.Model.prototype.toJSON.call(this);return a["output-type"]=this.get("output-type"),a},inputs:[{id:"data",type:"all"}],outputs:[]})}(Dataflow),function(a){var b=a.node("base-resizable"),c=a.node("dataflow-subgraph"),d=a.module("graph"),e=a.module("input"),f=a.module("output");c.Model=b.Model.extend({defaults:{label:"subgraph",type:"dataflow-subgraph",x:200,y:100,graph:{nodes:[{id:"1",label:"in",type:"dataflow-input",x:180,y:15},{id:"99",label:"out",type:"dataflow-output",x:975,y:500}]}},initialize:function(){b.Model.prototype.initialize.call(this);var a=this.get("graph");a.parentNode=this,this.graph=new d.Model(a);var c=this.graph.nodes.filter(function(a){return a.type==="dataflow-input"});_.each(c,this.addInput,this);var e=this.graph.nodes.filter(function(a){return a.type==="dataflow-output"});_.each(e,this.addOutput,this),this.graph.nodes.on("add",function(a){a.type==="dataflow-input"?this.addInput(a):a.type==="dataflow-output"&&this.addOutput(a)},this),this.graph.nodes.on("remove",function(a){a.type==="dataflow-input"?this.removeInput(a):a.type==="dataflow-output"&&this.removeOutput(a)},this)},addInput:function(a){var b=new e.Model({id:a.id,label:a.get("label"),type:a.get("input-type"),parentNode:this,inputNode:a});this.inputs.add(b)},addOutput:function(a){var b=new f.Model({id:a.id,label:a.get("label"),type:a.get("output-type"),parentNode:this,outputNode:a});this.outputs.add(b)},removeInput:function(a){var b=this.inputs.get(a.id);b.remove(),this.inputs.remove(b)},removeOutput:function(a){var b=this.outputs.get(a.id);b.remove(),this.outputs.remove(b)},toJSON:function(){var a=b.Model.prototype.toJSON.call(this);return a.graph=this.graph,a},remove:function(){b.Model.prototype.remove.call(this),this.graph.remove()},inputs:[],outputs:[]});var g='<button class="show-subgraph">edit subgraph</button>';c.View=b.View.extend({events:function(){var a=b.View.prototype.events.call(this);return a["click .show-subgraph"]="showSubgraph",a},innerTemplate:_.template(g),initialize:function(){b.View.prototype.initialize.call(this),this.model.graph.view=new d.View({model:this.model.graph}),this.model.inputs.each(this.addInput,this),this.model.inputs.on("add",this.addInput,this),this.model.outputs.each(this.addOutput,this),this.model.outputs.on("add",this.addOutput,this)},addInput:function(a){a.get("inputNode").on("change:label",function(b){a.view.$(".label").text(b.get("label"))},this)},addOutput:function(a){a.get("outputNode").on("change:label",function(b){a.view.$(".label").text(b.get("label"))},this)},showSubgraph:function(){a.showGraph(this.model.graph)}})}(Dataflow),function(a){function c(){a.currentGraph.view.$(".node").addClass("ui-selected")}function d(){f(),_.each(e.nodes,function(a){a.x-=50,a.y-=50});var b=a.currentGraph.nodes.filter(function(a){return a.view.$el.hasClass("ui-selected")});_.each(b,function(a){a.remove()})}function f(){e={},e.nodes=[],a.currentGraph.nodes.each(function(a){a.view.$el.hasClass("ui-selected")&&e.nodes.push(JSON.parse(JSON.stringify(a)))}),e.edges=[],a.currentGraph.edges.each(function(a){var b=_.any(e.nodes,function(b){return a.source.parentNode.id===b.id}),c=_.any(e.nodes,function(b){return a.target.parentNode.id===b.id});b&&c&&e.edges.push(JSON.parse(JSON.stringify(a)))})}function g(){e&&e.nodes.length>0&&(a.currentGraph.view.$(".node").removeClass("ui-selected"),_.each(e.nodes,function(b){b.x+=50,b.y+=50,b.parentGraph=a.currentGraph;var c=b.id;while(a.currentGraph.nodes.get(b.id))b.id++;c!==b.id&&_.each(e.edges,function(a){a.source.node===c&&(a.source.node=b.id),a.target.node===c&&(a.target.node=b.id)});var d=new a.nodes[b.type].Model(b);a.currentGraph.nodes.add(d),d.view.select()}),_.each(e.edges,function(b){b=JSON.parse(JSON.stringify(b)),b.parentGraph=a.currentGraph,b.id=b.source.node+":"+b.source.port+"→"+b.target.node+":"+b.target.port;var c=new a.modules.edge.Model(b);a.currentGraph.edges.add(c)})),_.defer(function(){a.currentGraph.view.rerenderEdges()})}var b=$('<div class="dataflow-plugin-edit"><button class="selectall">Select All (A)</button><br /><button class="cut">Cut (X)</button><br /><button class="copy">Copy (C)</button><br /><button class="paste">Paste (V)</button><br /></div>');a.addPlugin("edit",b),b.children(".selectall").click(c),b.children(".cut").click(d);var e={};b.children(".copy").click(f),b.children(".paste").click(g)}(Dataflow),function(a){var b=$('<ul class="dataflow-plugin-library" style="list-style:none; padding-left:0" />'),c=function(b,c,d){return function(){a.currentGraph.view.$(".node").removeClass("ui-selected");var e=1;while(a.currentGraph.nodes.get(e))e++;c===undefined&&(c=window.scrollX-100+Math.floor($(window).width()/2)),d===undefined&&(d=window.scrollY-100+Math.floor($(window).height()/2));var f=new b.Model({id:e,x:c,y:d,parentGraph:a.currentGraph});a.currentGraph.nodes.add(f),f.view.select()}},d=function(d){d=d?d:{},d.exclude=d.exclude?d.exclude:["base","base-resizable"],b.empty(),_.each(a.nodes,function(a,e){if(d.exclude.indexOf(e)===-1){var f=$('<a class="button">+</a>').attr("title","click or drag").draggable({helper:function(){return $('<div class="node helper" style="width:100px; height:100px">'+e+"</div>")},stop:function(b,d){c(a,d.position.left,d.position.top).call()}}).click(c(a)),g=$("<li />").append(f).append(e);b.append(g)}})};d(),a.addPlugin("library",b),a.plugins.library.update=d}(Dataflow),function(a){var b=$('<form class="dataflow-plugin-view-source" style="width: 330px;"><textarea class="code" style="width: 100%; height: 400px;"></textarea><br/><input class="apply" type="submit" value="apply changes" /></form>'),c=b.children(".code");a.addPlugin("view source",b),a.on("change",function(b){if(a.graph){var d=c.prop("scrollTop");c.val(JSON.stringify(a.graph.toJSON(),null,"  ")),c.scrollTop(d)}}),b.submit(function(){var b;try{b=JSON.parse(c.val())}catch(d){return a.log("Invalid JSON"),!1}if(b){var e=a.loadGraph(b);e.trigger("change")}return!1})}(Dataflow),function(a){function c(a){a=_.escape(a),b.children(".loglist").append("<li>"+a+"</li>"),b.scrollTop(b.prop("scrollHeight"))}var b=$('<div class="dataflow-plugin-log" style="width:400px; height: 250px; overflow: auto;"><ol class="loglist"></ol></div>');a.addPlugin("log",b),a.on("log",function(a){c("log: "+a)}),a.on("node:add",function(a,b){c("node added: "+b.toString())}),a.on("node:remove",function(a,b){c("node removed: "+b.toString())}),a.on("edge:add",function(a,b){c("edge added: "+b.toString())}),a.on("edge:remove",function(a,b){c("edge removed: "+b.toString())})}(Dataflow);