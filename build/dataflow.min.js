/*! dataflow.js - v0.0.1 - 2012-10-19
* https://github.com/meemoo/dataflow
* Copyright (c) 2012 Forrest Oliphant; Licensed MIT, GPL */
(function(){var a=Backbone.Model.extend({modules:{},module:function(a){return this.modules[a]?this.modules[a]:this.modules[a]={Views:{}}},nodes:{},node:function(a){return this.nodes[a]?this.nodes[a]:this.nodes[a]={Views:{}}},loadGraph:function(a){this.graph&&this.graph.remove();var b=this.module("graph"),c=new b.Model(a);return c.view=new b.Views.Main({model:c}),$("#app").html(c.view.render().el),this.graph=c,c}});window.Dataflow=new a})(),jQuery(function(a){var b=Backbone.Router.extend({routes:{"":"index"},index:function(){}});Dataflow.router=new b,Backbone.history.start()}),function(a){var b=Dataflow.module("node"),c=Dataflow.module("edge");a.Model=Backbone.Model.extend({initialize:function(){var a,d=this.nodes=new b.Collection;d.graph=this,d.on("all",function(){this.trigger("change")},this),d.on("add",function(a){Dataflow.trigger("node:add",this,a)},this),d.on("remove",function(a){a.remove(),Dataflow.trigger("node:remove",this,a)},this);var e=this.get("nodes");for(a=0;a<e.length;a++){var f=e[a];f.graph=this,f=new b.Model(f),d.add(f)}var g=this.edges=new c.Collection;g.graph=this,g.on("all",function(){this.trigger("change")},this),g.on("add",function(a){Dataflow.trigger("edge:add",this,a)},this),g.on("remove",function(a){Dataflow.trigger("edge:remove",this,a)},this);var h=this.get("edges");for(a=0;a<h.length;a++){var i=h[a];i.graph=this,i.id=i.source.node+":"+i.source.port+"→"+i.target.node+":"+i.target.port,i=new c.Model(i),g.add(i)}this.set({nodes:d,edges:g}),this.on("change",function(){Dataflow.trigger("change",this)},this)},remove:function(){while(this.nodes.length>0)this.nodes.remove(this.nodes.at(0))}})}(Dataflow.module("graph")),function(a){var b=Dataflow.module("input"),c=Dataflow.module("output");a.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100},initialize:function(){this.graph=this.get("graph"),this.type=this.get("type");var a=this.inputs;this.inputs=new b.Collection,this.inputs.node=this;for(var c=0;c<a.length;c++){var d=a[c];d.node=this,d=new b.Model(d),this.inputs.add(d)}var e=this.outputs;this.outputs=new b.Collection,this.outputs.node=this;for(c=0;c<e.length;c++){var f=e[c];f.node=this,f=new b.Model(f),this.outputs.add(f)}},remove:function(){var a=this.graph.edges.filter(function(a){return a.isConnectedToNode(this)},this);for(var b=0;b<a.length;b++){var c=a[b];c.collection.remove(c)}this.unload()},unload:function(){},toString:function(){return this.id},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y")}},inputs:[{id:"input"}],outputs:[{id:"output"}]}),a.Collection=Backbone.Collection.extend({model:a.Model,comparator:function(a){return a.get("x")}})}(Dataflow.module("node")),function(a){a.Model=Backbone.Model.extend({defaults:{id:"output",type:"all"},initialize:function(){this.node=this.get("node")}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("input")),function(a){a.Model=Backbone.Model.extend({defaults:{id:"output",type:"all"},initialize:function(){this.node=this.get("node")}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("output")),function(a){a.Model=Backbone.Model.extend({initialize:function(){var a,b=this.get("preview");if(b){a=this.get("graph").nodes;var c=this.get("source"),d=this.get("target");c&&(this.source=a.get(this.get("source").node).outputs.get(this.get("source").port)),d&&(this.target=a.get(this.get("target").node).inputs.get(this.get("target").port))}else this.graph=this.get("graph"),a=this.graph.nodes,this.source=a.get(this.get("source").node).outputs.get(this.get("source").port),this.target=a.get(this.get("target").node).inputs.get(this.get("target").port)},isConnectedToNode:function(a){return this.source.node===a||this.target.node===a},toString:function(){return this.get("source").node+":"+this.get("source").port+"→"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target")}}}),a.Collection=Backbone.Collection.extend({model:a.Model})}(Dataflow.module("edge")),function(a){var b='<div class="edges"><svg class="svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="nodes" />',c=Dataflow.module("node"),d=Dataflow.module("edge");a.Views.Main=Backbone.View.extend({template:_.template(b),className:"graph",initialize:function(){var a=this.model.get("nodes"),b=this.model.get("edges");this.nodes=a.view=new c.Views.Collection({collection:a}),this.edges=b.view=new d.Views.Collection({collection:b})},render:function(){this.$el.html(this.template(this.model.toJSON()));var a=this.model.get("nodes");a.view.render(),a.view.renderAllItems(),this.$(".nodes").html(a.view.el);var b=this.model.get("edges");b.view.render(),b.view.renderAllItems();var c=this;return _.defer(function(){c.rerenderEdges()},this),this},rerenderEdges:function(){_.each(this.edges.viewsByCid,function(a){a.render()},this)}})}(Dataflow.module("graph")),function(a){var b='<h1><%= id %>: <%= label %></h1><div class="controls"><button class="delete">delete</button></div><div class="ports ins" /><div class="ports outs" />',c=Dataflow.module("input"),d=Dataflow.module("output");a.Views.Main=Backbone.View.extend({template:_.template(b),className:"node",events:{"click .delete":"deleteMe",dragstop:"dragStop"},initialize:function(){this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.model.inputs.view=new c.Views.Collection({collection:this.model.inputs}),this.model.inputs.view.render(),this.model.inputs.view.renderAllItems(),this.inputs=this.model.inputs.view,this.model.outputs.view=new d.Views.Collection({collection:this.model.outputs}),this.model.outputs.view.render(),this.model.outputs.view.renderAllItems(),this.outputs=this.model.outputs.view;var a=this;this.$el.draggable({helper:function(){var b=a.$el,c=b.width(),d=b.height();return $('<div class="node helper" style="width:'+c+"px; height:"+d+'px">')}})},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$(".ins").html(this.inputs.el),this.$(".outs").html(this.outputs.el),this},dragStop:function(a,b){var c=parseInt(b.position.left,10),d=parseInt(b.position.top,10);this.$el.css({left:c,top:d}),this.model.set({x:c,y:d}),this.model.collection.sort({silent:!0}),this.model.trigger("move",this.model)},deleteMe:function(){this.model.collection.remove(this.model)}}),a.Views.Collection=Backbone.CollectionView.extend({itemView:a.Views.Main})}(Dataflow.module("node")),function(a){var b=Dataflow.module("edge"),c='<span class="plug in" title="drag to edit wire"></span><span class="hole in" title="drag to make new wire"></span><span class="label in"><%= id %></span>';a.Views.Main=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port in",events:{"dragstart .hole":"newEdgeStart","drag      .hole":"newEdgeDrag","dragstop  .hole":"newEdgeStop","click     .plug":"highlightEdge","dragstart .plug":"changeEdgeStart","drag      .plug":"changeEdgeDrag","dragstop  .plug":"changeEdgeStop",drop:"connectEdge"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug in helper" />')},disabled:!0}),this.$(".hole").draggable({helper:function(){return $('<span class="plug out helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.in, .hole.out",activeClassType:"droppable-hover"})},render:function(){},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdgeNew=new b.Model({target:{node:this.model.node.id,port:this.model.id},graph:this.model.node.graph,preview:!0}),this.previewEdgeNewView=new b.Views.Main({model:this.previewEdgeNew});var d=this.model.node.graph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeNewView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeNewView.render(b.offset),this.model.node.graph.edges.view.sizeSvg()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},highlightEdge:function(){!this.isConnected},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.model.node.graph.edges.find(function(a){return a.target===this.model},this);if(d){this.changeEdge=d,c.helper.data({port:d.source}),this.previewEdgeChange=new b.Model({source:d.get("source"),graph:this.model.node.graph,preview:!0}),this.previewEdgeChangeView=new b.Views.Main({model:this.previewEdgeChange});var e=this.model.node.graph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.node.graph.edges.view.sizeSvg())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),this.changeEdge&&(b.helper.data("removeChangeEdge")&&this.changeEdge.collection.remove(this.changeEdge),this.changeEdge=null),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.node.graph.edges.length;this.model.node.graph.edges.add({id:c.node.id+":"+c.id+"→"+this.model.node.id+":"+this.model.id,graph:this.model.node.graph,source:{node:c.node.id,port:c.id},target:{node:this.model.node.id,port:this.model.id}}),b.helper.data("removeChangeEdge",d<this.model.node.graph.edges.length)},holePosition:function(){return this.$(".hole").offset()},isConnected:!1,plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.node.graph.edges.some(function(a){return a.target===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.Views.Collection=Backbone.CollectionView.extend({tagName:"ul",itemView:a.Views.Main})}(Dataflow.module("input")),function(a){var b=Dataflow.module("edge"),c='<span class="label out"><%= id %></span><span class="hole out" title="drag to make new wire"></span><span class="plug out" title="drag to edit wire"></span>';a.Views.Main=Backbone.View.extend({template:_.template(c),tagName:"li",className:"port out",events:{"dragstart .hole":"newEdgeStart","drag .hole":"newEdgeDrag","dragstop .hole":"newEdgeStop","dragstart .plug":"changeEdgeStart","drag .plug":"changeEdgeDrag","dragstop .plug":"changeEdgeStop",drop:"connectEdge"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type"));var a=this;this.$(".plug").draggable({helper:function(){return $('<span class="plug out helper" />')},disabled:!0}),this.$(".hole").draggable({helper:function(){return $('<span class="plug in helper" />').data({port:a.model})}}),this.$el.droppable({accept:".plug.out, .hole.in",activeClassType:"droppable-hover"})},render:function(){},newEdgeStart:function(a,c){a.stopPropagation(),this.previewEdge=new b.Model({source:{node:this.model.node.id,port:this.model.id},graph:this.model.node.graph,preview:!0}),this.previewEdgeView=new b.Views.Main({model:this.previewEdge});var d=this.model.node.graph.view.$(".svg-edges")[0];d.appendChild(this.previewEdgeView.el)},newEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeView.render(b.offset),this.model.node.graph.edges.view.sizeSvg()},newEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},changeEdgeStart:function(a,c){a.stopPropagation();if(this.isConnected){var d=this.model.node.graph.edges.find(function(a){return a.source===this.model},this);if(d){this.changeEdge=d,c.helper.data({port:d.target}),this.previewEdgeChange=new b.Model({target:d.get("target"),graph:this.model.node.graph,preview:!0}),this.previewEdgeChangeView=new b.Views.Main({model:this.previewEdgeChange});var e=this.model.node.graph.view.$(".svg-edges")[0];e.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(b.offset),this.model.node.graph.edges.view.sizeSvg())},changeEdgeStop:function(a,b){a.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),this.changeEdge&&(b.helper.data("removeChangeEdge")&&this.changeEdge.collection.remove(this.changeEdge),this.changeEdge=null),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(a,b){var c=b.helper.data("port"),d=this.model.node.graph.edges.length;this.model.node.graph.edges.add({id:this.model.node.id+":"+this.model.id+"→"+c.node.id+":"+c.id,graph:this.model.node.graph,source:{node:this.model.node.id,port:this.model.id},target:{node:c.node.id,port:c.id}}),b.helper.data("removeChangeEdge",d<this.model.node.graph.edges.length)},holePosition:function(){return this.$(".hole").offset()},plugSetActive:function(){this.$(".plug").draggable("enable"),this.$(".plug").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var a=this.model.node.graph.edges.some(function(a){return a.source===this.model},this);a||(this.$(".plug").draggable("disable"),this.$(".plug").removeClass("active"),this.isConnected=!1)}}),a.Views.Collection=Backbone.CollectionView.extend({tagName:"ul",itemView:a.Views.Main})}(Dataflow.module("output")),function(a){var b=function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)d==="xlink:href"?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c};a.Views.Main=Backbone.View.extend({tagName:"div",className:"edge",positions:null,initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.node.on("move",this.render,this),this.model.target&&this.model.target.node.on("move",this.render,this),this.model.source&&this.model.source.view.plugSetActive(),this.model.target&&this.model.target.view.plugSetActive(),this.el=b("path",{}),this.$el=$(this.el);if(this.model.graph){var a=this;_.defer(function(){a.model.graph.view.$(".svg-edges")[0].appendChild(a.el)},this)}},render:function(a){this.model.source?this.positions.from=this.model.source.view.holePosition():this.positions.from=a,this.model.target?this.positions.to=this.model.target.view.holePosition():this.positions.to=a,this.el.setAttribute("d",this.edgePath(this.positions)),this.model.collection&&this.model.collection.view.sizeSvg()},edgePath:function(a){return"M "+a.from.left+" "+a.from.top+" L "+(a.from.left+50)+" "+a.from.top+" L "+(a.to.left-50)+" "+a.to.top+" L "+a.to.left+" "+a.to.top},remove:function(){this.model.source&&this.model.source.node.off("move",this.render,this),this.model.target&&this.model.target.node.off("move",this.render,this),this.model.source&&this.model.source.view.plugCheckActive(),this.model.target&&this.model.target.view.plugCheckActive(),this.$el.remove()}}),a.Views.Collection=Backbone.CollectionView.extend({itemView:a.Views.Main,sizeSvg:function(){try{var a=this.collection.graph.view.$(".svg-edges")[0],b=a.getBBox();a.setAttribute("width",Math.round(b.x+b.width+50)),a.setAttribute("height",Math.round(b.y+b.height+50))}catch(c){}}})}(Dataflow.module("edge"));