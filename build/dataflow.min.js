/*! dataflow.js - v0.0.7 - 2013-10-02 (12:25:39 AM GMT+0300)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, GPL */
(function(){var e=Backbone.Model.extend({$:function(e){return this.$el.find(e)},initialize:function(){this.el=document.createElement("div"),this.el.className="dataflow",this.$el=$(this.el),this.$el.data("dataflow",this);var e=Dataflow.prototype.module("card");if(this.shownCards=new e.Collection,this.shownCards.view=new e.CollectionView({collection:this.shownCards}),this.$el.append(this.shownCards.view.$el),this.debug=this.get("debug"),this.controls=this.get("controls"),this.controls!==!1&&(this.controls=!0),this.controls)for(var t in this.plugins)this.plugins[t].initialize&&this.plugins[t].initialize(this);this.inputs=this.get("inputs"),this.inputs!==!1&&(this.inputs=!0),this.editable=this.get("editable"),this.editable!==!1&&(this.editable=!0);var o=this.get("appendTo");o=o?o:"body","body"===o&&$("html, body").css({margin:"0px",padding:"0px",width:"100%",height:"100%"}),$(o).append(this.el),this.id||(this.id=$(o).attr("id")),this.loadState()},modules:{},module:function(e){return this.modules[e]?this.modules[e]:(this.modules[e]={},this.modules[e])},nodes:{},node:function(e){return this.nodes[e]?this.nodes[e]:(this.nodes[e]={description:""},this.nodes[e])},plugins:{},plugin:function(e){return this.plugins[e]?this.plugins[e]:(this.plugins[e]={},this.plugins[e])},addCard:function(e,t){t||this.hideCards(),this.shownCards.get(e)?this.shownCards.view.bringToTop(e):this.shownCards.add(e)},removeCard:function(e){this.shownCards.remove(e)},hideCards:function(){var e=this.shownCards.where({pinned:!1});this.shownCards.remove(e)},addPlugin:function(e){var t=this.plugins[e.id];if(t||(this.plugins[e.id]=t={}),t.info=e,t.enabled=!0,e.menu){var o=Dataflow.prototype.module("card"),i=new o.Model({dataflow:this,card:{el:e.menu},pinned:e.pinned?!0:!1});t.card=i,this.plugins.menu.addPlugin({id:e.id,icon:e.icon,label:e.name,showLabel:!1})}},showPlugin:function(e){this.plugins[e]&&this.plugins[e].card&&(this.addCard(this.plugins[e].card),"function"==typeof this.plugins[e].onShow&&this.plugins[e].onShow())},enablePlugin:function(e){var t=this.plugins[e];t&&this.addPlugin(t.info)},disablePlugin:function(e){this.plugins.menu.disablePlugin(e)},showContextBar:function(){this.contextBar.view.$el.show()},hideContextBar:function(){this.contextBar.view.$el.hide()},contexts:{},prepareContext:function(e){if(this.contexts[e])return this.contexts[e];var t=this.module("menucard");return this.contexts[e]=new t.Model({id:"context-"+e,dataflow:this,pinned:!0}),this.contexts[e].view=new t.View({model:this.contexts[e]}),this.contexts[e]},addContext:function(e){_.each(e.contexts,function(t){var o=this.prepareContext(t);o.menu.add(e)},this)},changeContext:function(e,t){var o=function(e,t){this.contexts[e]&&(this.contexts[e].set("label",t),this.shownCards.get("context-"+e)||this.shownCards.add(this.contexts[e]))}.bind(this),i=function(e){this.shownCards.get("context-"+e)&&this.shownCards.remove("context-"+e)}.bind(this);e.length>1?(o("nodes",e.length+" nodes"),i("node")):1===e.length?(o("node",e[0].get("label")),i("nodes")):(i("node"),i("nodes")),t.length>1?(o("edges",t.length+" edges"),i("edge")):1===t.length?(o("edge",t[0].id),i("edges")):(i("edge"),i("edges"))},loadGraph:function(e){this.graph&&(this.currentGraph.view&&this.currentGraph.view.remove(),this.graph.view&&this.graph.view.remove(),this.graph.remove());var t=this.module("graph");e.dataflow=this;var o=new t.Model(e);return o.view=new t.View({model:o}),this.$el.append(o.view.render().el),this.graph=this.currentGraph=o,o},showGraph:function(e){this.currentGraph.view.$el.detach(),this.$el.append(e.view.el),e.view.render(),this.currentGraph=e},debug:!1,log:function(e){this.trigger("log",e,arguments),this.debug&&console.log("Dataflow: ",arguments)},types:["all","canvas:2d","canvas:webgl","string","number","int","object","array"]});window.Dataflow=e,"object"==typeof exports&&(exports.Dataflow=e),Backbone.View.prototype.addEvents=function(e){this.delegateEvents(_.extend(_.clone(this.events),e))},Backbone.CollectionView=Backbone.Model.extend({prepend:!1,initialize:function(e){e.tagName&&(this.tagName=e.tagName),e.className&&(this.className=e.className),e.itemView&&(this.itemView=e.itemView),this.el=document.createElement(this.tagName),this.el.className=this.className,this.$el=$(this.el),this.parent=e.parent;var t=this.collection=this.get("collection");t.each(this.addItem,this),t.on("add",this.addItem,this),t.on("remove",this.removeItem,this)},addItem:function(e){e.view||(e.view=new this.itemView({model:e,parent:this.parent}),e.view.render()),this.prepend?this.$el.prepend(e.view.el):this.$el.append(e.view.el)},removeItem:function(e){e.view.remove()}})})(),function(e){var t=Backbone.Model.extend({});e.prototype.loadState=function(){var e="dataflow-"+(this.id?this.id:this.cid),o=JSON.parse(window.localStorage.getItem(e));o||(o={});var i=new t(o);this.set("state",i),i.on("change",function(t){window.localStorage.setItem(e,JSON.stringify(t.toJSON()))})}}(Dataflow),function(e){var t=e.prototype.module("graph"),o=e.prototype.module("node"),i=e.prototype.module("edge");t.Model=Backbone.Model.extend({defaults:{nodes:[],edges:[],panX:0,panY:0,zoom:1},initialize:function(){this.dataflow=this.get("dataflow");var e,t=this.nodes=new o.Collection;t.parentGraph=this,t.on("all",function(){this.trigger("change")},this),t.on("add",function(e){this.dataflow.trigger("node:add",this,e)},this),t.on("remove",function(e){e.remove(),this.dataflow.trigger("node:remove",this,e)},this);var n=this.get("nodes");for(e=0;n.length>e;e++){var a=n[e];a.parentGraph=this,a.type&&this.dataflow.nodes[a.type]?(a=new this.dataflow.nodes[a.type].Model(a),t.add(a)):this.dataflow.log("node "+a.id+" not added: node type ("+a.type+") not found",a)}var s=this.edges=new i.Collection;s.parentGraph=this,s.on("all",function(){this.trigger("change")},this),s.on("add",function(e){this.dataflow.trigger("edge:add",this,e)},this),s.on("remove",function(e){this.dataflow.trigger("edge:remove",this,e)},this);var d=this.get("edges");for(e=0;d.length>e;e++){var r=d[e];r.parentGraph=this,r.id=r.source.node+":"+r.source.port+"::"+r.target.node+":"+r.target.port;var l=t.get(r.source.node),h=t.get(r.target.node);l&&h&&l.outputs.get(r.source.port)&&h.inputs.get(r.target.port)?(r=new i.Model(r),s.add(r)):this.dataflow.log("edge "+r.id+" not added: node or port not found",r)}this.set({nodes:t,edges:s}),this.on("selectionChanged",this.selectionChanged,this),this.on("select:node",this.selectNode,this),this.on("select:edge",this.selectEdge,this),this.on("change",function(){this.dataflow.trigger("change",this)},this)},selectNode:function(e){this.dataflow.trigger("select:node",this,e)},selectEdge:function(e){this.dataflow.trigger("select:edge",this,e)},selectionChanged:function(){var e=this.nodes.where({selected:!0}),t=this.edges.where({selected:!0});this.dataflow.changeContext(e,t)},remove:function(){for(;this.nodes.length>0;)this.nodes.remove(this.nodes.at(this.nodes.length-1))},toJSON:function(){return{nodes:this.nodes,edges:this.edges}}})}(Dataflow),function(e){var t=e.prototype.module("node"),o=e.prototype.module("input"),i=e.prototype.module("output");t.Model=Backbone.Model.extend({defaults:function(){return{label:"",description:"",type:"test",x:200,y:100,state:{},selected:!1}},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type"),""===this.get("label")&&this.set({label:this.get("type")});var e=this.inputs;this.inputs=new o.Collection,this.inputs.parentNode=this;for(var t=0;e.length>t;t++){var n=e[t],a=this.get("state");void 0!==n.value&&void 0===a[n.id]&&(a[n.id]=n.value),n.parentNode=this,n=new o.Model(n),this.inputs.add(n)}var s=this.outputs;for(this.outputs=new i.Collection,this.outputs.parentNode=this,t=0;s.length>t;t++){var d=s[t];d.parentNode=this,d=new i.Model(d),this.outputs.add(d)}this.on("change:selected",this.changeSelected,this)},changeSelected:function(){this.get("selected")&&this.parentGraph.trigger("select:node",this)},setState:function(e,t){var o=this.get("state");o[e]!==t&&(o[e]=t,this["input"+e]&&this["input"+e](t),this.trigger("change:state",e,t))},setBang:function(e){this["input"+e]&&this["input"+e](),this.trigger("bang",e)},send:function(e,t){var o=this;_.defer(function(){o.trigger("send:"+e,t)})},recieve:function(e,t){"function"==typeof this["input"+e]?this["input"+e](t):this["_"+e]=t},remove:function(){this.inputs.each(function(e){e.remove()}),this.outputs.each(function(e){e.remove()}),this.unload(),this.collection.remove(this)},unload:function(){},toString:function(){return this.id+" ("+this.type+")"},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y"),state:this.get("state")}},inputs:[],outputs:[]}),t.Collection=Backbone.Collection.extend({model:t.Model,comparator:function(e){return e.get("x")}})}(Dataflow),function(e){var t=e.prototype.module("input");t.Model=Backbone.Model.extend({defaults:{id:"input",description:"",label:"",type:"all"},initialize:function(){this.parentNode=this.get("parentNode"),""===this.get("label")&&this.set({label:this.id}),this.connected=[]},connect:function(e){this.connected.push(e),this.connected=_.uniq(this.connected),this.trigger("connected")},disconnect:function(e){this.connected=_.without(this.connected,e),0===this.connected.length&&this.trigger("disconnected")},remove:function(){for(;this.connected.length>0;)this.connected[0].remove()}}),t.Collection=Backbone.Collection.extend({model:t.Model})}(Dataflow),function(e){var t=e.prototype.module("input"),o=e.prototype.module("output");o.Model=t.Model.extend({defaults:{id:"output",label:"",type:"all",description:""}}),o.Collection=Backbone.Collection.extend({model:o.Model})}(Dataflow),function(e){var t=e.prototype.module("edge"),o=Backbone.Model.extend({defaults:{type:"data",data:"",group:""}}),i=Backbone.Collection.extend({model:o});t.Model=Backbone.Model.extend({defaults:{z:0,route:0,selected:!1,log:null},initialize:function(){var e,t,o,n=this.get("preview");if(this.parentGraph=this.get("parentGraph"),this.attributes.log=new i,n){e=this.get("parentGraph").nodes;var a=this.get("source"),s=this.get("target");a?(t=e.get(this.get("source").node),this.source=t.outputs.get(this.get("source").port)):s&&(o=e.get(this.get("target").node),this.target=o.inputs.get(this.get("target").port))}else{e=this.parentGraph.nodes;try{t=e.get(this.get("source").node),this.source=t.outputs.get(this.get("source").port),o=e.get(this.get("target").node),this.target=o.inputs.get(this.get("target").port)}catch(d){}this.source.connect(this),this.target.connect(this),t.on("send:"+this.source.id,this.send,this),this.bringToTop(),this.on("select",this.select,this)}},select:function(){this.parentGraph.trigger("select:edge",this)},send:function(e){this.target.parentNode.recieve(this.target.id,e)},isConnectedToPort:function(e){return this.source===e||this.target===e},isConnectedToNode:function(e){return this.source.parentNode===e||this.target.parentNode===e},toString:function(){return this.id?this.id:this.get("source").node+":"+this.get("source").port+"::"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target"),route:this.get("route")}},bringToTop:function(){var e=0;this.parentGraph.edges.each(function(t){if(t!==this){var o=t.get("z");o>e&&(e=o),t.view&&t.view.unhighlight()}},this),this.set("z",e+1)},remove:function(){this.source.disconnect(this),this.target.disconnect(this),this.collection&&this.collection.remove(this),this.source.parentNode.off("send:"+this.source.id,this.send,this)}}),t.Collection=Backbone.Collection.extend({model:t.Model,comparator:function(e){return e.get("z")}})}(Dataflow),function(e){var t=e.prototype.module("graph");e.prototype.module("node");var o=e.prototype.module("edge"),i=.2,n=1.1;document.createElement("div").style.hasOwnProperty("zoom");var a='<div class="dataflow-graph-panzoom"><div class="dataflow-graph zoom-normal"><div class="dataflow-edges"><svg class="dataflow-svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="dataflow-nodes" /></div></div><div class="dataflow-graph-controls"><button class="dataflow-graph-gotoparent"><i class="icon-chevron-left"></i> back to parent</button></div>';t.View=Backbone.View.extend({template:_.template(a),className:"dataflow-g",events:{"click .dataflow-graph":"deselect","dragstart .dataflow-graph-panzoom":"panStart","drag .dataflow-graph-panzoom":"pan","dragstop .dataflow-graph-panzoom":"panStop","click .dataflow-graph-gotoparent":"gotoParent",mousewheel:"mouseWheel"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("nodes"),t=this.model.get("edges");this.nodes=e.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=t.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this);var o=this.model.get("parentNode");o||this.$(".dataflow-graph-controls").hide(),this.$(".dataflow-graph-panzoom").draggable({helper:function(){var e=$("<div>");return this.model.dataflow.$el.append(e),e}.bind(this)}),this.$graphEl=this.$(".dataflow-graph"),this.graphEl=this.$(".dataflow-graph")[0],this.$graphEl.css({transform:"translate3d(0, 0, 0) scale3d(1, 1, 1) ",transformOrigin:"left top"}),this.bindInteraction()},panStartOffset:null,panStart:function(e,t){t&&(this.panStartOffset=t.offset)},pan:function(e,t){if(t){var o=this.model.get("zoom"),i=t.offset.left-this.panStartOffset.left,n=t.offset.top-this.panStartOffset.top;this.$(".dataflow-graph").css({transform:"translate3d("+i/o+"px, "+n/o+"px, 0)"})}},panStop:function(e,t){this.$(".dataflow-graph").css({transform:"translate3d(0, 0, 0)"});var o=this.model.get("zoom"),i=t.offset.left-this.panStartOffset.left,n=t.offset.top-this.panStartOffset.top;this.model.set({panX:this.model.get("panX")+i/o,panY:this.model.get("panY")+n/o})},tempPanX:0,tempPanY:0,setPanDebounce:_.debounce(function(){this.$(".dataflow-graph").css({transform:"translate3d(0, 0, 0)"}),this.model.set({panX:this.model.get("panX")+this.tempPanX,panY:this.model.get("panY")+this.tempPanY}),this.tempPanX=0,this.tempPanY=0},250),mouseWheel:function(e){e.preventDefault();var t=e.originalEvent;this.tempPanX+=t.wheelDeltaX/6,this.tempPanY+=t.wheelDeltaY/6,this.$(".dataflow-graph").css({transform:"translate3d("+this.tempPanX+"px, "+this.tempPanY+"px, 0)"}),this.setPanDebounce()},gotoParent:function(){var e=this.model.get("parentNode");e&&this.model.dataflow.showGraph(e.parentGraph)},bindInteraction:function(){this.bindZoom(),this.bindScroll()},bindZoom:function(){if(window.Hammer){var e,t,o,a,s,d,r,l,h,p,c=this;Hammer(this.$(".dataflow-graph-panzoom")[0]).on("transformstart",function(i){e=c.model.get("zoom"),t=i.gesture.center.pageX,o=i.gesture.center.pageY,a=t/e,s=o/e;var n=c.$el.offset();h=a-n.left,p=s-n.top,c.$graphEl.css({transformOrigin:a+"px "+s+"px"})}).on("transform",function(a){d=Math.max(i/e,Math.min(a.gesture.scale,n/e)),r=(a.gesture.center.pageX-t)/e,l=(a.gesture.center.pageY-o)/e,c.$graphEl.css({transform:"translate3d("+r+"px,"+l+"px, 0) "+"scale3d("+d+","+d+", 1) "})}).on("transformend",function(){c.$graphEl.css({transform:"translate3d(0, 0, 0) scale3d(1, 1, 1) "});var t=e*d;t=Math.max(i,Math.min(t,n)),c.model.set("zoom",t),h*=t,p*=t,c.model.set({panX:c.model.get("panX")+r,panY:c.model.get("panY")+l}),console.log(c.model.attributes)});var u=function(){var e=c.model.get("zoom"),t=c.zoomClass;c.zoomClass=.5>e?"zoom-tiny":.8>e?"zoom-small":1.3>e?"zoom-normal":"zoom-big",c.$graphEl.removeClass(t).addClass(c.zoomClass),c.graphEl.style.zoom=c.model.get("zoom")};this.model.on("change:zoom",u),1!==this.model.get("zoom")&&u()}},zoomClass:1,zoomIn:function(){var e=this.model.get("zoom"),t=.9*e;t=Math.max(i,t),t!==e&&this.model.set("zoom",t)},zoomOut:function(){var e=this.model.get("zoom"),t=1.1*e;t=Math.min(n,t),t!==e&&this.model.set("zoom",t)},zoomCenter:function(){var e=this.model.get("zoom"),t=1;t!==e&&this.model.set("zoom",1)},bindScroll:function(){},render:function(){var e=this;return _.defer(function(){e.rerenderEdges()},this),this},addNode:function(e){var t=this.model.dataflow.nodes[e.type];if(t&&t.View)e.view=new t.View({model:e,graph:this});else{var o=this.model.dataflow.node("base");e.view=new o.View({model:e,graph:this})}this.nodes[e.id]=e.view,e.view.render(),this.$(".dataflow-nodes").append(e.view.el)},removeNode:function(e){e.view.remove(),this.nodes[e.id]=null,delete this.nodes[e.id]},addEdge:function(e){e.view=new o.View({model:e}),this.edges[e.id]=e.view,e.view.render(),this.$(".dataflow-svg-edges")[0].appendChild(e.view.el)},removeEdge:function(e){e.view&&e.view.remove(),this.edges[e.id]=null,delete this.edges[e.id]},rerenderEdges:function(){_.each(this.edges,function(e){e.render()},this)},sizeSVG:function(){try{var e=this.$(".dataflow-svg-edges")[0],t=e.getBBox(),o=Math.max(Math.round(t.x+t.width+50),50),i=Math.max(Math.round(t.y+t.height+50),50);e.setAttribute("width",o),e.setAttribute("height",i)}catch(n){}},deselect:function(){this.model.nodes.invoke("set",{selected:!1}),this.model.edges.invoke("set",{selected:!1}),this.model.trigger("selectionChanged"),this.unfade(),this.model.dataflow.hideCards()},fade:function(){this.model.nodes.each(function(e){e.view&&(e.get("selected")||e.view.fade())}),this.fadeEdges()},fadeEdges:function(){this.model.edges.each(function(e){e.get("selected")||e.source.parentNode.get("selected")||e.target.parentNode.get("selected")?e.view.unfade():e.view.fade()})},unfade:function(){this.model.nodes.each(function(e){e.view&&e.view.unfade()}),this.model.edges.each(function(e){e.view&&e.view.unfade()})}})}(Dataflow),function(e){var t,o=e.prototype.module("node"),i=e.prototype.module("input"),n=e.prototype.module("output"),a='<div class="outer" /><div class="dataflow-node-header"><h1 class="dataflow-node-title" title="<%- label %>: <%- type %>"><%- label %></h1></div><div class="dataflow-node-ports"><div class="dataflow-node-ins"></div><div class="dataflow-node-outs"></div><div style="clear:both;"></div></div><div class="dataflow-node-inner"></div>',s="";o.View=Backbone.View.extend({template:_.template(a),innerTemplate:_.template(s),className:"dataflow-node",events:function(){return{"click .dataflow-node-header":"select",dragstart:"dragStart",drag:"drag",dragstop:"dragStop"}},initialize:function(e){this.$el.html(this.template(this.model.toJSON())),this.graph=e.graph,this.$el.addClass(this.model.type),this.model.parentGraph.dataflow.editable||this.$(".dataflow-node-edit").hide(),this.inputs=this.model.inputs.view=new i.CollectionView({collection:this.model.inputs,parent:this}),this.outputs=this.model.outputs.view=new n.CollectionView({collection:this.model.outputs,parent:this}),this.$el.draggable({handle:"h1",helper:function(){return $("<div>")}}),this.$el.data("dataflow-node-view",this),this.$(".dataflow-node-inner").append(this.innerTemplate),this.listenTo(this.model.parentGraph,"change:panX change:panY",this.bumpPosition),this.listenTo(this.model,"change:selected",this.selectedChanged),this.listenTo(this.model,"change:label",this.changeLabel),this.$inner=this.$(".dataflow-node-inner")},render:function(){return this.$el.css({left:this.model.get("x")+this.model.parentGraph.get("panX"),top:this.model.get("y")+this.model.parentGraph.get("panY")}),this.$(".dataflow-node-ins").html(this.inputs.el),this.$(".dataflow-node-outs").html(this.outputs.el),this.$(".dataflow-node-controls").hide(),this.$(".label-edit").hide(),this},_alsoDrag:[],_dragDelta:{},$dragHelpers:$('<div class="dataflow-nodes-helpers">'),dragStart:function(e,o){o&&(this.model.get("selected")||this.select(e,!0),e.stopPropagation(),t=this.model.parentGraph.get("zoom"),this.$dragHelpers.css({transform:"translate3d(0,0,0)"}),this.$el.parent().append(this.$dragHelpers),this._alsoDrag=this.model.collection.where({selected:!0}),_.each(this._alsoDrag,function(e){var t=e.view.$el,o=$('<div class="dataflow-node helper">').css({width:t.width(),height:t.height(),left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)});this.$dragHelpers.append(o)},this))},changeLabel:function(){var e=this.model.get("label"),t=this.model.get("type");this.$(".dataflow-node-title").text(e).attr("title",e+": "+t)},drag:function(e,o){if(o){e.stopPropagation();var i=(o.position.left-o.originalPosition.left)/t,n=(o.position.top-o.originalPosition.top)/t;this.$dragHelpers.css({transform:"translate3d("+i+"px,"+n+"px,0)"})}},dragStop:function(e,o){if(o){e.stopPropagation(),this.model.parentGraph.get("panX"),this.model.parentGraph.get("panY");var i=(o.position.left-o.originalPosition.left)/t,n=(o.position.top-o.originalPosition.top)/t;this._alsoDrag.length&&(_.each(this._alsoDrag,function(e){e.view.moveToPosition(e.get("x")+i,e.get("y")+n)},this),this._alsoDrag=[]),this.$dragHelpers.empty(),this.$dragHelpers.remove()}},bumpPosition:function(){this.$el.css({left:this.model.get("x")+this.model.parentGraph.get("panX"),top:this.model.get("y")+this.model.parentGraph.get("panY")}),this.model.trigger("change:x change:y")},moveToPosition:function(e,t){this.model.set({x:e,y:t},{silent:!0}),this.bumpPosition()},removeModel:function(){this.model.remove()},bringToTop:function(){var e=0;this.model.collection.each(function(t){var o=parseInt(t.view.el.style.zIndex,10);o>e&&(e=o)},this),this.el.style.zIndex=e+1},select:function(e){e&&e.stopPropagation();var t=!1,o=this.model.get("selected");e&&(e.ctrlKey||e.metaKey)?(t=!0,o=!o,this.model.set("selected",o),o?this.showInspector(!0):(this.fade(),this.hideInspector())):(this.model.parentGraph.edges.invoke("set",{selected:!1}),this.model.parentGraph.nodes.invoke("set",{selected:!1}),this.model.parentGraph.view.fade(),o=!0,this.model.set("selected",!0),this.showInspector()),this.bringToTop(),this.model.parentGraph.view.fadeEdges(),this.model.parentGraph.trigger("selectionChanged")},inspector:null,getInspector:function(){if(!this.inspector){var t=new o.InspectView({model:this.model}),i=e.prototype.module("card");this.inspector=new i.Model({dataflow:this.model.parentGraph.dataflow,card:t})}return this.inspector},showInspector:function(e){this.model.parentGraph.dataflow.addCard(this.getInspector(),e)},hideInspector:function(){this.model.parentGraph.dataflow.removeCard(this.getInspector())},fade:function(){this.$el.addClass("fade"),this.$el.removeClass("ui-selected")},unfade:function(){this.$el.removeClass("fade")},selectedChanged:function(){this.model.get("selected")?this.highlight():this.unhighlight()},highlight:function(){this.$el.removeClass("fade"),this.$el.addClass("ui-selected")},unhighlight:function(){this.$el.removeClass("ui-selected")}})}(Dataflow),function(e){var t=e.prototype.module("input"),o=e.prototype.module("edge"),i='<span class="dataflow-port-plug in" title="drag to edit wire"></span><span class="dataflow-port-hole in" title="drag to make new wire"></span><label class="dataflow-port-label in" title="<%= description %>"><%= label %></label>',n=1;t.View=Backbone.View.extend({template:_.template(i),tagName:"li",className:"dataflow-port dataflow-in",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},$input:null,initialize:function(e){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.parent=e.parent;var t=this.parent.model,o=t.parentGraph;this.listenTo(t,"change:x change:y",function(){this._holePosition=null}.bind(this)),this.listenTo(o,"change:panX change:panY",function(){this._holePosition=null}.bind(this));var i=t.get("state");if(i&&i[this.model.id]&&this.$el.addClass("hasvalue"),this.model.parentNode.parentGraph.dataflow.editable){var n=this;if(this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var e=$('<span class="dataflow-port-plug in helper" />');return n.parent.graph.$el.append(e),e},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var e=$('<span class="dataflow-port-plug out helper" />').data({port:n.model});return n.parent.graph.$el.append(e),e}}),this.$el.droppable({accept:".dataflow-port-plug.in, .dataflow-port-hole.out",activeClassType:"droppable-hover",refreshPositions:!0}),this.model.parentNode.parentGraph.dataflow.inputs){var a=this.model.get("type"),s=this.model.parentNode.get("state");if(e=this.model.get("options"),void 0!==e&&(_.isString(e)&&(e=e.split(" "),this.model.set("options",e)),_.isArray(e))){for(var d={},r=0;e.length>r;r++)d[e[r]]=e[r];e=d,this.model.set("options",e)}var l,h=this.renderInput(a,e);s&&void 0!==s[this.model.id]?l=s[this.model.id]:void 0!==this.model.get("value")&&(l=this.model.get("value")),this.setInputValue(h,a,l),this.model.parentNode.on("change:state",function(){var e=this.model.parentNode.get("state");return e&&void 0!==e[this.model.id]?(this.setInputValue(h,a,e[this.model.id]),this.$el.addClass("hasvalue"),void 0):(this.$el.removeClass("hasvalue"),void 0)}.bind(this));var p=$('<label class="input-type-'+a+'">').append(h).prepend("<span>"+this.model.get("label")+"</span> ");this.$input=p,this.model.connected.length&&p.addClass("connected"),this.model.on("connected",function(){this.$input.addClass("connected")},this),this.model.on("disconnected",function(){this.$input.removeClass("connected")},this)}}},renderInput:function(e,t){var o;if(t){o=$('<select class="input input-select">');for(var i in t){var n=$('<option value="'+t[i]+'">'+i+"</option>").data("val",t[i]);o.append(n)}return o.change(this.inputSelect.bind(this)),o}switch(e){case"int":case"float":case"number":var a={};return void 0!==this.model.get("min")&&(a.min=this.model.get("min")),void 0!==this.model.get("max")&&(a.max=this.model.get("max")),"int"===e&&(a.step=1),o=$('<input type="number" class="input input-number">').attr(a).addClass("int"===e?"input-int":"input-float"),"int"==e?o.change(this.inputInt.bind(this)):o.change(this.inputFloat.bind(this)),o;case"boolean":return o=$('<input type="checkbox" class="input input-boolean"><div class="input-boolean-checkbox"/>'),o.change(this.inputBoolean.bind(this)),o;case"object":return o=$('<textarea class="input input-object"></textarea>'),o.on("change, keyup",this.inputObject.bind(this)),o;case"bang":return o=$('<button class="input input-bang">!</button>'),o.click(this.inputBang.bind(this)),o;default:return o=$('<input class="input input-string">'),o.change(this.inputString.bind(this)),o}},setInputValue:function(e,t,o){return e?"SELECT"===e[0].tagName?($("option",e).each(function(){var e=$(this).data("val");$(this).prop("selected",e==o)}),void 0):"boolean"===t?(e.prop("checked",o),void 0):"object"===t?(e.text(JSON.stringify(o,null,2)),void 0):(e.val(o),void 0):void 0},inputSelect:function(e){var t=$(e.target).find(":selected").data("val");this.model.parentNode.setState(this.model.id,t)},inputInt:function(e){this.model.parentNode.setState(this.model.id,parseInt($(e.target).val(),10))},inputFloat:function(e){this.model.parentNode.setState(this.model.id,parseFloat($(e.target).val()))},inputString:function(e){this.model.parentNode.setState(this.model.id,$(e.target).val())},inputBoolean:function(e){this.model.parentNode.setState(this.model.id,$(e.target).prop("checked"))},inputObject:function(e){try{var t=JSON.parse($(e.target).text());this.model.parentNode.setState(this.model.id,t)}catch(o){}},inputBang:function(){this.model.parentNode.setBang(this.model.id)},render:function(){return this},newEdgeStart:function(e,t){if(t){e.stopPropagation(),t.helper.data({route:this.topRoute}),this.previewEdgeNew=new o.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeNewView=new o.View({model:this.previewEdgeNew});var i=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];i.appendChild(this.previewEdgeNewView.el),n=this.model.parentNode.parentGraph.get("zoom")}},newEdgeDrag:function(e,t){if(this.previewEdgeNewView&&t){e.stopPropagation(),t.position.top=e.clientY/n,t.position.left=e.clientX/n;var o=this.model.parentNode.parentGraph.view.el;t.position.left+=o.scrollLeft,t.position.top+=o.scrollTop,this.previewEdgeNewView.render({left:t.position.left-o.scrollLeft,top:t.position.top-o.scrollTop}),this.model.parentNode.parentGraph.view.sizeSVG()}},newEdgeStop:function(e){e.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},getTopEdge:function(){var e,t=-1;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(o){var i=o.get("z");o.target===this.model&&i>t&&(e=o,t=i),o.view&&o.view.unhighlight()},this),e&&e.view&&e.view.bringToTop()),e},changeEdgeStart:function(e,t){if(t&&(e.stopPropagation(),this.isConnected)){var i=this.getTopEdge();if(i){i.remove(),t&&t.helper.data({port:i.source,route:i.get("route")}),this.previewEdgeChange=new o.Model({source:i.get("source"),route:i.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new o.View({model:this.previewEdgeChange});var a=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];a.appendChild(this.previewEdgeChangeView.el),n=this.model.parentNode.parentGraph.get("zoom")}}},changeEdgeDrag:function(e,t){t&&(e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG()))},changeEdgeStop:function(e){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(e,t){var o=t.helper.data("port"),i=this.model.parentNode.parentGraph.edges.length;if(o.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var n=0;void 0!==t.helper.data("route")&&(n=t.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:o.parentNode.id+":"+o.id+"::"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:o.parentNode.id,port:o.id},target:{node:this.model.parentNode.id,port:this.model.id},route:n}),t.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>i)},_holePosition:null,holePosition:function(){if(!this._holePosition){this.parent||(this.parent=this.options.parent);var e=this.parent.model,t=e.parentGraph;this.parent.graph.$el;var o=this.$el.index(),i=t.get("panX")+e.get("x")+18,n=t.get("panY")+e.get("y")+48+20*o;this._holePosition={left:i,top:n}}return this._holePosition},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(e){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var e,t=-1;if(this.model.parentNode.parentGraph.edges.each(function(o){if(o.target===this.model){var i=o.get("z");i>t&&(e=o,t=i)}},this),e)this.bringToTop(e);else{try{this.$(".dataflow-port-plug").draggable("disable")}catch(o){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(e){var t=e.get("route");void 0!==t&&(this.$(".dataflow-port-hole, .dataflow-port-plug").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole, .dataflow-port-plug").addClass("route"+t),this.topRoute=t)}}),t.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:t.View})}(Dataflow),function(e){var t=e.prototype.module("output"),o=e.prototype.module("edge"),i='<span class="dataflow-port-label out" title="<%= description %>"><%= label %></span><span class="dataflow-port-hole out" title="drag to make new wire"></span><span class="dataflow-port-plug out" title="drag to edit wire"></span>',n=1;
t.View=Backbone.View.extend({template:_.template(i),tagName:"li",className:"dataflow-port dataflow-out",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},initialize:function(e){this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.parent=e.parent;var t=this.parent.model,o=t.parentGraph;if(this.listenTo(t,"change:x change:y change:w",function(){this._holePosition=null}.bind(this)),this.listenTo(o,"change:panX change:panY",function(){this._holePosition=null}.bind(this)),this.model.parentNode.parentGraph.dataflow.editable){var i=this;this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var e=$('<span class="dataflow-port-plug out helper" />');return i.parent.graph.$el.append(e),e},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var e=$('<span class="dataflow-port-plug in helper" />').data({port:i.model});return i.parent.graph.$el.append(e),e}}),this.$el.droppable({accept:".dataflow-port-plug.out, .dataflow-port-hole.in",activeClassType:"droppable-hover"})}},render:function(){return this},newEdgeStart:function(e,t){if(e.stopPropagation(),t){t.helper.data({route:this.topRoute}),this.previewEdge=new o.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeView=new o.View({model:this.previewEdge});var i=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];i.appendChild(this.previewEdgeView.el),n=this.model.parentNode.parentGraph.get("zoom")}},newEdgeDrag:function(e,t){if(e.stopPropagation(),this.previewEdgeView&&t){t.position.top=e.clientY/n,t.position.left=e.clientX/n;var o=this.model.parentNode.parentGraph.view.el;t.position.left+=o.scrollLeft,t.position.top+=o.scrollTop,this.previewEdgeView.render({left:t.position.left-o.scrollLeft,top:t.position.top-o.scrollTop})}},newEdgeStop:function(e){e.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},getTopEdge:function(){var e,t=-1;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(o){var i=o.get("z");o.source===this.model&&i>t&&(e=o,t=i),o.view&&o.view.unhighlight()},this),e&&e.view&&e.view.bringToTop()),e},changeEdgeStart:function(e,t){if(t&&(e.stopPropagation(),this.isConnected)){var i=this.getTopEdge();if(i){i.remove(),t&&t.helper.data({port:i.target,route:i.get("route")}),this.previewEdgeChange=new o.Model({target:i.get("target"),route:i.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new o.View({model:this.previewEdgeChange});var a=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];a.appendChild(this.previewEdgeChangeView.el),n=this.model.parentNode.parentGraph.get("zoom")}}},changeEdgeDrag:function(e,t){t&&(e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(t.offset),this.model.parentNode.parentGraph.view.sizeSVG()))},changeEdgeStop:function(e){e.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)},connectEdge:function(e,t){var o=t.helper.data("port"),i=this.model.parentNode.parentGraph.edges.length;if(o.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var n=0;void 0!==t.helper.data("route")&&(n=t.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"::"+o.parentNode.id+":"+o.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:o.parentNode.id,port:o.id},route:n}),t.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>i)},_holePosition:null,holePosition:function(){if(!this._holePosition){this.parent||(this.parent=this.options.parent);var e=this.parent.model,t=e.parentGraph;this.parent.graph.$el;var o=this.$el.index(),i=void 0!==e.get("w")?e.get("w"):175,n=t.get("panX")+e.get("x")+i-18,a=t.get("panY")+e.get("y")+48+20*o;this._holePosition={left:n,top:a}}return this._holePosition},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(e){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var e,t=-1;if(this.model.parentNode.parentGraph.edges.each(function(o){if(o.source===this.model){var i=o.get("z");i>t&&(e=o,t=i)}},this),e)this.bringToTop(e);else{try{this.$(".dataflow-port-plug").draggable("disable")}catch(o){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(e){var t=e.get("route");void 0!==t&&(this.$(".dataflow-port-hole").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole").addClass("route"+t),this.topRoute=t)}}),t.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:t.View})}(Dataflow),function(e){var t=e.prototype.module("edge"),o=function(e,t){var o=document.createElementNS("http://www.w3.org/2000/svg",e);for(var i in t)"xlink:href"===i?o.setAttributeNS("http://www.w3.org/1999/xlink","href",t[i]):o.setAttribute(i,t[i]);return o},i=function(e,t){e.classList?e.classList.add(t):e.className="dataflow-edge "+t},n=function(e,t){e.classList?e.classList.remove(t):e.className="dataflow-edge"};t.View=Backbone.View.extend({tagName:"div",className:"dataflow-edge",positions:null,initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("change:x change:y change:w",this.render,this),this.model.target&&this.model.target.parentNode.on("change:x change:y",this.render,this),this.model.source&&this.model.source.view&&(this.model.source.view.plugSetActive(),this.model.source.view.bringToTop(this.model)),this.model.target&&this.model.target.view&&(this.model.target.view.plugSetActive(),this.model.target.view.bringToTop(this.model)),this.el=o("g",{"class":"dataflow-edge"}),this.elEdge=o("path",{"class":"dataflow-edge-wire"}),this.elShadow=o("path",{"class":"dataflow-edge-shadow"}),void 0!==this.model.get("route")&&this.elEdge.setAttribute("class","dataflow-edge-wire route"+this.model.get("route"));var e=this;this.model.on("change:route",function(){e.elEdge.setAttribute("class","dataflow-edge-wire route"+e.model.get("route")),e.bringToTop()}),this.el.appendChild(this.elShadow),this.el.appendChild(this.elEdge),this.el.addEventListener("click",function(t){e.click(t)}),this.listenTo(this.model,"change:selected",this.selectedChange)},render:function(e){var t,o=this.model.source,i=this.model.target;o?this.positions.from=o.view.holePosition():(t=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.from={left:graph.scrollLeft()+e.left-5-t.left,top:graph.scrollTop()+e.top+5-t.top}),i?this.positions.to=i.view.holePosition():(t=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.to={left:graph.scrollLeft()+e.left+15-t.left,top:graph.scrollTop()+e.top+5-t.top});var n=this.edgePath(this.positions);this.elEdge.setAttribute("d",n),this.elShadow.setAttribute("d",n),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},fade:function(){this.model.source.parentNode.get("selected")||this.model.target.parentNode.get("selected")||i(this.el,"fade")},unfade:function(){n(this.el,"fade")},selectedChange:function(){this.model.get("selected")?this.highlight():this.unhighlight(),this.model.parentGraph.trigger("selectionChanged")},highlight:function(){i(this.el,"highlight")},unhighlight:function(){n(this.el,"highlight")},edgePath:function(e){var t=20,o=e.to.left-t-(e.from.left+t),i=Math.floor(o/2),n=o-i,a=e.to.top-e.from.top,s=Math.floor(a/2),d=a-s,r="",l="";return Math.abs(a)>Math.abs(o)?a>0?o>0?(r=" L "+(e.from.left+t+i)+" "+(e.from.top+i),l=" L "+(e.to.left-t-n)+" "+(e.to.top-n)):0>o&&(r=" L "+(e.from.left+t+i)+" "+(e.from.top-i),l=" L "+(e.to.left-t-n)+" "+(e.to.top+n)):0>a&&(o>0?(r=" L "+(e.from.left+t+i)+" "+(e.from.top-i),l=" L "+(e.to.left-t-n)+" "+(e.to.top+n)):0>o&&(r=" L "+(e.from.left+t+i)+" "+(e.from.top+i),l=" L "+(e.to.left-t-n)+" "+(e.to.top-n))):Math.abs(a)<Math.abs(o)&&(o>0?a>0?(r=" L "+(e.from.left+t+s)+" "+(e.from.top+s),l=" L "+(e.to.left-t-d)+" "+(e.to.top-d)):0>a&&(r=" L "+(e.from.left+t-s)+" "+(e.from.top+s),l=" L "+(e.to.left-t+d)+" "+(e.to.top-d)):0>o&&(a>0?(r=" L "+(e.from.left+t-s)+" "+(e.from.top+s),l=" L "+(e.to.left-t+d)+" "+(e.to.top-d)):0>a&&(r=" L "+(e.from.left+t+s)+" "+(e.from.top+s),l=" L "+(e.to.left-t-d)+" "+(e.to.top-d)))),"M "+e.from.left+" "+e.from.top+" L "+(e.from.left+t)+" "+e.from.top+r+l+" L "+(e.to.left-t)+" "+e.to.top+" L "+e.to.left+" "+e.to.top},remove:function(){var e=this.model.source,t=this.model.target;e&&e.parentNode.off(null,null,this),t&&t.parentNode.off(null,null,this),e&&e.view.plugCheckActive(),t&&t.view.plugCheckActive(),this.el.parentNode.removeChild(this.el)},click:function(e){e&&e.stopPropagation();var t,o;e&&(e.ctrlKey||e.metaKey)?(t=this.model.get("selected"),t=!t,o=!0):(t=!0,this.model.parentGraph.nodes.invoke("set",{selected:!1}),this.model.collection.invoke("set",{selected:!1})),this.model.set({selected:t}),t?(this.bringToTop(),this.model.trigger("select"),this.unfade(),this.showInspector(o)):this.hideInspector(),this.model.parentGraph.view.fade()},bringToTop:function(){this.model.bringToTop();var e=this.el.parentNode;e&&e.appendChild(this.el),this.model.source.view.bringToTop(this.model),this.model.target.view.bringToTop(this.model)},inspector:null,getInspector:function(){if(!this.inspector){var o=new t.InspectView({model:this.model}),i=e.prototype.module("card");this.inspector=new i.Model({dataflow:this.model.parentGraph.dataflow,card:o})}return this.inspector},showInspector:function(e){this.model.parentGraph.dataflow.addCard(this.getInspector(),e)},hideInspector:function(){this.model.parentGraph.dataflow.removeCard(this.getInspector())}})}(Dataflow),function(e){var t=e.prototype.module("card");t.Model=Backbone.Model.extend({defaults:{pinned:!1},initialize:function(){this.dataflow=this.get("dataflow")},hide:function(){this.dataflow.shownCards.remove(this)}}),t.Collection=Backbone.Collection.extend({model:t.Model})}(Dataflow),function(e){var t=e.prototype.module("card"),o='<div class="dataflow-card-control"><button title="pin" class="dataflow-card-pin icon-pushpin"></button><button title="close" class="dataflow-card-close icon-remove"></button></div>';t.View=Backbone.View.extend({tagName:"div",className:"dataflow-card",template:_.template(o),events:{"click .dataflow-card-pin":"togglePin","click .dataflow-card-close":"hide"},initialize:function(){this.$el.html(this.template()),this.card=this.model.get("card"),this.$el.append(this.card.el),this.listenTo(this.model,"change:pinned",this.pinnedChanged),this.pinnedChanged()},animate:function(e){"function"==typeof this.card.animate&&this.card.animate(e)},togglePin:function(){var e=!this.model.get("pinned");this.model.set("pinned",e),e||this.hide()},pinnedChanged:function(){this.model.get("pinned")?this.$(".dataflow-card-pin").addClass("active"):this.$(".dataflow-card-pin").removeClass("active")},hide:function(){this.model.hide()},remove:function(){this.$el.detach()}}),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,50)}}()),t.CollectionView=Backbone.CollectionView.extend({tagName:"div",className:"dataflow-cards",itemView:t.View,prepend:!0,initialize:function(){Backbone.CollectionView.prototype.initialize.apply(this,arguments);var e=function(t){window.requestAnimationFrame(e),this.collection.each(function(e){e.view&&e.view.animate(t)})}.bind(this);e()},bringToTop:function(e){this.$el.prepend(e.view.el)}})}(Dataflow),function(e){var t=Backbone.Model.extend({defaults:{label:"",icon:"",action:null}}),o=Backbone.Collection.extend({model:t}),i=e.prototype.module("card"),n=e.prototype.module("menucard");n.Model=i.Model.extend({initialize:function(){this.menu=new o,i.Model.prototype.initialize.call(this)}})}(Dataflow),function(e){var t=e.prototype.module("card"),o=e.prototype.module("menucard"),i=Backbone.View.extend({tagName:"li",template:'<button><i class="icon-<%- icon %>"></i><span class="name"><%- label %></span></button>',events:{click:"clicked"},render:function(){this.$el.html(_.template(this.template,this.model.toJSON()))},clicked:function(){this.model.get("action")&&this.model.get("action")()}});o.View=t.View.extend({initialize:function(){this.model.set("card",new Backbone.CollectionView({tagName:"ul",className:"dataflow-menu",collection:this.model.menu,itemView:i})),t.View.prototype.initialize.call(this)}})}(Dataflow),function(e){var t=e.prototype.module("node"),o='<div class="dataflow-plugin-inspector-title"><h1 class="dataflow-node-inspector-label" title="click to edit"><%- label %></h1><h2 class="dataflow-node-inspector-type"><%- type %></h2></div><div class="dataflow-node-inspector-inputs"></div>',i=function(e,t,o){e[0].contentEditable=!0;var i=e.text(),n=function(){t.set(o,e.text())},a=function(){e.text(i)};e.focus(function(){i=e.text()}).blur(function(){n()}).keydown(function(t){27===t.which?(a(),e.blur()):13===t.which&&e.blur()})};t.InspectView=Backbone.View.extend({template:_.template(o),className:"dataflow-node-inspector",events:{},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.$el.children(".dataflow-node-inspector-inputs");this.model.inputs.each(function(t){t.view&&t.view.$input&&e.append(t.view.$input)},this),i(this.$(".dataflow-node-inspector-label"),this.model,"label")},render:function(){return this},removeModel:function(){this.model.remove()}})}(Dataflow),function(e){var t=e.prototype.module("edge"),o='<div class="dataflow-plugin-inspector-title"><h1>Edge</h1><h2 class="dataflow-edge-inspector-id"><%= id %></h2></div><div class="dataflow-edge-inspector-route-choose"></div><ul class="dataflow-edge-inspector-events"></ul>',i='<li class="<%- type %>"><%- group %><%- data %></li>';t.InspectView=Backbone.View.extend({tagName:"div",className:"dataflow-edge-inspector",positions:null,template:_.template(o),showLogs:20,initialize:function(){var e=this.model.toJSON();this.model.id&&(e.id=this.model.id.replace("->","&#8594;")),this.$el.html(this.template(e));var t=this.$el.children(".dataflow-edge-inspector-route-choose");this.$log=this.$el.children(".dataflow-edge-inspector-events");for(var o=function(e){var t=$(e.target).data("route");this.model.set("route",t)}.bind(this),i=0;12>i;i++){var n=$("<button>").data("route",i).addClass("route"+i).click(o);i===this.model.get("route")&&n.addClass("active"),t.append(n)}this.listenTo(this.model,"change:route",this.render),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model.get("log"),"add",function(){this.logDirty=!0}.bind(this)),this.renderLog()},render:function(){var e=this.model.get("route"),t=this.$el.children(".dataflow-edge-inspector-route-choose");return t.children(".active").removeClass("active"),t.children(".route"+e).addClass("active"),this},logDirty:!1,animate:function(){this.logDirty&&(this.logDirty=!1,this.renderLog())},renderLog:function(){var e,t=document.createDocumentFragment(),o=this.model.get("log");e=o.length>this.showLogs?o.rest(o.length-this.showLogs):o.toArray(),_.each(e,function(e){this.renderLogItem(e,t)},this),this.$log.html(t),this.$log[0].scrollTop=this.$log[0].scrollHeight},renderLogItem:function(e,t){var o=$(_.template(i,e.toJSON()));t&&t.appendChild?t.appendChild(o[0]):(this.$log.append(o),this.$log[0].scrollTop=this.$log[0].scrollHeight)}})}(Dataflow),function(e){var t=e.prototype.plugin("menu"),o=e.prototype.module("menucard");t.initialize=function(e){t.card=new o.Model({dataflow:e,pinned:!0}),t.card.view=new o.View({model:t.card}),t.addPlugin=function(o){t.card.menu.add({id:o.id,icon:o.icon,label:o.name,showLabel:!1,action:function(){t.card.hide(),e.showPlugin(o.id)}})},t.disablePlugin=function(t){this.card.menu.get(t)&&(this.card.menu.remove(t),e.plugins[t]&&e.plugins[t].card&&e.plugins[t].card.hide())}}}(Dataflow),function(e){var t=e.prototype.plugin("edit");t.initialize=function(e){function o(){e.currentGraph.nodes.invoke("set",{selected:!0})}function i(){a(),_.each(r.nodes,function(e){e.x-=50,e.y-=50}),t.removeSelected()}function n(){var t=e.currentGraph.edges.where({selected:!0});t.forEach(function(e){e.remove()})}function a(){r={},r.nodes=e.currentGraph.nodes.where({selected:!0}),r.nodes=JSON.parse(JSON.stringify(r.nodes)),r.edges=[],e.currentGraph.edges.each(function(e){var t=_.any(r.nodes,function(t){return e.source.parentNode.id===t.id}),o=_.any(r.nodes,function(t){return e.target.parentNode.id===t.id});(t||o)&&r.edges.push(JSON.parse(JSON.stringify(e)))})}function s(){r&&r.nodes&&r.nodes.length>0&&(e.currentGraph.nodes.invoke("set",{selected:!1}),_.each(r.nodes,function(t){t.x+=50,t.y+=50,t.parentGraph=e.currentGraph,t.selected=!0;for(var o=t.id;e.currentGraph.nodes.get(t.id);)t.id++;o!==t.id&&_.each(r.edges,function(e){e.source.node===o&&(e.source.node=t.id),e.target.node===o&&(e.target.node=t.id)});var i=new e.nodes[t.type].Model(t);e.currentGraph.nodes.add(i),i.view.bringToTop(),i.view.highlight()}),_.each(r.edges,function(t){t=JSON.parse(JSON.stringify(t)),t.parentGraph=e.currentGraph,t.id=t.source.node+":"+t.source.port+"::"+t.target.node+":"+t.target.port;var o=new e.modules.edge.Model(t);e.currentGraph.edges.add(o)})),_.defer(function(){e.currentGraph.view.rerenderEdges()})}var d=$('<div class="dataflow-plugin-edit"><button class="selectall">Select All (A)</button><br /><button class="cut">Cut (X)</button><br /><button class="copy">Copy (C)</button><br /><button class="paste">Paste (V)</button><br /></div>');d.children(".selectall").click(o),t.selectAll=o,t.removeSelected=function(){var t=e.currentGraph.nodes.where({selected:!0});_.each(t,function(e){e.remove()})},d.children(".cut").click(i),t.cut=i,t.removeEdge=n;var r={};d.children(".copy").click(a),t.copy=a,d.children(".paste").click(s),t.paste=s,e.addContext({id:"cut",icon:"cut",label:"cut",action:i,contexts:["node","nodes"]}),e.addContext({id:"copy",icon:"copy",label:"copy",action:a,contexts:["node","nodes"]}),e.addContext({id:"paste",icon:"paste",label:"paste",action:s,contexts:["node","nodes"]}),e.addContext({id:"edgeRemove",icon:"remove",label:"remove edge",action:n,contexts:["edge"]}),e.addContext({id:"edgeRemove",icon:"remove",label:"remove edges",action:n,contexts:["edges"]}),t.onSearch=function(t,o){if(e.currentGraph){var i=[];e.currentGraph.nodes.each(function(e){-1!==e.get("label").toLowerCase().indexOf(t.toLowerCase())&&i.push({source:"edit",icon:"sign-blank",label:e.get("label"),description:e.type,action:function(){e.view.select()}})}),o(i)}}}}(Dataflow),function(e){var t=e.prototype.plugin("elements");t.list=[{type:"div",attributes:["id","class","style"],events:["pointermove","pointerover","pointerout"]},{type:"button",attributes:["id","class","style"],events:["pointerdown","pointerup"]}]}(Dataflow),function(e){var t=e.prototype.plugin("library");t.initialize=function(e){var o=$('<div class="dataflow-plugin-overflow">'),i=$('<ul class="dataflow-plugin-library" />');o.append(i),t.excluded=["base","base-resizable"];var n=function(t,o,i){return function(){e.currentGraph.view.$(".dataflow-node").removeClass("ui-selected"),zoom=e.currentGraph.get("zoom");for(var n=1;e.currentGraph.nodes.get(n);)n++;o=void 0===o?200:o,i=void 0===i?200:i,o=o/zoom-e.currentGraph.get("panX"),i=i/zoom-e.currentGraph.get("panY");var a=new t.Model({id:n,x:o,y:i,parentGraph:e.currentGraph});e.currentGraph.nodes.add(a),a.view.select()}},a='<li><a class="button add"><i class="icon-plus"></i></a><span class="name"><%- name %></span><span class="description"><%-description %></span></li>',s=function(t,o){var s=$(_.template(a,{name:t,description:o.description}));$(".button",s).attr("title","click or drag").draggable({helper:function(){var o=$('<div class="dataflow-node helper"><div class="dataflow-node-title">'+t+"</div></div>");return e.$el.append(o),o},stop:function(e,t){n(o,t.position.left,t.position.top).call()}}).click(n(o)),i.append(s)},d=function(o){o=o?o:{},t.excluded=o.exclude?o.exclude:t.excluded,i.empty();var n=_.sortBy(Object.keys(e.nodes),function(e){return e});_.each(n,function(o){-1===t.excluded.indexOf(o)&&s(o,e.nodes[o])})};d(),e.addPlugin({id:"library",name:"",menu:o,icon:"plus",pinned:!1}),t.update=d,t.onSearch=function(o,i){var a=[];_.each(e.nodes,function(e,i){-1===t.excluded.indexOf(i)&&-1!==i.toLowerCase().indexOf(o.toLowerCase())&&a.push({source:"library",icon:"plus",action:function(){n(e).call()},label:i,description:e.description})}),i(a)}}}(Dataflow),function(e){var t=e.prototype.plugin("source");t.updateAllowed=!0,t.initialize=function(e){var o=$('<form class="dataflow-plugin-view-source"><div style=""><textarea class="code" style="width:99%; height:400px;; margin:0; padding: 0;"></textarea><br/></div><input class="apply" type="submit" value="apply changes" style="position: absolute; right:5px; bottom:5px;" /></form>'),i=o.find(".code");e.addPlugin({id:"source",name:"",menu:o,icon:"code",pinned:!0}),t.show=function(e){var t=i.prop("scrollTop");i.val(e),i.scrollTop(t)};var n=function(){e.graph&&t.show(JSON.stringify(e.graph.toJSON(),null,"  "))};t.listeners=function(t){t?e.on("change",n):e.off("change",n)},t.listeners(!0),t.allowUpdate=function(e){var n=o.find(".apply");return e?(t.updateAllowed=!0,n.show(),i.removeAttr("readonly"),void 0):(t.updateAllowed=!1,n.hide(),i.attr("readonly","readonly"),void 0)},o.submit(function(){return t.updateGraph(i,e),!1})},t.updateGraph=function(e,o){if(t.updateAllowed){var i;try{i=JSON.parse(e.val())}catch(n){return o.log("Invalid JSON"),!1}if(i){var a=o.loadGraph(i);a.trigger("change")}}}}(Dataflow),function(e){var t=e.prototype.plugin("log");t.initialize=function(e){function o(e){e=_.escape(e),i.children(".loglist").append("<li>"+e+"</li>"),i.scrollTop(i.prop("scrollHeight"))}var i=$('<div class="dataflow-plugin-log dataflow-plugin-overflow"><ol class="loglist"></ol></div>');e.addPlugin({id:"log",name:"",menu:i,icon:"th-list",pinned:!0}),t.add=o;var n=function(e){o("log: "+e)},a=function(e,t){o("node added: "+(""+t))},s=function(e,t){o("node removed: "+(""+t))},d=function(e,t){o("edge added: "+(""+t))},r=function(e,t){o("edge removed: "+(""+t))};t.listeners=function(t){t?(e.on("log",n),e.on("node:add",a),e.on("node:remove",s),e.on("edge:add",d),e.on("edge:remove",r)):(e.off("log",n),e.off("node:add",a),e.off("node:remove",s),e.off("edge:add",d),e.off("edge:remove",r))},t.listeners(!0)}}(Dataflow),function(e){var t=e.prototype.plugin("inspector");t.initialize=function(e){function t(){var t=e.currentGraph.nodes.where({selected:!0});t.forEach(function(t){var o=t.view.getInspector();o.set("pinned",!0),e.addCard(o)});var o=e.currentGraph.edges.where({selected:!0});o.forEach(function(t){var o=t.view.getInspector();o.set("pinned",!0),e.addCard(o)})}e.addContext({id:"inspector",icon:"info-sign",label:"inspect",action:t,contexts:["one","twoplus"]})}}(Dataflow),function(e){var t=e.prototype.plugin("keybinding"),o=e.prototype.plugin("edit");t.initialize=function(e){function i(){e&&e.currentGraph&&e.currentGraph.view&&e.currentGraph.view.zoomIn()}function n(){e&&e.currentGraph&&e.currentGraph.view&&e.currentGraph.view.zoomOut()}function a(){e&&e.currentGraph&&e.currentGraph.view&&e.currentGraph.view.zoomCenter()}function s(e){if("TEXTAREA"!==e.target.tagName&&"INPUT"!==e.target.tagName&&"true"!==e.target.contentEditable&&(e.ctrlKey||e.metaKey))switch(e.which){case 189:e.preventDefault(),i();break;case 187:e.preventDefault(),n();break;case 48:e.preventDefault(),a();break;case 65:o.selectAll();break;case 88:o.cut();break;case 67:o.copy();break;case 86:o.paste();break;case 90:break;default:}}t.listeners=function(e){e?$(document).on("keydown",s):$(document).off("keydown",s)},t.listeners(!0)}}(Dataflow),function(e){var t=e.prototype.plugin("notification"),o=window.webkitNotifications?!0:!1;t.requestPermission=function(){o&&(t.hasPermission()||window.webkitNotifications.requestPermission())},t.hasPermission=function(){return o?0!==window.webkitNotifications.checkPermission()?!1:!0:!1},t.notify=function(e,o,i){if(!t.hasPermission()){if(!console||!console.log)return;return console.log(o+": "+i),void 0}var n=window.webkitNotifications.createNotification(e,o,i);n.show()}}(Dataflow),function(e){var t=e.prototype.plugin("search"),o=Backbone.Model.extend({defaults:{source:"",icon:"",action:null,label:"",description:""}}),i=Backbone.Collection.extend({model:o,initialize:function(e,t){t||(t={}),this.search=t.search}}),n=Backbone.View.extend({tagName:"li",template:'<i class="icon-<%- icon %>"></i><span class="name"><%- label %></span><span class="description"><%- description %></span>',events:{click:"clicked"},render:function(){this.$el.html(_.template(this.template,this.model.toJSON()))},clicked:function(){this.model.get("action")&&this.model.get("action")()}});t.initialize=function(e){var o=$('<div class="dataflow-plugin-search"><input type="search" placeholder="Search" results="5" /><button><i class="icon-reorder"></i></button></div>'),i=o.find("input"),n=o.find("button");e.$el.prepend(o),i.on("keyup",function(){i.val()&&t.search(i.val(),e)}),n.on("click",function(){e.showPlugin("menu")})},t.search=function(o,a){var s=e.prototype.module("card"),d=new i([],{search:o}),r=new Backbone.CollectionView({tagName:"ul",className:"dataflow-plugin-search-results",collection:d});r.itemView=n;var l=new s.Model({dataflow:a,card:r,pinned:!1});d.on("add",function(){a.addCard(l)}),t.results=d,_.each(a.plugins,function(e){e.onSearch&&t.searchPlugin(d,o,e)})},t.searchPlugin=function(e,o,i){i.onSearch(o,function(i){o===t.results.search&&i.forEach(function(t){e.add(t)})})}}(Dataflow),function(e){var t=e.prototype.module("node"),o=e.prototype.node("base");o.Model=t.Model.extend({defaults:function(){var e=t.Model.prototype.defaults.call(this);return e.type="base",e},initialize:function(){t.Model.prototype.initialize.call(this)},unload:function(){},inputs:[],outputs:[]}),o.View=t.View.extend({})}(Dataflow),function(e){var t=e.prototype.node("base"),o=e.prototype.node("base-resizable");o.Model=t.Model.extend({defaults:function(){var e=t.Model.prototype.defaults.call(this);return e.type="base-resizable",e.w=200,e.h=200,e},initialize:function(){t.Model.prototype.initialize.call(this)},unload:function(){},toJSON:function(){var e=t.Model.prototype.toJSON.call(this);return e.w=this.get("w"),e.h=this.get("h"),e},inputs:[],outputs:[]}),o.View=t.View.extend({initialize:function(e){t.View.prototype.initialize.call(this,e),this.$el.css({width:this.model.get("w"),height:this.model.get("h")});var o=this;this.$el.resizable({helper:"dataflow-node helper",minHeight:100,minWidth:120,stop:function(e,t){o.resizeStop(e,t)}})},resizeStop:function(e,t){this.model.set({w:t.size.width,h:t.size.height})}})}(Dataflow),function(e){var t=e.prototype.node("base-resizable"),o=e.prototype.node("dataflow-subgraph"),i=e.prototype.module("graph"),n=e.prototype.module("input"),a=e.prototype.module("output");o.Model=t.Model.extend({defaults:function(){var e=t.Model.prototype.defaults.call(this);return e.label="subgraph",e.type="dataflow-subgraph",e.graph={nodes:[{id:"1",label:"in",type:"dataflow-input",x:180,y:15},{id:"99",label:"out",type:"dataflow-output",x:975,y:500}]},e},initialize:function(){t.Model.prototype.initialize.call(this);var e=this.get("graph");e.parentNode=this,e.dataflow=this.parentGraph.dataflow,this.graph=new i.Model(e);var o=this.graph.nodes.filter(function(e){return"dataflow-input"===e.type});_.each(o,this.addInput,this);var n=this.graph.nodes.filter(function(e){return"dataflow-output"===e.type});_.each(n,this.addOutput,this),this.graph.nodes.on("add",function(e){"dataflow-input"===e.type?this.addInput(e):"dataflow-output"===e.type&&this.addOutput(e)},this),this.graph.nodes.on("remove",function(e){"dataflow-input"===e.type?this.removeInput(e):"dataflow-output"===e.type&&this.removeOutput(e)},this)},addInput:function(e){var t=new n.Model({id:e.id,label:e.get("label"),type:e.get("input-type"),parentNode:this,inputNode:e});this.inputs.add(t)},recieve:function(e,t){var o=this.inputs.get(e).get("inputNode");o&&o.send("data",t)},addOutput:function(e){var t=new a.Model({id:e.id,label:e.get("label"),type:e.get("output-type"),parentNode:this,outputNode:e});this.outputs.add(t),e.set("parentNode",this)},removeInput:function(e){var t=this.inputs.get(e.id);t.remove(),this.inputs.remove(t)},removeOutput:function(e){var t=this.outputs.get(e.id);t.remove(),this.outputs.remove(t)},toJSON:function(){var e=t.Model.prototype.toJSON.call(this);return e.graph=this.graph,e},remove:function(){t.Model.prototype.remove.call(this),this.graph.remove()},inputs:[],outputs:[]});var s='<button class="show-subgraph">edit subgraph</button>';o.View=t.View.extend({events:function(){var e=t.View.prototype.events.call(this);return e["click .show-subgraph"]="showSubgraph",e},innerTemplate:_.template(s),initialize:function(e){t.View.prototype.initialize.call(this,e),this.model.graph.view=new i.View({model:this.model.graph}),this.model.inputs.each(this.addInput,this),this.model.inputs.on("add",this.addInput,this),this.model.outputs.each(this.addOutput,this),this.model.outputs.on("add",this.addOutput,this)},addInput:function(e){e.get("inputNode")&&e.get("inputNode").on("change:label",function(t){e.view.$(".label").text(t.get("label"))},this)},addOutput:function(e){e.get("outputNode")&&e.get("outputNode").on("change:label",function(t){e.view.$(".label").text(t.get("label"))},this)},showSubgraph:function(){this.model.graph.dataflow.showGraph(this.model.graph)}})}(Dataflow);
//@ sourceMappingURL=dataflow.min.js.map