/*! dataflow.js - v0.0.7 - 2013-07-26 (1:09:22 PM PDT)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, GPL */
(function(t){var e=function(t,e,o){t[e]||(t[e]=new o),t[e]instanceof o||(t[e]=new o(t[e]))},o=t.Model.extend({defaults:{action:null,label:"",disabled:!1,icon:""}}),i=t.Collection.extend({model:o}),n=t.Model.extend({view:null,context:null,defaults:{control:null,actions:null,overflow:null,className:"actionbar"},initialize:function(t,n){e(this.attributes,"control",o),e(this.attributes,"actions",i),e(this.attributes,"overflow",i),this.context=n},render:function(){return this.view=new s({model:this,context:this.context}),this.view.render().el},show:function(){var e=this.render();t.$("body").prepend(e)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),a=t.Model.extend({view:null,context:null,defaults:{control:null,actions:null,className:"contextbar"},initialize:function(t,n){e(this.attributes,"control",o),e(this.attributes,"actions",i),this.context=n},render:function(){return this.view=new l({model:this,context:this.context}),this.view.render().el},show:function(){var e=this.render();t.$("body").prepend(e)},hide:function(){this.view&&(this.view.$el.remove(),this.view=null)}}),s=t.View.extend({tagName:"div",className:"navbar navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-up":"handleUp","click .control-icon":"handleIcon","click .control-label":"handleLabel"},initialize:function(t){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=t.context},handleUp:function(t){t.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("up")&&this.model.get("control").get("up").call(this.context)},handleIcon:function(t){return this.model.get("control").get("up")?(this.handleUp(t),void 0):(this.handleLabel(t),void 0)},handleLabel:function(t){t.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=t.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this.renderOverflow(),this},renderControl:function(){if(this.model.get("control")){this.$control||(this.$control=t.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var e=this.model.get("control").get("icon"),o=this.model.get("control").get("up"),i=this.model.get("control").get("label");this.$control.empty(),o&&this.$control.append(t.$('<i class="control-up icon-chevron-left"></i><span class="control-up">&nbsp;</span>')),e&&this.$control.append(t.$('<i class="control-icon icon-'+e+'"></i>')),i&&this.$control.append('<span class="control-label">&nbsp;'+i+"</span>")}},renderActions:function(){if(!this.$actions){var t=new r({collection:this.model.get("actions"),context:this.context});this.$inner.append(t.render().$el),this.$actions=t.$el}},renderOverflow:function(){}}),l=t.View.extend({tagName:"div",className:"navbar navbar-inverse navbar-fixed-top",template:'<div class="navbar-inner"></div>',$inner:null,$control:null,$actions:null,context:null,events:{"click .control-icon":"handleControl","click .control-label":"handleControl"},handleControl:function(t){t.preventDefault(),this.model.get("control").get("disabled")||this.model.get("control").get("action")&&this.model.get("control").get("action").call(this.context)},initialize:function(t){this.listenTo(this.model.get("control"),"change",this.renderControl),this.context=t.context},render:function(){return this.$el.html(this.template),this.$el.addClass(this.model.get("className")),this.$inner=t.$(".navbar-inner",this.$el),this.$control=null,this.$actions=null,this.renderControl(),this.renderActions(),this},renderControl:function(){this.$control||(this.$control=t.$("<a>"),this.$control.addClass("brand"),this.$inner.prepend(this.$control));var e=this.model.get("control").get("icon"),o=this.model.get("control").get("label");this.$control.empty(),e&&this.$control.append(t.$('<i class="control-icon icon-'+e+'"></i>')),o&&this.$control.append('<span class="control-label"> '+o+"</span>")},renderActions:function(){if(!this.$actions){var t=new r({collection:this.model.get("actions"),context:this.context});this.$inner.append(t.render().$el),this.$actions=t.$el}}}),r=t.View.extend({tagName:"ul",className:"nav pull-right",views:{},context:null,initialize:function(t){this.collection=t.collection,this.context=t.context,this.listenTo(this.collection,"add",this.addItem),this.listenTo(this.collection,"remove",this.removeItem),this.listenTo(this.collection,"reset",this.render)},render:function(){return this.$el.empty(),this.collection.each(this.addItem,this),this},addItem:function(t){var e=new d({model:t,context:this.context});this.$el.append(e.render().el),this.views[t.cid]=e},removeItem:function(t){this.views[t.cid]&&(this.views[t.cid].$el.remove(),delete this.views[t.cid])}}),d=t.View.extend({tagName:"li",template:"<a></a>",context:null,events:{click:"handleClick"},initialize:function(t){this.context=t.context,this.listenTo(this.model,"change",this.render)},handleClick:function(t){t.preventDefault(),this.model.get("disabled")||this.model.get("action")&&this.model.get("action").call(this.context)},render:function(){this.$el.html(this.template);var e=t.$("a",this.$el);return e.append(t.$('<i class="icon-'+this.model.get("icon")+'"></i>')),e.append(this.model.get("label")),this.model.get("disabled")?this.$el.addClass("disabled"):this.$el.removeClass("disabled"),this}});window.ActionBar=n,window.ContextBar=a})(Backbone),function(){var t=Backbone.Model.extend({$:function(t){return this.$el.find(t)},initialize:function(){this.el=document.createElement("div"),this.el.className="dataflow",this.$el=$(this.el);var t=$('<div class="dataflow-menu">'),e=this;if($('<button class="dataflow-menu-close icon-remove"></button>').click(function(){e.hideMenu()}).appendTo(t),this.$el.append(t),this.debug=this.get("debug"),this.controls=this.get("controls"),this.controls!==!1&&(this.controls=!0),this.controls){this.prepareActionBar(),this.renderActionBar();for(var o in this.plugins)this.plugins[o].initialize&&this.plugins[o].initialize(this)}this.inputs=this.get("inputs"),this.inputs!==!1&&(this.inputs=!0),this.editable=this.get("editable"),this.editable!==!1&&(this.editable=!0);var i=this.get("appendTo");i=i?i:"body","body"===i&&$("html, body").css({margin:"0px",padding:"0px",width:"100%",height:"100%"}),$(i).append(this.el),this.id||(this.id=$(i).attr("id")),this.loadState()},prepareActionBar:function(){this.actionBar=new ActionBar({},this),this.actionBar.get("control").set({label:"Dataflow",icon:"retweet"}),this.contextBar=new ContextBar({},this),this.contextBar.get("control").set({label:"1 selected",icon:"ok",action:function(){this.currentGraph&&this.currentGraph.view&&this.currentGraph.view.deselect()}})},renderActionBar:function(){this.$el.append(this.actionBar.render()),this.$(".brand").attr({href:"https://github.com/meemoo/dataflow",target:"_blank"}),this.$el.append(this.contextBar.render()),this.contextBar.view.$el.hide()},modules:{},module:function(t){return this.modules[t]?this.modules[t]:(this.modules[t]={},this.modules[t])},nodes:{},node:function(t){return this.nodes[t]?this.nodes[t]:(this.nodes[t]={},this.nodes[t])},plugins:{},plugin:function(t){return this.plugins[t]?this.plugins[t]:(this.plugins[t]={},this.plugins[t])},hideMenu:function(){this.$el.removeClass("menu-shown")},showMenu:function(t){this.$el.addClass("menu-shown"),this.$(".dataflow-menuitem").removeClass("shown"),this.$(".dataflow-menuitem-"+t).addClass("shown")},addPlugin:function(t){if(t.menu){var e=$("<div>").addClass("dataflow-menuitem dataflow-menuitem-"+t.id).append(t.menu);this.$(".dataflow-menu").append(e),this.actionBar.get("actions").add({id:t.id,icon:t.icon,label:t.name,action:function(){this.showMenu(t.id)}})}},showContextBar:function(){this.actionBar.view.$el.hide(),this.contextBar.view.$el.show()},hideContextBar:function(){this.contextBar.view.$el.hide(),this.actionBar.view.$el.show()},contexts:{},addContext:function(t){for(var e=0;t.contexts.length>e;e++){var o=t.contexts[e];this.contexts[o]||(this.contexts[o]=[]),this.contexts[o].push(t)}},changeContext:function(t){return this.contextBar?(t.length>1?(this.contextBar.get("control").set({label:t.length+" selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.twoplus),this.showContextBar()):1===t.length?(this.contextBar.get("control").set({label:"1 selected"}),this.contextBar.get("actions").reset(),this.contextBar.get("actions").add(this.contexts.one),this.showContextBar()):this.hideContextBar(),void 0):!1},loadGraph:function(t){this.graph&&(this.currentGraph.view&&this.currentGraph.view.remove(),this.graph.view&&this.graph.view.remove(),this.graph.remove());var e=this.module("graph");t.dataflow=this;var o=new e.Model(t);return o.view=new e.View({model:o}),this.$el.append(o.view.render().el),this.graph=this.currentGraph=o,o},showGraph:function(t){this.currentGraph.view.$el.detach(),this.$el.append(t.view.el),t.view.render(),this.currentGraph=t},debug:!1,log:function(t){this.trigger("log",t,arguments),this.debug&&console.log("Dataflow: ",arguments)},types:["all","canvas:2d","canvas:webgl","string","number","int","object","array"]});window.Dataflow=t,"object"==typeof exports&&(exports.Dataflow=t),Backbone.View.prototype.addEvents=function(t){this.delegateEvents(_.extend(_.clone(this.events),t))},Backbone.CollectionView=Backbone.Model.extend({initialize:function(t){this.el=document.createElement(this.tagName),this.$el=$(this.el),this.parent=t.parent;var e=this.get("collection");e.each(this.addItem,this),e.on("add",this.addItem,this),e.on("remove",this.removeItem,this)},addItem:function(t){t.view=new this.itemView({model:t,parent:this.parent}),this.$el.append(t.view.render().el)},removeItem:function(t){t.view.remove()}})}(),function(t){var e=Backbone.Model.extend({});t.prototype.loadState=function(){var t="dataflow-"+(this.id?this.id:this.cid),o=JSON.parse(window.localStorage.getItem(t));o||(o={});var i=new e(o);this.set("state",i),i.on("change",function(e){window.localStorage.setItem(t,JSON.stringify(e.toJSON()))})}}(Dataflow),function(t){var e=t.prototype.module("graph"),o=t.prototype.module("node"),i=t.prototype.module("edge");e.Model=Backbone.Model.extend({defaults:{nodes:[],edges:[]},initialize:function(){this.dataflow=this.get("dataflow");var t,e=this.nodes=new o.Collection;e.parentGraph=this,e.on("all",function(){this.trigger("change")},this),e.on("add",function(t){this.dataflow.trigger("node:add",this,t)},this),e.on("remove",function(t){t.remove(),this.dataflow.trigger("node:remove",this,t)},this);var n=this.get("nodes");for(t=0;n.length>t;t++){var a=n[t];a.parentGraph=this,a.type&&this.dataflow.nodes[a.type]?(a=new this.dataflow.nodes[a.type].Model(a),e.add(a)):this.dataflow.log("node "+a.id+" not added: node type ("+a.type+") not found",a)}var s=this.edges=new i.Collection;s.parentGraph=this,s.on("all",function(){this.trigger("change")},this),s.on("add",function(t){this.dataflow.trigger("edge:add",this,t)},this),s.on("remove",function(t){this.dataflow.trigger("edge:remove",this,t)},this);var l=this.get("edges");for(t=0;l.length>t;t++){var r=l[t];r.parentGraph=this,r.id=r.source.node+":"+r.source.port+"::"+r.target.node+":"+r.target.port;var d=e.get(r.source.node),h=e.get(r.target.node);d&&h&&d.outputs.get(r.source.port)&&h.inputs.get(r.target.port)?(r=new i.Model(r),s.add(r)):this.dataflow.log("edge "+r.id+" not added: node or port not found",r)}this.set({nodes:e,edges:s}),this.on("selectionChanged",this.selectionChanged,this),this.on("select:node",this.selectNode,this),this.on("select:edge",this.selectEdge,this),this.on("change",function(){this.dataflow.trigger("change",this)},this)},selectNode:function(t){this.dataflow.trigger("select:node",this,t)},selectEdge:function(t){this.dataflow.trigger("select:edge",this,t)},selectionChanged:function(){this.selected=[],this.view&&(this.nodes.each(function(t){t.view&&t.view.$el.hasClass("ui-selected")&&this.selected.push(t)},this),this.dataflow.changeContext(this.selected))},remove:function(){for(;this.nodes.length>0;)this.nodes.remove(this.nodes.at(this.nodes.length-1))},toJSON:function(){return{nodes:this.nodes,edges:this.edges}}})}(Dataflow),function(t){var e=t.prototype.module("node"),o=t.prototype.module("input"),i=t.prototype.module("output");e.Model=Backbone.Model.extend({defaults:{label:"",type:"test",x:200,y:100,state:{}},initialize:function(){this.parentGraph=this.get("parentGraph"),this.type=this.get("type"),""===this.get("label")&&this.set({label:this.get("type")});var t=this.inputs;this.inputs=new o.Collection,this.inputs.parentNode=this;for(var e=0;t.length>e;e++){var n=t[e],a=this.get("state");void 0!==n.value&&void 0===a[n.id]&&(a[n.id]=n.value),n.parentNode=this,n=new o.Model(n),this.inputs.add(n)}var s=this.outputs;for(this.outputs=new i.Collection,this.outputs.parentNode=this,e=0;s.length>e;e++){var l=s[e];l.parentNode=this,l=new i.Model(l),this.outputs.add(l)}this.on("select",this.select,this)},select:function(){this.parentGraph.trigger("select:node",this)},setState:function(t,e){var o=this.get("state");o[t]!==e&&(o[t]=e,this["input"+t]&&this["input"+t](e),this.trigger("change:state",t,e))},setBang:function(t){this["input"+t]&&this["input"+t]()},send:function(t,e){var o=this;_.defer(function(){o.trigger("send:"+t,e)})},recieve:function(t,e){"function"==typeof this["input"+t]?this["input"+t](e):this["_"+t]=e},remove:function(){this.inputs.each(function(t){t.remove()}),this.outputs.each(function(t){t.remove()}),this.unload(),this.collection.remove(this)},unload:function(){},toString:function(){return this.id+" ("+this.type+")"},toJSON:function(){return{id:this.get("id"),label:this.get("label"),type:this.get("type"),x:this.get("x"),y:this.get("y"),state:this.get("state")}},inputs:[],outputs:[]}),e.Collection=Backbone.Collection.extend({model:e.Model,comparator:function(t){return t.get("x")}})}(Dataflow),function(t){var e=t.prototype.module("input");e.Model=Backbone.Model.extend({defaults:{id:"input",label:"",type:"all",description:""},initialize:function(){this.parentNode=this.get("parentNode"),""===this.get("label")&&this.set({label:this.id}),this.connected=[]},connect:function(t){this.connected.push(t),this.connected=_.uniq(this.connected)},disconnect:function(t){this.connected=_.without(this.connected,t)},remove:function(){for(;this.connected.length>0;)this.connected[0].remove()}}),e.Collection=Backbone.Collection.extend({model:e.Model})}(Dataflow),function(t){var e=t.prototype.module("input"),o=t.prototype.module("output");o.Model=e.Model.extend({defaults:{id:"output",label:"",type:"all",description:""}}),o.Collection=Backbone.Collection.extend({model:o.Model})}(Dataflow),function(t){var e=t.prototype.module("edge");e.Model=Backbone.Model.extend({defaults:{z:0,route:0},initialize:function(){var t,e,o,i=this.get("preview");if(this.parentGraph=this.get("parentGraph"),i){t=this.get("parentGraph").nodes;var n=this.get("source"),a=this.get("target");n?(e=t.get(this.get("source").node),this.source=e.outputs.get(this.get("source").port)):a&&(o=t.get(this.get("target").node),this.target=o.inputs.get(this.get("target").port))}else{t=this.parentGraph.nodes;try{e=t.get(this.get("source").node),this.source=e.outputs.get(this.get("source").port),o=t.get(this.get("target").node),this.target=o.inputs.get(this.get("target").port)}catch(s){}this.source.connect(this),this.target.connect(this),e.on("send:"+this.source.id,this.send,this),this.bringToTop(),this.on("select",this.select,this)}},select:function(){this.parentGraph.trigger("select:edge",this)},send:function(t){this.target.parentNode.recieve(this.target.id,t)},isConnectedToPort:function(t){return this.source===t||this.target===t},isConnectedToNode:function(t){return this.source.parentNode===t||this.target.parentNode===t},toString:function(){return this.get("source").node+":"+this.get("source").port+"::"+this.get("target").node+":"+this.get("target").port},toJSON:function(){return{source:this.get("source"),target:this.get("target"),route:this.get("route")}},bringToTop:function(){var t=0;this.parentGraph.edges.each(function(e){if(e!==this){var o=e.get("z");o>t&&(t=o),e.view&&e.view.unhighlight()}},this),this.set("z",t+1),this.collection&&this.collection.sort()},remove:function(){this.source.disconnect(this),this.target.disconnect(this),this.collection&&this.collection.remove(this),this.source.parentNode.off("send:"+this.source.id,this.send,this)}}),e.Collection=Backbone.Collection.extend({model:e.Model,comparator:function(t){return t.get("z")}})}(Dataflow),function(t){var e=t.prototype.module("card");e.Model=Backbone.Model.extend({}),e.Collection=Backbone.Collection.extend({model:e.Model})}(Dataflow),function(t){var e=t.prototype.module("graph");t.prototype.module("node");var o=t.prototype.module("edge"),i='<div class="dataflow-edges"><svg class="dataflow-svg-edges" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="800" height="800"></svg></div><div class="dataflow-nodes" /><div class="dataflow-graph-controls"><button class="dataflow-graph-gotoparent"><i class="icon-chevron-left"></i> back to parent</button></div>';e.View=Backbone.View.extend({template:_.template(i),className:"dataflow-graph",events:{click:"deselect","click .dataflow-graph-gotoparent":"gotoParent",dragstart:"dragStart",drag:"drag",dragstop:"dragStop"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var t=this.model.get("nodes"),e=this.model.get("edges");this.nodes=t.view={},this.model.nodes.each(this.addNode,this),this.model.nodes.on("add",this.addNode,this),this.model.nodes.on("remove",this.removeNode,this),this.edges=e.view={},this.model.edges.each(this.addEdge,this),this.model.edges.on("add",this.addEdge,this),this.model.edges.on("remove",this.removeEdge,this);var o=this.model.get("parentNode");o||this.$(".dataflow-graph-controls").hide(),this.$el.draggable({helper:function(){var t=$("<div>");return this.model.dataflow.$el.append(t),t}.bind(this)}),this.bindInteraction()},dragStart:function(){},drag:function(t,e){e&&this.$el.css({transform:"translate3d("+e.offset.left+"px, "+e.offset.top+"px, 0)"})},dragStop:function(t,e){this.$el.css({transform:"translate3d(0, 0, 0)"}),this.model.nodes.each(function(t){t.view.moveToPosition(t.get("x")+e.offset.left,t.get("y")+e.offset.top)})},gotoParent:function(){var t=this.model.get("parentNode");t&&this.model.dataflow.showGraph(t.parentGraph)},bindInteraction:function(){var t=this.model.dataflow.get("state");this.bindZoom(t),this.bindScroll(t)},bindZoom:function(t){if(window.Hammer){t.has("zoom")||t.set("zoom",1);var e,o=this;Hammer(this.el).on("touch",function(o){e=t.get("zoom"),t.set("centerX",o.gesture.center.pageX),t.set("centerY",o.gesture.center.pageY)}),Hammer(this.el).on("pinch",function(o){var i=Math.max(.5,Math.min(e*o.gesture.scale,3)),n=t.get("centerX"),a=t.get("centerY"),s=n-n/i,l=a-a/i;t.set("zoom",i),t.set("scrollY",l),t.set("scrollX",s)});var i=function(){o.el.style.zoom=t.get("zoom"),o.el.scrollTop=t.get("scrollY"),o.el.scrollLeft=t.get("scrollX")};t.on("change:zoom",i),1!==t.get("zoom")&&i()}},bindScroll:function(t){this.el.addEventListener("scroll",function(){t.set("scrollY",this.scrollTop),t.set("scrollX",this.scrollLeft)})},render:function(){var t=this;return _.defer(function(){t.rerenderEdges()},this),this},addNode:function(t){var e=this.model.dataflow.nodes[t.type];if(e&&e.View)t.view=new e.View({model:t,graph:this});else{var o=this.model.dataflow.node("base");t.view=new o.View({model:t,graph:this})}this.nodes[t.id]=t.view,t.view.render(),this.$(".dataflow-nodes").append(t.view.el)},removeNode:function(t){t.view.remove(),this.nodes[t.id]=null,delete this.nodes[t.id]},addEdge:function(t){t.view=new o.View({model:t}),this.edges[t.id]=t.view,t.view.render(),this.$(".dataflow-svg-edges")[0].appendChild(t.view.el)},removeEdge:function(t){t.view.remove(),this.edges[t.id]=null,delete this.edges[t.id]},rerenderEdges:function(){_.each(this.edges,function(t){t.render()},this)},sizeSVG:function(){try{var t=this.$(".dataflow-svg-edges")[0],e=t.getBBox();t.setAttribute("width",Math.round(e.x+e.width+50)),t.setAttribute("height",Math.round(e.y+e.height+50))}catch(o){}},deselect:function(){this.$(".dataflow-node").removeClass("ui-selected"),this.model.trigger("selectionChanged"),this.unfade()},fade:function(){this.model.nodes.each(function(t){t.view.$el.hasClass("ui-selected")||t.view.fade()}),this.model.edges.each(function(t){t.view.fade()})},unfade:function(){this.model.nodes.each(function(t){t.view.unfade()}),this.model.edges.each(function(t){t.view.unfade()})}})}(Dataflow),function(t){var e=t.prototype.module("node"),o=t.prototype.module("input"),i=t.prototype.module("output"),n='<div class="outer" /><div class="dataflow-node-header"><h1 class="dataflow-node-title"><span class="label"><%- label %></span> <input class="label-edit" value="<%- label %>" type="text" /></h1><button title="properties" class="dataflow-node-inspect icon-cog"></button></div><div class="dataflow-node-ports dataflow-node-ins" /><div class="dataflow-node-ports dataflow-node-outs" /><div class="dataflow-node-inner" />',a='<h1 class="dataflow-node-inspector-title"><%- label %></h1><div class="dataflow-node-inspector-inputs"></div>',s="";e.View=Backbone.View.extend({template:_.template(n),innerTemplate:_.template(s),inspectTemplate:_.template(a),className:"dataflow-node",events:function(){return{"click .dataflow-node-inspect":"showInspector","click .dataflow-node-header":"select",dragstart:"dragStart",drag:"drag",dragstop:"dragStop"}},initialize:function(t){this.$el.html(this.template(this.model.toJSON())),this.graph=t.graph,this.$el.addClass(this.model.type),this.model.parentGraph.dataflow.editable||this.$(".dataflow-node-edit").hide(),this.inputs=this.model.inputs.view=new o.CollectionView({collection:this.model.inputs,parent:this}),this.outputs=this.model.outputs.view=new i.CollectionView({collection:this.model.outputs,parent:this});var e=this;this.$el.draggable({handle:"h1",helper:function(){var t=e.$el,o=t.width(),i=t.height();return $('<div class="dataflow-node helper" style="width:'+o+"px; height:"+i+'px">')}}),this.$el.data("dataflow-node-view",this),this.$(".dataflow-node-inner").append(this.innerTemplate),this.$inner=this.$(".dataflow-node-inner")},render:function(){return this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$(".dataflow-node-ins").html(this.inputs.el),this.$(".dataflow-node-outs").html(this.outputs.el),this.$(".dataflow-node-controls").hide(),this.$(".label-edit").hide(),this},_alsoDrag:[],_dragDelta:{},dragStart:function(t){this.$el.hasClass("ui-selected")||this.select(t,!0),t.stopPropagation();var e=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(e.el!==this){var t=$(this),o={left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)};t.data("ui-draggable-alsodrag-initial",o);var i=$('<div class="node helper">').css({width:t.width(),height:t.height(),left:o.left,top:o.top});t.parent().append(i),t.data("ui-draggable-alsodrag-helper",i),e._alsoDrag.push(t)}})},drag:function(t){if(t.stopPropagation(),this._alsoDrag.length){var e=$(t.target).data("ui-draggable"),o=e.originalPosition,i={top:e.position.top-o.top||0,left:e.position.left-o.left||0};_.each(this._alsoDrag,function(t){var e=t.data("ui-draggable-alsodrag-initial"),o=t.data("ui-draggable-alsodrag-helper");o.css({left:e.left+i.left,top:e.top+i.top})})}},dragStop:function(t,e){t.stopPropagation();var o=parseInt(e.position.left,10),i=parseInt(e.position.top,10);this.moveToPosition(o,i),this._alsoDrag.length&&(_.each(this._alsoDrag,function(t){t.data("ui-draggable-alsodrag-initial");var e=t.data("ui-draggable-alsodrag-helper"),o=t.data("dataflow-node-view");o.moveToPosition(parseInt(e.css("left"),10),parseInt(e.css("top"),10)),e.remove(),t.data("ui-draggable-alsodrag-initial",null),t.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[])},moveToPosition:function(t,e){this.$el.css({left:t,top:e}),this.model.set({x:t,y:e})},showInspector:function(){this.model.parentGraph.dataflow.showMenu("inspector");var t=this.model.parentGraph.dataflow.$(".dataflow-plugin-inspector");t.children().detach(),t.append(this.getInputList()),this.highlightEdges()},highlightEdges:function(){},hideControls:function(){},saveLabel:function(){var t=this.$(".title .label-edit").val();this.model.get("label")!==t&&(this.model.set("label",t),this.$(".title .label").text(t)),this.hideControls()},removeModel:function(){this.model.remove()},bringToTop:function(){var t=0;this.model.collection.each(function(e){var o=parseInt(e.view.el.style.zIndex,10);o>t&&(t=o)},this),this.el.style.zIndex=t+1},select:function(t,e){t.stopPropagation(),e&&this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$el.addClass("ui-selected"),this.bringToTop(),this.model.parentGraph.view.fade(),this.unfade(),this.model.trigger("select"),this.model.parentGraph.trigger("selectionChanged")},fade:function(){this.$el.addClass("fade")},unfade:function(){this.$el.removeClass("fade");var t=this;this.model.parentGraph.edges.each(function(e){(e.source.parentNode.id===t.model.id||e.target.parentNode.id===t.model.id)&&e.view.unfade()})},$inputList:null,getInputList:function(){if(!this.$inputList){this.$inputList=$("<div>");var t=this.model.toJSON();this.$inputList.html(this.inspectTemplate(t)),t.id!==t.label&&this.$inputList.children(".dataflow-node-inspector-title").prepend(t.id+": ");var e=this.$inputList.children(".dataflow-node-inspector-inputs");this.model.inputs.each(function(t){t.view&&t.view.$input&&e.append(t.view.$input)},this)}return this.$inputList}})}(Dataflow),function(t){var e=t.prototype.module("input"),o=t.prototype.module("edge"),i='<span class="dataflow-port-plug in" title="drag to edit wire"></span><span class="dataflow-port-hole in" title="drag to make new wire"></span><label class="dataflow-port-label in" title="<%= description %>"><%= label %></label>';e.View=Backbone.View.extend({template:_.template(i),tagName:"li",className:"dataflow-port dataflow-in",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},$input:null,initialize:function(t){if(this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.model.parentNode.parentGraph.dataflow.editable){var e=this;if(this.parent=t.parent,this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var t=$('<span class="dataflow-port-plug in helper" />');return $(".dataflow-graph").append(t),t},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var t=$('<span class="dataflow-port-plug out helper" />').data({port:e.model});return $(".dataflow-graph").append(t),t}}),this.$el.droppable({accept:".dataflow-port-plug.in, .dataflow-port-hole.out",activeClassType:"droppable-hover",refreshPositions:!0}),this.model.parentNode.parentGraph.dataflow.inputs){var o=this.model.get("type"),i=this.model.parentNode.get("state");if(t=this.model.get("options"),void 0!==t&&(_.isString(t)&&(t=t.split(" "),this.model.set("options",t)),_.isArray(t))){for(var n={},a=0;t.length>a;a++)n[t[a]]=t[a];t=n,this.model.set("options",t)}var s,l=this.renderInput(o,t);i&&void 0!==i[this.model.id]?s=i[this.model.id]:void 0!==this.model.get("value")&&(s=this.model.get("value")),this.setInputValue(l,o,s),this.model.parentNode.on("change:state",function(){var t=this.model.parentNode.get("state");t&&void 0!==t[this.model.id]&&this.setInputValue(l,o,t[this.model.id])}.bind(this));var r=$("<label>").append(l).prepend("<span>"+this.model.get("label")+"</span> ");this.$input=r}}},renderInput:function(t,e){var o;if(e){o=$('<select class="input input-select">');for(var i in e){var n=$('<option value="'+e[i]+'">'+i+"</option>").data("val",e[i]);o.append(n)}return o.change(this.inputSelect.bind(this)),o}switch(t){case"int":case"float":case"number":var a={};return void 0!==this.model.get("min")&&(a.min=this.model.get("min")),void 0!==this.model.get("max")&&(a.max=this.model.get("max")),"int"===t&&(a.step=1),o=$('<input type="number" class="input input-number">').attr(a).addClass("int"===t?"input-int":"input-float"),"int"==t?o.change(this.inputInt.bind(this)):o.change(this.inputFloat.bind(this)),o;case"boolean":return o=$('<input type="checkbox" class="input input-boolean">'),o.change(this.inputBoolean.bind(this)),o;case"bang":return o=$('<button class="input input-bang">!</button>'),o.click(this.inputBang.bind(this)),o;default:return o=$('<input class="input input-string">'),o.change(this.inputString.bind(this)),o}},setInputValue:function(t,e,o){return t?"SELECT"===t[0].tagName?($("option",t).each(function(){var t=$(this).data("val");$(this).prop("selected",t==o)}),void 0):"boolean"===e?(t.prop("checked",o),void 0):(t.val(o),void 0):void 0},inputSelect:function(t){var e=$(t.target).find(":selected").data("val");this.model.parentNode.setState(this.model.id,e)},inputInt:function(t){this.model.parentNode.setState(this.model.id,parseInt($(t.target).val(),10))},inputFloat:function(t){this.model.parentNode.setState(this.model.id,parseFloat($(t.target).val()))},inputString:function(t){this.model.parentNode.setState(this.model.id,$(t.target).val())},inputBoolean:function(t){this.model.parentNode.setState(this.model.id,$(t.target).prop("checked"))},inputBang:function(){this.model.parentNode.setBang(this.model.id)},render:function(){return this},newEdgeStart:function(t,e){if(t.stopPropagation(),e){e.helper.data({route:this.topRoute}),this.previewEdgeNew=new o.Model({target:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeNewView=new o.View({model:this.previewEdgeNew});var i=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];i.appendChild(this.previewEdgeNewView.el)}},newEdgeDrag:function(t,e){if(t.stopPropagation(),this.previewEdgeNewView&&e){var o=this.model.parentNode.parentGraph.dataflow.get("state");e.position.top=t.clientY/o.get("zoom"),e.position.left=t.clientX/o.get("zoom");var i=this.model.parentNode.parentGraph.view.el;e.position.left+=i.scrollLeft,e.position.top+=i.scrollTop,this.previewEdgeNewView.render({left:e.position.left-i.scrollLeft,top:e.position.top-i.scrollTop}),this.model.parentNode.parentGraph.view.sizeSVG()}},newEdgeStop:function(t){t.stopPropagation(),this.previewEdgeNewView.remove(),delete this.previewEdgeNew,delete this.previewEdgeNewView},getTopEdge:function(){var t;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(e){e.target===this.model&&(t=e),e.view&&e.view.unhighlight()},this),t&&t.view&&t.view.click()),t},changeEdgeStart:function(t,e){if(t.stopPropagation(),this.isConnected){var i=this.getTopEdge();if(i){i.remove(),e&&e.helper.data({port:i.source,route:i.get("route")}),this.previewEdgeChange=new o.Model({source:i.get("source"),route:i.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new o.View({model:this.previewEdgeChange});var n=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];n.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(t,e){t.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(e.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(t){t.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.remove(),delete this.previewEdgeChange,delete this.previewEdgeChangeView)
},connectEdge:function(t,e){var o=e.helper.data("port"),i=this.model.parentNode.parentGraph.edges.length;if(o.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var n=0;void 0!==e.helper.data("route")&&(n=e.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:o.parentNode.id+":"+o.id+"::"+this.model.parentNode.id+":"+this.model.id,parentGraph:this.model.parentNode.parentGraph,source:{node:o.parentNode.id,port:o.id},target:{node:this.model.parentNode.id,port:this.model.id},route:n}),e.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>i)},holePosition:function(){var t=this.$(".dataflow-port-hole").offset();this.parent||(this.parent=this.options.parent);var e=this.parent.graph.$el,o=e.offset();return{left:e.scrollLeft()+t.left-o.left+5,top:e.scrollTop()+t.top-o.top+8}},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(t){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var t=this.model.parentNode.parentGraph.edges.some(function(t){return t.target===this.model},this);if(!t){try{this.$(".dataflow-port-plug").draggable("disable")}catch(e){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(t){var e=t.get("route");void 0!==e&&(this.$(".dataflow-port-hole").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole").addClass("route"+e),this.topRoute=e)}}),e.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:e.View})}(Dataflow),function(t){var e=t.prototype.module("output"),o=t.prototype.module("edge"),i='<span class="dataflow-port-label out" title="<%= description %>"><%= label %></span><span class="dataflow-port-hole out" title="drag to make new wire"></span><span class="dataflow-port-plug out" title="drag to edit wire"></span>';e.View=Backbone.View.extend({template:_.template(i),tagName:"li",className:"dataflow-port dataflow-out",events:{click:"getTopEdge",drop:"connectEdge","dragstart .dataflow-port-hole":"newEdgeStart","drag      .dataflow-port-hole":"newEdgeDrag","dragstop  .dataflow-port-hole":"newEdgeStop","dragstart .dataflow-port-plug":"changeEdgeStart","drag      .dataflow-port-plug":"changeEdgeDrag","dragstop  .dataflow-port-plug":"changeEdgeStop"},initialize:function(t){if(this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.model.get("type")),this.model.parentNode.parentGraph.dataflow.editable){var e=this;this.parent=t.parent,this.$(".dataflow-port-plug").draggable({cursor:"pointer",helper:function(){var t=$('<span class="dataflow-port-plug out helper" />');return $(".dataflow-graph").append(t),t},disabled:!0,distance:10,delay:100}),this.$(".dataflow-port-hole").draggable({cursor:"pointer",helper:function(){var t=$('<span class="dataflow-port-plug in helper" />').data({port:e.model});return $(".dataflow-graph").append(t),t}}),this.$el.droppable({accept:".dataflow-port-plug.out, .dataflow-port-hole.in",activeClassType:"droppable-hover"})}},render:function(){return this},newEdgeStart:function(t,e){if(t.stopPropagation(),e){e.helper.data({route:this.topRoute}),this.previewEdge=new o.Model({source:{node:this.model.parentNode.id,port:this.model.id},parentGraph:this.model.parentNode.parentGraph,preview:!0,route:this.topRoute}),this.previewEdgeView=new o.View({model:this.previewEdge});var i=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];i.appendChild(this.previewEdgeView.el)}},newEdgeDrag:function(t,e){if(t.stopPropagation(),this.previewEdgeView&&e){var o=this.model.parentNode.parentGraph.dataflow.get("state");e.position.top=t.clientY/o.get("zoom"),e.position.left=t.clientX/o.get("zoom");var i=this.model.parentNode.parentGraph.view.el;e.position.left+=i.scrollLeft,e.position.top+=i.scrollTop,this.previewEdgeView.render({left:e.position.left-i.scrollLeft,top:e.position.top-i.scrollTop})}},newEdgeStop:function(t){t.stopPropagation(),this.previewEdgeView.remove(),delete this.previewEdge,delete this.previewEdgeView},getTopEdge:function(){var t;return this.isConnected&&(this.model.parentNode.parentGraph.edges.each(function(e){e.source===this.model&&(t=e),e.view&&e.view.unhighlight()},this),t&&t.view&&t.view.click()),t},changeEdgeStart:function(t,e){if(t.stopPropagation(),this.isConnected){var i=this.getTopEdge();if(i){i.remove(),e&&e.helper.data({port:i.target,route:i.get("route")}),this.previewEdgeChange=new o.Model({target:i.get("target"),route:i.get("route"),parentGraph:this.model.parentNode.parentGraph,preview:!0}),this.previewEdgeChangeView=new o.View({model:this.previewEdgeChange});var n=this.model.parentNode.parentGraph.view.$(".dataflow-svg-edges")[0];n.appendChild(this.previewEdgeChangeView.el)}}},changeEdgeDrag:function(t,e){t.stopPropagation(),this.previewEdgeChange&&(this.previewEdgeChangeView.render(e.offset),this.model.parentNode.parentGraph.view.sizeSVG())},changeEdgeStop:function(t){t.stopPropagation(),this.previewEdgeChange&&this.previewEdgeChangeView.remove()},connectEdge:function(t,e){var o=e.helper.data("port"),i=this.model.parentNode.parentGraph.edges.length;if(o.parentNode.parentGraph.dataflow!==this.model.parentNode.parentGraph.dataflow)return!1;var n=0;void 0!==e.helper.data("route")&&(n=e.helper.data("route")),this.model.parentNode.parentGraph.edges.add({id:this.model.parentNode.id+":"+this.model.id+"::"+o.parentNode.id+":"+o.id,parentGraph:this.model.parentNode.parentGraph,source:{node:this.model.parentNode.id,port:this.model.id},target:{node:o.parentNode.id,port:o.id},route:n}),e.helper.data("removeChangeEdge",this.model.parentNode.parentGraph.edges.length>i)},holePosition:function(){var t=this.$(".dataflow-port-hole").offset();this.parent||(this.parent=this.options.parent);var e=this.parent.graph.$el,o=e.offset();return{left:e.scrollLeft()+t.left-o.left+5,top:e.scrollTop()+t.top-o.top+8}},isConnected:!1,plugSetActive:function(){try{this.$(".dataflow-port-plug").draggable("enable")}catch(t){}this.$(".dataflow-port-plug, .dataflow-port-hole").addClass("active"),this.isConnected=!0},plugCheckActive:function(){var t=this.model.parentNode.parentGraph.edges.some(function(t){return t.source===this.model},this);if(!t){try{this.$(".dataflow-port-plug").draggable("disable")}catch(e){}this.$(".dataflow-port-plug, .dataflow-port-hole").removeClass("active"),this.isConnected=!1}},topRoute:0,bringToTop:function(t){var e=t.get("route");void 0!==e&&(this.$(".dataflow-port-hole").removeClass("route"+this.topRoute),this.$(".dataflow-port-hole").addClass("route"+e),this.topRoute=e)}}),e.CollectionView=Backbone.CollectionView.extend({tagName:"ul",itemView:e.View})}(Dataflow),function(t){var e=t.prototype.module("edge"),o=function(t,e){var o=document.createElementNS("http://www.w3.org/2000/svg",t);for(var i in e)"xlink:href"===i?o.setAttributeNS("http://www.w3.org/1999/xlink","href",e[i]):o.setAttribute(i,e[i]);return o},i='<h1 class="dataflow-edge-inspector-title">Edge</h1><div class="dataflow-edge-inspector-route-choose"></div>';e.View=Backbone.View.extend({tagName:"div",className:"dataflow-edge",positions:null,inspectTemplate:_.template(i),initialize:function(){this.positions={from:null,to:null},this.model.source&&this.model.source.parentNode.on("change:x change:y change:w",this.render,this),this.model.target&&this.model.target.parentNode.on("change:x change:y",this.render,this),this.model.source&&this.model.source.view&&(this.model.source.view.plugSetActive(),this.model.source.view.bringToTop(this.model)),this.model.target&&this.model.target.view&&(this.model.target.view.plugSetActive(),this.model.target.view.bringToTop(this.model)),this.el=o("g",{"class":"dataflow-edge"}),this.elEdge=o("path",{"class":"dataflow-edge-wire"}),this.elShadow=o("path",{"class":"dataflow-edge-shadow"}),void 0!==this.model.get("route")&&this.elEdge.setAttribute("class","dataflow-edge-wire route"+this.model.get("route"));var t=this;this.model.on("change:route",function(){t.elEdge.setAttribute("class","dataflow-edge-wire route"+t.model.get("route")),t.bringToTop()}),this.el.appendChild(this.elShadow),this.el.appendChild(this.elEdge),this.el.addEventListener("click",function(e){t.click(e)})},render:function(t){var e,o=this.model.source,i=this.model.target;o?this.positions.from=o.view.holePosition():(e=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.from={left:graph.scrollLeft()+t.left-5-e.left,top:graph.scrollTop()+t.top+5-e.top}),i?this.positions.to=i.view.holePosition():(e=this.model.parentGraph.dataflow.$el.parent().position(),graph=this.model.parentGraph.view.$el,this.positions.to={left:graph.scrollLeft()+t.left+15-e.left,top:graph.scrollTop()+t.top+5-e.top}),this.positions.from.left=Math.floor(this.positions.from.left),this.positions.from.top=Math.floor(this.positions.from.top),this.positions.to.left=Math.floor(this.positions.to.left),this.positions.to.top=Math.floor(this.positions.to.top);var n=this.edgePath(this.positions);this.elEdge.setAttribute("d",n),this.elShadow.setAttribute("d",n),this.model.parentGraph&&this.model.parentGraph.view&&this.model.parentGraph.view.sizeSVG()},fade:function(){this.el.setAttribute("class","dataflow-edge fade")},unfade:function(){this.el.setAttribute("class","dataflow-edge")},highlight:function(){this.el.setAttribute("class","dataflow-edge highlight")},unhighlight:function(){this.el.setAttribute("class","dataflow-edge")},edgePath:function(t){var e=20,o=t.to.left-e-(t.from.left+e),i=Math.floor(o/2),n=o-i,a=t.to.top-t.from.top,s=Math.floor(a/2),l=a-s,r="",d="";return Math.abs(a)>Math.abs(o)?a>0?o>0?(r=" L "+(t.from.left+e+i)+" "+(t.from.top+i),d=" L "+(t.to.left-e-n)+" "+(t.to.top-n)):0>o&&(r=" L "+(t.from.left+e+i)+" "+(t.from.top-i),d=" L "+(t.to.left-e-n)+" "+(t.to.top+n)):0>a&&(o>0?(r=" L "+(t.from.left+e+i)+" "+(t.from.top-i),d=" L "+(t.to.left-e-n)+" "+(t.to.top+n)):0>o&&(r=" L "+(t.from.left+e+i)+" "+(t.from.top+i),d=" L "+(t.to.left-e-n)+" "+(t.to.top-n))):Math.abs(a)<Math.abs(o)&&(o>0?a>0?(r=" L "+(t.from.left+e+s)+" "+(t.from.top+s),d=" L "+(t.to.left-e-l)+" "+(t.to.top-l)):0>a&&(r=" L "+(t.from.left+e-s)+" "+(t.from.top+s),d=" L "+(t.to.left-e+l)+" "+(t.to.top-l)):0>o&&(a>0?(r=" L "+(t.from.left+e-s)+" "+(t.from.top+s),d=" L "+(t.to.left-e+l)+" "+(t.to.top-l)):0>a&&(r=" L "+(t.from.left+e+s)+" "+(t.from.top+s),d=" L "+(t.to.left-e-l)+" "+(t.to.top-l)))),"M "+t.from.left+" "+t.from.top+" L "+(t.from.left+e)+" "+t.from.top+r+d+" L "+(t.to.left-e)+" "+t.to.top+" L "+t.to.left+" "+t.to.top},remove:function(){var t=this.model.source,e=this.model.target;t&&t.parentNode.off(null,null,this),e&&e.parentNode.off(null,null,this),t&&t.view.plugCheckActive(),e&&e.view.plugCheckActive(),this.el.parentNode.removeChild(this.el)},click:function(t){t&&t.stopPropagation(),this.highlight(),this.bringToTop(),this.model.trigger("select")},bringToTop:function(){this.model.bringToTop();var t=this.el.parentNode;t&&t.appendChild(this.el),this.model.source.view.bringToTop(this.model),this.model.target.view.bringToTop(this.model)},$inspect:null,getInspect:function(){if(!this.$inspect){this.$inspect=$("<div>");var t=this.model.toJSON();this.$inspect.html(this.inspectTemplate(t));for(var e=this.$inspect.children(".dataflow-edge-inspector-route-choose"),o=this,i=function(t){o.model.set("route",$(t.target).data("route"))},n=0;12>n;n++){var a=$("<button>").data("route",n).addClass("route"+n).click(i);e.append(a)}}return this.$inspect}})}(Dataflow),function(t){var e=t.prototype.module("card");e.View=Backbone.View.extend({tagName:"div",initialize:function(){}}),e.CollectionView=Backbone.CollectionView.extend({tagName:"div",itemView:e.View})}(Dataflow),function(t){var e=t.prototype.plugin("edit");e.initialize=function(t){function e(){t.currentGraph.view.$(".node").addClass("ui-selected")}function o(){i(),_.each(s.nodes,function(t){t.x-=50,t.y-=50});var e=t.currentGraph.nodes.filter(function(t){return t.view.$el.hasClass("ui-selected")});_.each(e,function(t){t.remove()})}function i(){s={},s.nodes=[],t.currentGraph.nodes.each(function(t){t.view.$el.hasClass("ui-selected")&&s.nodes.push(JSON.parse(JSON.stringify(t)))}),s.edges=[],t.currentGraph.edges.each(function(t){var e=_.any(s.nodes,function(e){return t.source.parentNode.id===e.id}),o=_.any(s.nodes,function(e){return t.target.parentNode.id===e.id});e&&o&&s.edges.push(JSON.parse(JSON.stringify(t)))})}function n(){s&&s.nodes.length>0&&(t.currentGraph.view.$(".node").removeClass("ui-selected"),_.each(s.nodes,function(e){e.x+=50,e.y+=50,e.parentGraph=t.currentGraph;for(var o=e.id;t.currentGraph.nodes.get(e.id);)e.id++;o!==e.id&&_.each(s.edges,function(t){t.source.node===o&&(t.source.node=e.id),t.target.node===o&&(t.target.node=e.id)});var i=new t.nodes[e.type].Model(e);t.currentGraph.nodes.add(i),i.view.select()}),_.each(s.edges,function(e){e=JSON.parse(JSON.stringify(e)),e.parentGraph=t.currentGraph,e.id=e.source.node+":"+e.source.port+"::"+e.target.node+":"+e.target.port;var o=new t.modules.edge.Model(e);t.currentGraph.edges.add(o)})),_.defer(function(){t.currentGraph.view.rerenderEdges()})}var a=$('<div class="dataflow-plugin-edit"><button class="selectall">Select All (A)</button><br /><button class="cut">Cut (X)</button><br /><button class="copy">Copy (C)</button><br /><button class="paste">Paste (V)</button><br /></div>');a.children(".selectall").click(e),a.children(".cut").click(o);var s={};a.children(".copy").click(i),a.children(".paste").click(n),t.addContext({id:"cut",icon:"cut",label:"cut",action:o,contexts:["one","twoplus"]}),t.addContext({id:"copy",icon:"copy",label:"copy",action:i,contexts:["one","twoplus"]}),t.addContext({id:"paste",icon:"paste",label:"paste",action:n,contexts:["one","twoplus"]})}}(Dataflow),function(t){var e=t.prototype.plugin("elements");e.list=[{type:"div",attributes:["id","class","style"],events:["pointermove","pointerover","pointerout"]},{type:"button",attributes:["id","class","style"],events:["pointerdown","pointerup"]}]}(Dataflow),function(t){var e=t.prototype.plugin("library");e.initialize=function(t){var o=$('<ul class="dataflow-plugin-library" style="list-style:none; padding-left:0" />'),i=function(e,o,i){return function(){t.currentGraph.view.$(".node").removeClass("ui-selected");for(var n=1;t.currentGraph.nodes.get(n);)n++;o=void 0===o?200:o,i=void 0===i?200:i,o+=t.currentGraph.view.$el.scrollLeft(),i+=t.currentGraph.view.$el.scrollTop(),o=Math.max(o,0),i=Math.max(i,0);var a=new e.Model({id:n,x:o,y:i,parentGraph:t.currentGraph});t.currentGraph.nodes.add(a),a.view.select()}},n=function(e,n){var a=$('<a class="button">+</a>').attr("title","click or drag").draggable({helper:function(){var e=$('<div class="node helper" style="width:100px; height:100px">'+n+"</div>");return t.$el.append(e),e},stop:function(t,o){i(e,o.position.left,o.position.top).call()}}).click(i(e)),s=$("<li />").append(a).append(n);o.append(s)},a=function(e){e=e?e:{},e.exclude=e.exclude?e.exclude:["base","base-resizable"],o.empty(),_.each(t.nodes,function(t,o){-1===e.exclude.indexOf(o)&&n(t,o)})};a(),t.addPlugin({id:"library",name:"",menu:o,icon:"plus"}),e.update=a}}(Dataflow),function(t){var e=t.prototype.plugin("source");e.initialize=function(t){var o=$('<form class="dataflow-plugin-view-source"><div style="position: absolute; top:5px; left:5px; bottom:35px; right:5px;"><textarea class="code" style="width:100%; height:100%; margin:0; padding: 0;"></textarea><br/></div><input class="apply" type="submit" value="apply changes" style="position: absolute; right:5px; bottom:5px;" /></form>'),i=o.find(".code");t.addPlugin({id:"source",name:"",menu:o,icon:"globe"});var n=function(t){var e=i.prop("scrollTop");i.val(t),i.scrollTop(e)};e.show=n;var a=function(){t.graph&&n(JSON.stringify(t.graph.toJSON(),null,"  "))};e.listeners=function(e){e?t.on("change",a):t.off("change",a)},e.listeners(!0),o.submit(function(){var e;try{e=JSON.parse(i.val())}catch(o){return t.log("Invalid JSON"),!1}if(e){var n=t.loadGraph(e);n.trigger("change")}return!1})}}(Dataflow),function(t){var e=t.prototype.plugin("log");e.initialize=function(t){function o(t){t=_.escape(t),i.children(".loglist").append("<li>"+t+"</li>"),i.scrollTop(i.prop("scrollHeight"))}var i=$('<div class="dataflow-plugin-log" style="position: absolute; top:5px; left:5px; bottom:5px; right:5px; overflow:auto;"><ol class="loglist"></ol></div>');t.addPlugin({id:"log",name:"",menu:i,icon:"cog"}),e.add=o,e.listeners=function(e){e?(t.on("log",function(t){o("log: "+t)}),t.on("node:add",function(t,e){o("node added: "+(""+e))}),t.on("node:remove",function(t,e){o("node removed: "+(""+e))}),t.on("edge:add",function(t,e){o("edge added: "+(""+e))}),t.on("edge:remove",function(t,e){o("edge removed: "+(""+e))})):(t.off("log"),t.off("node:add"),t.off("node:remove"),t.off("edge:add"),t.off("edge:remove"))},e.listeners(!0)}}(Dataflow),function(t){var e=t.prototype.plugin("inspector");e.initialize=function(t){function o(){d&&d.view&&(l.children().detach(),l.append(d.view.getInputList()),d.view.highlightEdges())}function i(){t.showMenu("inspector"),o()}function n(t,e){d!==e&&(d=e,r.is(":visible")&&o())}function a(t){l.children().detach(),l.append(t.view.getInspect())}function s(t,e){d!==e&&(d=e,r.is(":visible")&&a(e))}var l=$('<div class="dataflow-plugin-inspector"></div>'),r=$("<div>").addClass("dataflow-menuitem dataflow-menuitem-inspector").append(l);t.$(".dataflow-menu").append(r);var d=null;t.addContext({id:"inspector",icon:"info-sign",label:"inspect",action:i,contexts:["one","twoplus"]}),e.listeners=function(e){e?(t.on("select:node",n),t.on("select:edge",s)):(t.off("select:node",n),t.off("select:edge",s))},e.listeners(!0)}}(Dataflow),function(t){var e=t.prototype.module("node"),o=t.prototype.node("base");o.Model=e.Model.extend({defaults:function(){return{label:"",type:"base",x:200,y:100,state:{}}},initialize:function(){e.Model.prototype.initialize.call(this)},unload:function(){},inputs:[],outputs:[]}),o.View=e.View.extend({})}(Dataflow);